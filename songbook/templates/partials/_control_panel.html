{% load static %}
{% load user_extras %}

<div class="content-section">
    {% if user.is_authenticated %}
        <!-- ðŸ”’ Privacy Status & Actions (Leaders/Owner only) -->
        {% if user == score.contributor or user.is_superuser %}
        <div class="alert {% if song.is_public %}alert-success{% else %}alert-warning{% endif %} mb-3">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                <div>
                    {% if song.is_public %}
                        <strong><i class="bi bi-globe2 me-2"></i>
                            {% if site_name == "FrancoUke" %}
                                Cette chanson est publique
                            {% else %}
                                This song is public
                            {% endif %}
                        </strong>
                        <p class="mb-0 small">
                            {% if site_name == "FrancoUke" %}
                                Visible par tous les utilisateurs
                            {% else %}
                                Visible to all users
                            {% endif %}
                        </p>
                    {% else %}
                        <strong><i class="bi bi-lock-fill me-2"></i>
                            {% if site_name == "FrancoUke" %}
                                Cette chanson est privÃ©e
                            {% else %}
                                This song is private
                            {% endif %}
                        </strong>
                        <p class="mb-0 small">
                            {% if site_name == "FrancoUke" %}
                                Visible seulement par vous
                            {% else %}
                                Only visible to you
                            {% endif %}
                        </p>
                    {% endif %}
                    
                    {# Show if cloned #}
                    {% if song.cloned_from %}
                        <div class="mt-2">
                            <span class="badge bg-info">
                                <i class="bi bi-files me-1"></i>
                                {% if site_name == "FrancoUke" %}
                                    Version personnalisÃ©e
                                {% else %}
                                    Personalized Version
                                {% endif %}
                            </span>
                            <small class="text-muted ms-2">
                                {% if site_name == "FrancoUke" %}
                                    BasÃ©e sur: 
                                {% else %}
                                    Based on: 
                                {% endif %}
                                <a href="{% url 'songbook:score_view' song.cloned_from.id %}">
                                    {{ song.cloned_from.songTitle }}
                                </a>
                            </small>
                        </div>
                    {% endif %}
                </div>
                
                {# Privacy toggle buttons - Leaders only #}
                {% if user.groups.all|length > 0 and 'Leaders' in user.groups.all|join:',' %}
                <div class="btn-group-vertical btn-group-sm" role="group">
                    {% if song.is_public %}
                        <a href="{% url 'songbook:make_private' song.id %}?next={{ request.path }}" 
                           class="btn btn-warning btn-sm"
                           onclick="return confirm('{% if site_name == 'FrancoUke' %}Rendre cette chanson privÃ©e?{% else %}Make this song private?{% endif %}');">
                            <i class="bi bi-lock me-1"></i>
                            {% if site_name == "FrancoUke" %}Rendre privÃ©e{% else %}Make Private{% endif %}
                        </a>
                    {% else %}
                        <a href="{% url 'songbook:make_public' song.id %}?next={{ request.path }}" 
                           class="btn btn-success btn-sm"
                           onclick="return confirm('{% if site_name == 'FrancoUke' %}Rendre cette chanson publique?{% else %}Make this song public?{% endif %}');">
                            <i class="bi bi-unlock me-1"></i>
                            {% if site_name == "FrancoUke" %}Rendre publique{% else %}Make Public{% endif %}
                        </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- ðŸŽ¼ Song Editor Section -->
        {% if site_name == "FrancoUke" %}
            <h3>Ã‰diteur de partition</h3>
        {% else %}
            <h3>Song Editor</h3>
        {% endif %}

        <div class="d-flex gap-2 flex-wrap">
            {% if user == score.contributor or user.is_superuser %}
                {# Owner/Admin: Show edit and delete buttons #}
                <p class="text-muted small mb-2 w-100">
                    {% if site_name == "FrancoUke" %}
                        Modifier le contenu de la chanson sans modifier l'apparence
                    {% else %}
                        Edit the song's content without changing appearance
                    {% endif %}
                </p>
                <a class="btn btn-secondary btn-sm" 
                   href="{% url site_namespace|add:':song_update' pk=song.pk %}" 
                   title="{% if site_name == 'FrancoUke' %}Modifier le fichier Chordpro{% else %}Edit the original ChordPro file{% endif %}">
                    <i class="bi bi-pencil me-1"></i>
                    {% if site_name == "FrancoUke" %}
                        Modifier ChordPro
                    {% else %}
                        Edit ChordPro
                    {% endif %}
                </a>
                
                <a class="btn btn-danger btn-sm" 
                   href="{% url site_namespace|add:':song_delete' pk=song.pk %}"
                   onclick="return confirm('{% if site_name == 'FrancoUke' %}ÃŠtes-vous sÃ»r de vouloir supprimer cette chanson?{% else %}Are you sure you want to delete this song?{% endif %}');">
                    <i class="bi bi-trash me-1"></i>
                    {% if site_name == "FrancoUke" %}
                        Supprimer
                    {% else %}
                        Delete
                    {% endif %}
                </a>
            {% else %}
                {# ðŸ†• Non-owner authenticated user: Show clone button for public songs #}
                {% if song.is_public %}
                    <div class="alert alert-info mb-0 w-100">
                        <p class="mb-2 small">
                            <i class="bi bi-info-circle me-2"></i>
                            {% if site_name == "FrancoUke" %}
                                <strong>Vous aimez cette chanson?</strong> CrÃ©ez votre propre version modifiable!
                            {% else %}
                                <strong>Like this song?</strong> Create your own editable version!
                            {% endif %}
                        </p>
                        <form method="post" action="{% url 'songbook:clone_song' song.id %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-info btn-sm">
                                <i class="bi bi-files me-1"></i>
                                {% if site_name == "FrancoUke" %}
                                    Personnaliser cette chanson
                                {% else %}
                                    Personalize This Song
                                {% endif %}
                            </button>
                        </form>
                    </div>
                {% else %}
                    <p class="text-muted small">
                        {% if site_name == "FrancoUke" %}
                            Vous ne pouvez modifier que vos propres chansons.
                        {% else %}
                            You can only edit songs you contributed.
                        {% endif %}
                    </p>
                {% endif %}
            {% endif %}
        </div>
    {% else %}
        <!-- Not authenticated - show clone button for public songs -->
        {% if song.is_public %}
        <div class="alert alert-info mb-3">
            <p class="mb-2">
                <i class="bi bi-info-circle me-2"></i>
                {% if site_name == "FrancoUke" %}
                    <strong>Astuce:</strong> CrÃ©ez votre propre version modifiable de cette chanson!
                {% else %}
                    <strong>Tip:</strong> Create your own editable version of this song!
                {% endif %}
            </p>
            <form method="post" action="{% url 'songbook:clone_song' song.id %}" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-info btn-sm">
                    <i class="bi bi-files me-1"></i>
                    {% if site_name == "FrancoUke" %}
                        Personnaliser cette chanson
                    {% else %}
                        Personalize This Song
                    {% endif %}
                </button>
            </form>
        </div>
        {% endif %}
        
        <p class="text-muted small">
            {% if site_name == "FrancoUke" %}
                Connectez-vous pour modifier vos chansons.
            {% else %}
                Log in to edit your songs.
            {% endif %}
        </p>
    {% endif %}

    <hr>

    <!-- ðŸŽ¸ Transposition Section -->
    {% if site_name == "FrancoUke" %}
        <h3>ðŸŽ¸ Transposer les accords</h3>
        <p class="text-muted">Changer la tonalitÃ© de la chanson pour mieux s'adapter Ã  votre voix ou pour un meilleur choix d'accord</p>
    {% else %}
        <h3>ðŸŽ¸ Transpose Chords</h3>
        <p class="text-muted">Change the key of the song to adapt to your voice or to use different chords</p>
    {% endif %}
    
    <label for="transpose-select">
        {% if site_name == "FrancoUke" %}Transpose:{% else %}Transpose:{% endif %}
    </label>
    <select id="transpose-select" class="form-control w-auto d-inline-block">
        <option value="0">
            {% if site_name == "FrancoUke" %}TonalitÃ© originale{% else %}Original Key{% endif %}
        </option>
        <option value="-7">-7 {% if site_name == "FrancoUke" %}demi-tons{% else %}semitones{% endif %}</option>
        <option value="-6">-6 {% if site_name == "FrancoUke" %}demi-tons{% else %}semitones{% endif %}</option>
        <option value="-5">-5 {% if site_name == "FrancoUke" %}demi-tons{% else %}semitones{% endif %}</option>
        <option value="-4">-4 {% if site_name == "FrancoUke" %}demi-tons{% else %}semitones{% endif %}</option>
        <option value="-3">-3 {% if site_name == "FrancoUke" %}demi-tons{% else %}semitones{% endif %}</option>
        <option value="-2">-2 {% if site_name == "FrancoUke" %}demi-tons{% else %}semitones{% endif %}</option>
        <option value="-1">-1 {% if site_name == "FrancoUke" %}demi-ton{% else %}semitone{% endif %}</option>
        <option value="1">+1 {% if site_name == "FrancoUke" %}demi-ton{% else %}semitone{% endif %}</option>
        <option value="2">+2 {% if site_name == "FrancoUke" %}demi-tons{% else %}semitones{% endif %}</option>
        <option value="3">+3 {% if site_name == "FrancoUke" %}demi-tons{% else %}semitones{% endif %}</option>
        <option value="4">+4 {% if site_name == "FrancoUke" %}demi-tons{% else %}semitones{% endif %}</option>
        <option value="5">+5 {% if site_name == "FrancoUke" %}demi-tons{% else %}semitones{% endif %}</option>
        <option value="6">+6 {% if site_name == "FrancoUke" %}demi-tons{% else %}semitones{% endif %}</option>
        <option value="7">+7 {% if site_name == "FrancoUke" %}demi-tons{% else %}semitones{% endif %}</option>
    </select>
    
    <button id="update-preview" class="btn btn-primary btn-sm mt-2">
        ðŸ”„ {% if site_name == "FrancoUke" %}Appliquer la Transposition{% else %}Apply Transposition{% endif %}
    </button>

    <hr>

    <!-- ðŸŽ¨ Song Formatting Section -->
    <h3>
        ðŸŽ¨ {% if site_name == "FrancoUke" %}
            Mise en Forme des Chansons
        {% else %}
            Song Formatting
        {% endif %}
    </h3>
    <p class="text-muted">
        {% if site_name == "FrancoUke" %}
            Ajustez la mise en forme via l'Ã‰diteur de Mise en Forme
        {% else %}
            Adjust formatting via the Song Formatting Editor
        {% endif %}
    </p>

    <div class="me-3">
        {% if user.is_authenticated %}
            {% with site_namespace|add:':edit_formatting' as edit_url_name %}
                {% if user.is_superuser or user|has_group:"Power Users" or user == score.contributor %}
                    <a href="{% url edit_url_name score.id %}" class="btn btn-warning btn-sm">
                        {% if site_name == "FrancoUke" %}
                            Modifier la mise en forme
                        {% else %}
                            Edit Song Formatting
                        {% endif %}
                    </a>
                {% else %}
                    <p class="text-muted small">
                        {% if site_name == "FrancoUke" %}
                            Veuillez envoyer un message Ã  gaulindm@gmail.com pour demander la permission Power User.
                        {% else %}
                            Please send an email to gaulindm@gmail.com to request Power User permission.
                        {% endif %}
                    </p>
                {% endif %}
            {% endwith %}
        {% else %}
            <p class="text-muted small">
                {% if site_name == "FrancoUke" %}
                    Connectez-vous pour modifier la mise en forme.
                {% else %}
                    Log in to edit formatting.
                {% endif %}
            </p>
        {% endif %}
    </div>

    <hr>

    <!-- ðŸŽ¥ YouTube Player Section -->
    {% if score.metadata.youtube %}
        <div>
            <p>
                {% if site_name == "FrancoUke" %}
                    Lien YouTube: 
                {% else %}
                    YouTube link:
                {% endif %}
                <a href="{{ score.metadata.youtube }}" target="_blank">
                    {% if site_name == "FrancoUke" %}
                        Visionner sur YouTube
                    {% else %}
                        Watch on YouTube
                    {% endif %}
                </a>
            </p>
        </div>
        <div id="youtube-player-container" style="margin-top: 20px; max-width: 320px; position: relative;"></div>
    {% else %}
        <p class="text-muted">
            {% if site_name == "FrancoUke" %}
                Pas de clip Youtube de la chanson.
            {% else %}
                No YouTube video available for this song.
            {% endif %}
        </p>
    {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    let youtubeUrl = "{{ score.metadata.youtube }}";

    function extractVideoId(url) {
        if (!url) return null;
        if (url.includes("youtu.be/")) return url.split("youtu.be/")[1]?.split("?")[0];
        if (url.includes("youtube.com/watch?v=")) return url.split("v=")[1]?.split("&")[0];
        if (url.includes("youtube.com/embed/")) return url.split("embed/")[1]?.split("?")[0];
        return null;
    }

    let videoId = extractVideoId(youtubeUrl);
    if (videoId) {
        let playerContainer = document.getElementById("youtube-player-container");
        if (playerContainer) {
            playerContainer.innerHTML = `
                <iframe width="320" height="180" 
                        src="https://www.youtube.com/embed/${videoId}" 
                        title="YouTube video player" frameborder="0" 
                        style="border-radius: 8px; box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen>
                </iframe>`;
        }
    }
});

document.addEventListener("DOMContentLoaded", function() {
    let updatePreviewBtn = document.getElementById("update-preview");
    let transposeSelect = document.getElementById("transpose-select");

    if (updatePreviewBtn && transposeSelect) {
        updatePreviewBtn.addEventListener("click", function() {
            let transposeValue = transposeSelect.value;
            let pdfIframe = document.getElementById("pdf-preview");
            if (pdfIframe) {
                let url = new URL(pdfIframe.src);
                url.searchParams.set("transpose", transposeValue);
                pdfIframe.src = url.toString();
            }
        });
    }
});
</script>