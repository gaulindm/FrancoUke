{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ song.title }}</title>
  <link rel="stylesheet" href="{% static 'songbook/css/teleprompter.css' %}">
  


  <!-- Diagram renderer -->
  <script src="{% static 'songbook/js/chord_diagrams.js' %}"></script>
  <!-- Teleprompter engine -->

</head>
<body>
  <!-- Controls -->
  <div class="controls">
    <div class="left">
      <span class="song-title">{{ song.title }}</span>
      <button id="toggle-chords">Hide Chords</button>
    </div>
    <div class="center">
      <button id="scroll-toggle">‚ñ∂Ô∏è Start</button>
      <div class="control-inline">
        <button id="speed-down">‚àí</button>
        <span id="speed-value">3</span>
        <button id="speed-up">+</button>
        <button id="save-speed" class="secondary">üíæ Save</button>
      </div>
    </div>
    <div class="right">
      <button id="scroll-reset">‚èπ Reset</button>
    </div>
  </div>

  <!-- Lyrics -->
  <div class="tp-main">
    <div class="lyrics-container">
      <div class="lyrics">
        <div class="metadata">
          <h1>{{ song.songTitle }}</h1>
          {% if metadata.songwriter %}
            <div class="songwriter">{{ metadata.songwriter }}</div>
          {% endif %}
          {% if metadata.artist %}
            <div class="recording">
              {{ metadata.artist }}{% if metadata.year %} ({{ metadata.year }}){% endif %}
            </div>
          {% endif %}
        </div>
        {{ lyrics_with_chords|safe }}
      </div>
    </div>
  </div>

<!-- ‚úÖ Embedded chords JSON for teleprompter.js -->
<script id="chords-data" type="application/json">
  {{ relevant_chords_json|safe }}
</script>

<!-- ‚úÖ Single, correct teleprompter config -->
<script id="teleprompter-config" type="application/json">
{
  "initialScrollSpeed": {{ initial_scroll_speed|default:40 }},
  "userPreferences": {{ user_preferences_json|safe }}
}
</script>

  


  <!-- Chord Section -->
  <div id="chord-section">
    <div id="chord-diagrams"></div>
  </div>

  <!-- Initialize SONG -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      window.SONG = {
        id: "{{ song.id }}",
        title: "{{ song.title|escapejs }}",
        initialTranspose: 0,
        chords: JSON.parse(document.getElementById("chords-data").textContent)
      };
      console.log("‚úÖ SONG loaded:", window.SONG);
    });
  </script>
    <script src="{% static 'songbook/js/teleprompter.js' %}"></script>
    </script>
    <script>
      // üé∏ iRig BlueTurn Support - Synced with auto-scroll
      document.addEventListener("DOMContentLoaded", () => {
        const lyricsContainer = document.querySelector(".lyrics-container");
        const scrollAmount = 150;
        
        const indicator = document.createElement("div");
        indicator.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0,0,0,0.8);
          color: white;
          padding: 20px 40px;
          border-radius: 10px;
          font-size: 24px;
          z-index: 9999;
          display: none;
          pointer-events: none;
        `;
        document.body.appendChild(indicator);
        
        function showIndicator(text) {
          indicator.textContent = text;
          indicator.style.display = "block";
          setTimeout(() => indicator.style.display = "none", 500);
        }
        
        document.addEventListener("keydown", (e) => {
          if (["ArrowLeft", "ArrowRight", "PageUp", "PageDown"].includes(e.key)) {
            e.preventDefault();
          }
    
          if (!lyricsContainer) return;
    
          switch(e.key) {
            case "ArrowLeft":
            case "PageUp":
              // Update both the DOM and internal scroll position
              if (typeof window.scrollPos !== 'undefined') {
                window.scrollPos = Math.max(0, window.scrollPos - scrollAmount);
                lyricsContainer.scrollTop = window.scrollPos;
              } else {
                lyricsContainer.scrollTop -= scrollAmount;
              }
              showIndicator("‚¨ÜÔ∏è");
              console.log("‚¨ÜÔ∏è BlueTurn: Scrolled up");
              break;
              
            case "ArrowRight":
            case "PageDown":
              // Update both the DOM and internal scroll position
              if (typeof window.scrollPos !== 'undefined') {
                const maxScroll = lyricsContainer.scrollHeight - lyricsContainer.clientHeight;
                window.scrollPos = Math.min(maxScroll, window.scrollPos + scrollAmount);
                lyricsContainer.scrollTop = window.scrollPos;
              } else {
                lyricsContainer.scrollTop += scrollAmount;
              }
              showIndicator("‚¨áÔ∏è");
              console.log("‚¨áÔ∏è BlueTurn: Scrolled down");
              break;
          }
        });
    
        console.log("üé∏ iRig BlueTurn enabled (synced with auto-scroll)");
      });
    </script>
  </body>
</html>