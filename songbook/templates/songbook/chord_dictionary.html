{% extends base_template %}
{% load static %}

{% block content %}
<div class="container py-4">
    <h1 class="mb-4 text-center">
        ðŸŽµ {% if site_name == "FrancoUke" %}Dictionnaire d'accords{% else %}Chord Dictionary{% endif %}
    </h1>

    <!-- ðŸŽ› Instrument Selector Form -->
    <form id="instrument-form" class="d-flex flex-wrap align-items-center justify-content-center mb-4">
        <label for="instrument-select" class="me-2 fw-bold">Instrument:</label>
        <select id="instrument-select" class="form-select w-auto me-3">
            <option value="ukulele">Ukulele</option>
            <option value="guitar">Guitar</option>
            <option value="banjo">Banjo</option>
            <option value="mandolin">Mandolin</option>
            <option value="baritoneUke">Baritone Ukulele</option>
        </select>

        <div class="form-check me-3">
            <input type="checkbox" class="form-check-input" id="is-lefty">
            <label for="is-lefty" class="form-check-label">Left-Handed</label>
        </div>

        <button type="submit" class="btn btn-success">
            {% if site_name == "FrancoUke" %}Afficher les accords{% else %}Show Chords{% endif %}
        </button>
    </form>

    <!-- ðŸŽ¼ Chord Tables -->
    <div id="chord-tables" class="table-responsive"></div>
</div>

<!-- âœ… Required JS Libraries -->
<script src="{% static 'js/raphael.min.js' %}"></script>
<script src="{% static 'js/raphael.chord.js' %}"></script>

<!-- âœ… Chord Rendering Script -->
<script>
    const PREFERRED_CHORD_ORDER = [
        "", "7", "m", "m7", "maj7", "dim", "aug", "sus2", "sus4", 
        "5", "6", "m6", "m9", "maj9", "11", "maj13"
    ];

    const CHORD_DEFINITIONS = {
        ukulele: "{% static 'js/ukulele_chords.json' %}",
        guitar: "{% static 'js/guitar_chords.json' %}",
        banjo: "{% static 'js/banjo_chords.json' %}",
        mandolin: "{% static 'js/mandolin_chords.json' %}",
        baritoneUke: "{% static 'js/baritone_uke_chords.json' %}"
    };

    // ðŸŽµ Fetch and Render Chords
    function fetchAndRenderChords(selectedInstrument, isLefty) {
        const container = document.getElementById("chord-tables");
        container.innerHTML = ""; // Clear previous content

        fetch(CHORD_DEFINITIONS[selectedInstrument])
            .then(response => response.json())
            .then(data => {
                const groupedChords = groupChordsByRootAndType(data);
                renderChordsTable(container, selectedInstrument, groupedChords, isLefty);
            })
            .catch(error => console.error(`Error loading ${selectedInstrument} chord data:`, error));
    }

    // Group chords by root and type
    function groupChordsByRootAndType(jsonData) {
        const groupedChords = {};
        jsonData.forEach(chord => {
            if (!chord.name) return;
            const match = chord.name.match(/([A-G]#?b?)(.*)/);
            if (!match) return;

            const [root, type = "maj"] = match.slice(1);
            if (!groupedChords[root]) groupedChords[root] = {};
            groupedChords[root][type] = chord.variations;
        });
        return groupedChords;
    }

    // Render chord table
    function renderChordsTable(container, instrument, chordData, isLefty) {
        const table = document.createElement("table");
        table.className = "table table-bordered text-center align-middle";

        const header = document.createElement("h3");
        header.className = "my-3 text-primary";
        header.textContent = `${instrument.charAt(0).toUpperCase() + instrument.slice(1)} Chords`;
        container.appendChild(header);

        // Table Header
        const headerRow = document.createElement("tr");
        headerRow.innerHTML = `<th>Chord Type</th>` + 
                              Object.keys(chordData).map(root => `<th>${root}</th>`).join("");
        table.appendChild(headerRow);

        // Loop through preferred chord order
        PREFERRED_CHORD_ORDER.forEach(type => {
            const row1 = document.createElement("tr");
            const row2 = document.createElement("tr");

            row1.innerHTML = `<td rowspan="2">${type || "maj"}</td>`;
            row2.innerHTML = "";

            Object.keys(chordData).forEach(root => {
                const variations = chordData[root][type] || [null, null];
                variations.forEach((variation, index) => {
                    const cell = document.createElement("td");
                    const diagramContainer = document.createElement("div");
                    diagramContainer.className = "diagram-container";

                    if (variation) {
                        const mirroredVariation = isLefty ? mirrorVariation(variation) : variation;
                        new Raphael.chord.Chord(diagramContainer, mirroredVariation, `${root} ${type || "maj"}`);
                    }

                    cell.appendChild(diagramContainer);
                    if (index === 0) row1.appendChild(cell);
                    if (index === 1) row2.appendChild(cell);
                });
            });

            table.appendChild(row1);
            table.appendChild(row2);
        });

        container.appendChild(table);
    }

    // Flip chord for left-handed players
    function mirrorVariation(variation) {
        return Array.isArray(variation) ? variation.slice().reverse() : variation;
    }

    // Handle form submission
    document.getElementById("instrument-form").addEventListener("submit", event => {
        event.preventDefault();
        const selectedInstrument = document.getElementById("instrument-select").value;
        const isLefty = document.getElementById("is-lefty").checked;
        fetchAndRenderChords(selectedInstrument, isLefty);
    });

    // Initial render (default: Ukulele, Right-Handed)
    fetchAndRenderChords("ukulele", false);
</script>

<style>
    .diagram-container {
        width: 80px;
        height: 100px;
        margin: 0 auto;
    }
</style>
{% endblock %}
