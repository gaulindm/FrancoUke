{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js"></script>

<script src="{% static 'js/raphael.adaptivechord.js' %}"></script>
<script src="{% static 'js/song_simplescore.js' %}"></script>

    <!-- Local Stylesheets -->
    {% if pdf_generation %}
        <link rel="stylesheet" href="file://{{ STATIC_ROOT }}/songbook/main.css">
        <link rel="stylesheet" href="file://{{ STATIC_ROOT }}/songbook/song_simplescore.css">
    {% else %}
        <link rel="stylesheet" type="text/css" href="{% static 'songbook/main.css' %}">
        <link rel="stylesheet" href="{% static 'songbook/song_simplescore.css' %}">
    {% endif %}

    
{% if title %}
<title>Songbook - {{ score.songtitle }} </title>
{% else %}
<title>Songbook </title>
{% endif%}

</head>
<body>
    <header class="site-header">
        {% include "partials/_navbar.html" %}
      </header>

      <button type="button" class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#printPreviewModal">
        Open Print Preview
    </button>

      <main role="main" class="container">
        <div class="row">
            <div class="col-8 bg-light">
                <!-- Page Area -->
                <div id="printableScore" style="background-color:#FFF; padding: 10px; border: 1px solid #ccc; border-radius: 5px; max-width: 800px; margin: 20px auto;">
                    <table id="song_header" table table-borderless style="width: 100%; margin: 0 auto; padding: 1;">
                        <tbody>
                            <tr style="height:fit-content;">
                                <td class="col-3">
                                    {% if score.metadata.timeSignature %}
                                        {{ score.metadata.timeSignature }}
                                    {% endif %}
                                </td>
                                <td class="col-6" style="text-align: center; font-weight: bolder;">{{ score.songTitle }}</td>
                                
                                <td class="col-3" style="text-align: right;">
                                    {% if score.metadata.1stnote %}
                                        First vocal note: {{ score.metadata.1stnote }}
                                    {% endif %}
                                </td>

                            </tr>
                            <tr>
                                <td class="col-sm-3">
                                    
                                    {% if score.metadata.tempo %}
                                        {{ score.metadata.tempo }} bpm
                                {% endif %}
                                    
                                    </td>
                                <td class="col-sm-6" style="text-align: center; font-weight: bolder;">{{ score.metadata.artist }}</td>
                                <td class="col-sm-3"></td>
                            </tr>
                            <tr>
                                <td colspan="3" style="text-align: center; " id="recording">D'apr√®s l'album {{ score.metadata.album }} en {{ score.metadata.key }} ({{ score.metadata.year }})</td>
                            </tr>
                        </tbody>
                    </table>
                
    
                <!-- Top Chord Placeholder -->
                <div id="top-chord-diagram-placeholder" class="col-12 d-none">
                
                </div>
    
                <!-- Lyrics and Chords Section -->
                <div id="lyrics-and-chords" class="row">
                    <!-- Left Chord Placeholder -->
                    <div id="left-chord-diagram-placeholder" class="col-2 d-none"></div>
    
                    <!-- Lyrics Container -->
                    <div class="col-10">
                        <div id="lyrics-container" class="lyrics-container">
                            <div id="song-content"></div>
                        </div>
                        
                    </div>
    
                    <!-- Right Chord Placeholder -->
                    <div id="right-chord-diagram-placeholder" class="col-2"></div>
                </div>
    
                <!-- Bottom Chord Placeholder -->
                <div id="bottom-chord-diagram-placeholder" class="col-12 d-none">
                    <!-- Chord Container -->
                    <div id="chord-container" class="d-none">
                        <div id="bottom-chord-container" class="chordbox">
                        <!-- Chords will be dynamically rendered here -->
                        </div>
                    </div>
                </div>


            </div>
            <!-- Print Button -->
        <button onclick="printDiv('printableScore')" style="display: block; margin: 20px auto;">Print Score</button>

        </div>
            
            <!-- Control Panel -->
            <div class="col-4">
                {% include "partials/_control_panel.html" %}
            </div>
        </div>
        
<!-- Modal for Print Preview -->
<div class="modal fade" id="printPreviewModal" tabindex="-1" aria-labelledby="printPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <h5 class="modal-title" id="printPreviewModalLabel">Print Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
    <!-- Content for the modal -->
    <div id="modal-print-content">
                <!-- Modal Song Header -->
                <div id="modal-song-header"></div>

                <!-- Top Chord Placeholder -->
                <div id="modal-top-chord-placeholder" class="chord-placeholder horizontal d-none"></div>

                <!-- Lyrics and Left/Right Chords -->
                <div class="row">
                    <!-- Left Chord Placeholder -->
                    <div id="modal-left-chord-placeholder" class="chord-placeholder vertical d-none col-2"></div>

                    <!-- Lyrics Container -->
                    <div class="col-8">
                        <div id="modal-lyrics-container"></div>
                    </div>

                    <!-- Right Chord Placeholder -->
                    <div id="modal-right-chord-placeholder" class="chord-placeholder vertical d-none col-2"></div>
                </div>

                <!-- Bottom Chord Placeholder -->
                <div id="modal-bottom-chord-placeholder" class="chord-placeholder horizontal d-none"></div>
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="printDiv('modal-print-content')">Print</button>
            </div>
        </div>
    </div>
</div>

    </main>
    

       <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
<!-- Layout Initialization -->




<script>
    const songDict = {{ score.lyrics_with_chords|safe }};
    const chordMap = {'C': 0, 'C#': 1, 'D': 2, 'D#': 3, 'E': 4, 'F': 5, 'F#': 6, 'G': 7, 'G#': 8, 'A': 9, 'A#': 10, 'B': 11};
    const reverseChordMap = {0: 'C', 1: 'C#', 2: 'D', 3: 'D#', 4: 'E', 5: 'F', 6: 'F#', 7: 'G', 8: 'G#', 9: 'A', 10: 'A#', 11: 'B'};
    const instrument = 'ukulele'; // Specify the instrument
    const uniqueChords = [...new Set(songDict.flatMap(section => section.map(item => item.chord).filter(Boolean)))]; // Extract unique chords

    document.getElementById('isLeftyToggle').addEventListener('change', (event) => {
    const isLefty = event.target.checked;
    console.log("Is lefty toggle switch changed:", isLefty);
    Raphael.chord.toggleLeftyMode(isLefty); // Update the global lefty state
    renderChords(); // Re-render chord diagrams
});



    document.addEventListener('DOMContentLoaded', () => {
        const instrumentSelector = document.getElementById('instrument-selector');
        const chordFiles = {
            guitar: "{% static 'js/guitar_chords.json' %}",
            ukulele: "{% static 'js/ukulele_chords.json' %}",
            baritone_ukulele: "{% static 'js/baritoneUke_chords.json' %}",
            banjo: "{% static 'js/banjo_chords.json' %}",
            mandoline: "{% static 'js/mandolin_chords.json' %}"
        };

        // Load the initial instrument's data
        loadInstrumentData(instrumentSelector.value);

        // Handle instrument changes
        instrumentSelector.addEventListener('change', (event) => {
            const selectedInstrument = event.target.value;
            loadInstrumentData(selectedInstrument);
        });

        function loadInstrumentData(instrument) {
            const filePath = chordFiles[instrument];
            if (!filePath) {
                console.error("Invalid instrument selected.");
                return;
            }

            Raphael.chord.setInstrument(instrument); // Update the instrument
            Raphael.chord.loadData(filePath)
                .then(() => {
                    console.log(`${instrument} chord data loaded.`);
                    renderChords();
                })
                .catch(error => console.error(`Error loading chord data for ${instrument}:`, error));
        }

    function renderChords() {
        const container = document.getElementById('bottom-chord-container');
        container.innerHTML = ''; // Clear existing chord diagrams

        uniqueChords.forEach((chordName) => {
        const chordData = Raphael.chord.find(chordName, 1);
        if (!chordData) {
            console.warn(`Chord ${chordName} not found for ${Raphael.chord.currentInstrument}`);
            return;
        }

        // Create a container for the chord diagram
        const diagramContainer = document.createElement('div');
        diagramContainer.className = 'chord-diagram';
        container.appendChild(diagramContainer); // Append before creating Raphael instance

        // Render the chord using Raphael
        const chord = new Raphael.chord.Chord(diagramContainer, chordData, chordName);

        // Size adjustments
        chord.element.setViewBox(0, 0, 100, 120); // Ensure viewport is correctly set
    });
}

    });


   





function updateStyle(styleName, value) {
    console.log(`updateStyle called with styleName: ${styleName}, value: ${value}`);

    // Ensure the parameters are not undefined
    if (!styleName || value === undefined) {
        console.error('Invalid parameters passed to updateStyle.');
        return;
    }

    const songContent = document.getElementById('song-content');
    if (!songContent) {
        console.error('song-content element not found.');
        return;
    }

    const chords = document.querySelectorAll('#song-content .chord');

    switch (styleName) {
        case 'lineHeight':
            songContent.style.lineHeight = value;
            break;
        case 'fontSize':
        case 'color':
            songContent.style[styleName] = value;
            break;
        case 'chordColor':
            chords.forEach(chord => chord.style.color = value);
            break;
        case 'chordWeight':
            chords.forEach(chord => chord.style.fontWeight = value);
            break;
        default:
            console.error(`Unsupported styleName: ${styleName}`);
            break;
    }
}





// Initial render

document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM fully loaded and parsed'); // Debugging: Check if DOMContentLoaded event is fired
    renderSong(songDict, 0);
    //renderChords();
    // Ensure the chord box is hidden by default
    const chordContainer = document.getElementById('chord-container');
    const toggleChordBox = document.getElementById('toggle-chord-box');
    chordContainer.classList.add('d-none');

    // Add default position logic
    updateChordPHPosition('bottom');

    if (toggleChordBox && chordContainer) {
        // Restore state from localStorage
        const savedState = localStorage.getItem('chordBoxVisible') === 'true';
        toggleChordBox.checked = savedState;

        if (savedState) {
            chordContainer.classList.remove('d-none');
            updateChordPHPosition('bottom');
        } else {
            chordContainer.classList.add('d-none');
        }

        // Save state on toggle change
        toggleChordBox.addEventListener('change', () => {
            const isVisible = toggleChordBox.checked;
            localStorage.setItem('chordBoxVisible', isVisible);
            isVisible ? chordContainer.classList.remove('d-none') : chordContainer.classList.add('d-none');
            if (isVisible) updateChordPHPosition('bottom');
        });
    } else {
        console.warn('Chord container or toggle not found.');
    }

});


// Event listener for the control panel
document.getElementById('layout-form').addEventListener('change', () => {
    const selectedPosition = document.querySelector('input[name="diagram-position"]:checked').value;
    updateChordPHPosition(selectedPosition);
});


</script>

</body>
</html>
