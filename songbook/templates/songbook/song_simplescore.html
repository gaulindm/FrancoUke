<!-- songbook/song_simplescore.html -->
{% extends base_template|default:"base.html" %}
{% load static %}

{% block content %}
    
    {# ðŸ†• Privacy Status & Actions Bar - Above everything #}
    <div class="container-fluid mb-3">
        <div class="alert {% if song.is_public %}alert-success{% else %}alert-warning{% endif %} d-flex justify-content-between align-items-center mb-0">
            <div>
                {% if song.is_public %}
                    <i class="bi bi-globe2 me-2"></i>
                    <strong>
                        {% if site_name == "FrancoUke" %}
                            Cette chanson est publique
                        {% else %}
                            This song is public
                        {% endif %}
                    </strong>
                    <small class="d-block text-muted">
                        {% if site_name == "FrancoUke" %}
                            Visible par tous les utilisateurs
                        {% else %}
                            Visible to all users
                        {% endif %}
                    </small>
                {% else %}
                    <i class="bi bi-lock-fill me-2"></i>
                    <strong>
                        {% if site_name == "FrancoUke" %}
                            Cette chanson est privÃ©e
                        {% else %}
                            This song is private
                        {% endif %}
                    </strong>
                    <small class="d-block text-muted">
                        {% if site_name == "FrancoUke" %}
                            Visible seulement par vous
                        {% else %}
                            Only visible to you
                        {% endif %}
                    </small>
                {% endif %}
                
                {# Show if cloned #}
                {% if song.cloned_from %}
                    <div class="mt-2">
                        <span class="badge bg-info">
                            <i class="bi bi-files me-1"></i>
                            {% if site_name == "FrancoUke" %}
                                Version personnalisÃ©e
                            {% else %}
                                Personalized Version
                            {% endif %}
                        </span>
                        <small class="text-muted ms-2">
                            {% if site_name == "FrancoUke" %}
                                BasÃ©e sur: 
                            {% else %}
                                Based on: 
                            {% endif %}
                            <a href="{% url 'songbook:score_view' song.cloned_from.id %}" class="text-decoration-underline">
                                {{ song.cloned_from.songTitle }}
                            </a>
                        </small>
                    </div>
                {% endif %}
            </div>
            
            {# ðŸ†• Action Buttons #}
            <div class="btn-group" role="group">
                {% if is_owner %}
                    {# Owner actions: Edit, Delete, Toggle Privacy #}
                    <a href="{% url 'songbook:song_update' song.id %}" 
                       class="btn btn-sm btn-primary">
                        <i class="bi bi-pencil me-1"></i>
                        {% if site_name == "FrancoUke" %}Modifier{% else %}Edit{% endif %}
                    </a>
                    
                    {% if song.is_public %}
                        <a href="{% url 'songbook:make_private' song.id %}?next={{ request.path }}" 
                           class="btn btn-sm btn-warning"
                           onclick="return confirm('{% if site_name == 'FrancoUke' %}Rendre cette chanson privÃ©e?{% else %}Make this song private?{% endif %}');">
                            <i class="bi bi-lock me-1"></i>
                            {% if site_name == "FrancoUke" %}Rendre privÃ©e{% else %}Make Private{% endif %}
                        </a>
                    {% else %}
                        <a href="{% url 'songbook:make_public' song.id %}?next={{ request.path }}" 
                           class="btn btn-sm btn-success"
                           onclick="return confirm('{% if site_name == 'FrancoUke' %}Rendre cette chanson publique?{% else %}Make this song public?{% endif %}');">
                            <i class="bi bi-unlock me-1"></i>
                            {% if site_name == "FrancoUke" %}Rendre publique{% else %}Make Public{% endif %}
                        </a>
                    {% endif %}
                    
                    <a href="{% url 'songbook:song_delete' song.id %}" 
                       class="btn btn-sm btn-danger"
                       onclick="return confirm('{% if site_name == 'FrancoUke' %}ÃŠtes-vous sÃ»r de vouloir supprimer cette chanson?{% else %}Are you sure you want to delete this song?{% endif %}');">
                        <i class="bi bi-trash me-1"></i>
                        {% if site_name == "FrancoUke" %}Supprimer{% else %}Delete{% endif %}
                    </a>
                {% else %}
                    {# ðŸ†• Non-owner: Clone button for public songs #}
                    {% if song.is_public %}
                        <form method="post" action="{% url 'songbook:clone_song' song.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-info">
                                <i class="bi bi-files me-1"></i>
                                {% if site_name == "FrancoUke" %}
                                    Personnaliser cette chanson
                                {% else %}
                                    Personalize This Song
                                {% endif %}
                            </button>
                        </form>
                    {% endif %}
                {% endif %}
            </div>
        </div>
        
        {# ðŸ†• Optional: Help text for clone feature #}
        {% if not is_owner and song.is_public %}
        <div class="alert alert-info alert-dismissible fade show mt-2 mb-0" role="alert">
            <i class="bi bi-info-circle me-2"></i>
            {% if site_name == "FrancoUke" %}
                <strong>Astuce:</strong> Cliquez sur "Personnaliser cette chanson" pour crÃ©er votre propre version modifiable. 
                La chanson originale restera inchangÃ©e.
            {% else %}
                <strong>Tip:</strong> Click "Personalize This Song" to create your own editable copy. 
                The original song will remain unchanged.
            {% endif %}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}
    </div>

    {# Original content - PDF preview and control panel #}
    <div class="row g-0">

        <!-- Print Preview -->
        <div class="col-md-8 col-12 p-2 bg-light d-flex justify-content-center align-items-center">
            <iframe id="pdf-preview"
                src="{% url site_namespace|add:':preview_pdf' score.id %}?transpose=0"
                width="100%"
                height="80%"
                style="border: none; min-height: 90vh;">
            </iframe>
        </div>

        <!-- Control Panel -->
        <div class="col-md-4 col-12 p-3 bg-white border-start">
            {% include "partials/_control_panel.html" %}
        </div>
    </div>

    <!-- Optional debug output (hidden by default) -->
    <pre id="iframe-debug" style="display:none; color:green; font-size:12px;"></pre>

    <script>
        const debugEl = document.getElementById("iframe-debug");
        const pdfEl = document.getElementById("pdf-preview");
        if (debugEl && pdfEl) {
            debugEl.innerText = pdfEl.src;
        }
        console.log("PDF preview iframe source:", pdfEl.src);
    </script>
{% endblock %}