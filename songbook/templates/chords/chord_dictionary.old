{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Chord Diagrams</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js"></script>
    <script src="{% static 'js/raphael.adaptivechord.js' %}"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin-top: 50px;
  
            margin: 20px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        /* shrink table cells to fit scaled diagrams */
td {
    padding: 6px;   /* less padding */
    width: 70px;    /* narrower columns */
    height: 100px;  /* reduce row height */
    vertical-align: top;
}

/* adjust header for balance */
th {
    padding: 8px;
}
        .diagram-container {
    transform: scale(0.8);          /* scale to 80% */
    transform-origin: top left;     /* keep alignment tidy */
    width: 80px;   /* original size, still needed for Raphael canvas */
    height: 125px;
}
    </style>
</head>
<body>
    <header class="site-header">
        {% include "partials/_navbar.html" %}
      </header>
      <br><br>

      
        {% if site_name == "FrancoUke" %}
            <h2>Les diagrammes d'accords</h2>
        {% else %}
            <h2>All Chord diagrams</h2>
        {% endif %}
    

    <form id="instrument-form">
        <label for="instrument-select">Choose an instrument:</label>
        <select id="instrument-select" name="instrument">
            <option value="ukulele" selected>Ukulele</option>
            <option value="guitalele">Guitalele</option>
            <option value="guitar">Guitar</option>
            <option value="banjo">Banjo</option>
            <option value="mandolin">Mandolin</option>
            <option value="baritoneUke">Baritone Ukulele</option>
        </select>
        <label>
            <input type="checkbox" id="is-lefty"> Left-Handed
        </label>
        <button type="submit">Update</button>
    </form>

    <div id="chord-tables"></div>


    <script>
        const PREFERRED_CHORD_ORDER = [
            "", "7", "m", "m7", "maj7", "dim", "aug", "sus2", "sus4",
            "5", "6", "m6", "m9", "maj9", "11", "maj13"
        ];
    
        const CHORD_DEFINITIONS = {
    ukulele: "/{{ site_name|lower }}/chords/ukulele.json",
    guitalele: "/{{ site_name|lower }}/chords/guitalele.json",
    guitar: "/{{ site_name|lower }}/chords/guitar.json",
    banjo: "/{{ site_name|lower }}/chords/banjo.json",
    mandolin: "/{{ site_name|lower }}/chords/mandolin.json",
    baritoneUke: "/{{ site_name|lower }}/chords/baritone_ukulele.json"
};

    
        async function loadChordData(path) {
            const resp = await fetch(path);
            const text = await resp.text();
            try {
                const parsed = JSON.parse(text);
                return Array.isArray(parsed) ? parsed : [];
            } catch {
                return text.split(/\r?\n/)
                    .map(l => l.trim())
                    .filter(l => l.length > 0)
                    .map(l => JSON.parse(l));
            }
        }
    
        function fetchAndRenderChords(selectedInstrument, isLefty) {
            const container = document.getElementById("chord-tables");
            container.innerHTML = "";
            const dataPath = CHORD_DEFINITIONS[selectedInstrument];
    
            loadChordData(dataPath)
                .then(data => {
                    const groupedChords = groupChordsByRootAndType(data);
                    renderChordsTable(container, selectedInstrument, groupedChords, isLefty);
                })
                .catch(error => console.error(`Error loading ${selectedInstrument} chord data:`, error));
        }
    
        function groupChordsByRootAndType(jsonData) {
            const groupedChords = {};
            jsonData.forEach(chord => {
                if (!chord.name) return;
                const match = chord.name.match(/([A-G]#?b?)(.*)/);
                if (!match) return;
                const [root, type = "maj"] = match.slice(1);
                if (!groupedChords[root]) groupedChords[root] = {};
                groupedChords[root][type] = chord.variations;
            });
            return groupedChords;
        }
    
        function renderChordsTable(container, instrument, chordData, isLefty) {
            const table = document.createElement("table");
            const header = document.createElement("h3");
            header.textContent = `${capitalize(instrument)} Chords`;
            container.appendChild(header);
    
            const headerRow = document.createElement("tr");
            headerRow.innerHTML = `<th>Chord Type</th>` +
                Object.keys(chordData).map(root => `<th>${root}</th>`).join("");
            table.appendChild(headerRow);
    
            PREFERRED_CHORD_ORDER.forEach(type => {
                const row1 = document.createElement("tr");
                const row2 = document.createElement("tr");
                row1.innerHTML = `<td rowspan="2">${type}</td>`;
    
                Object.keys(chordData).forEach(root => {
                    const variations = chordData[root][type] || [null, null];
    
                    variations.forEach((variation, index) => {
                        const cell = document.createElement("td");
                        const diagramContainer = document.createElement("div");
                        diagramContainer.className = "diagram-container";
    
                        if (variation) {
                            try {
                                const modernVariation = prepareVariation(variation, isLefty);
                                console.log("Rendering", root, type, modernVariation);

                                new Raphael.chord.Chord(diagramContainer, modernVariation, `${root} ${type}`);
                            } catch (error) {
                                console.warn(`Error rendering ${root} ${type} variation ${index + 1}:`, error);
                            }
                        }
    
                        cell.appendChild(diagramContainer);
                        if (index === 0) row1.appendChild(cell);
                        if (index === 1) row2.appendChild(cell);
                    });
                });
    
                table.appendChild(row1);
                table.appendChild(row2);
            });
    
            container.appendChild(table);
        }
    
        function prepareVariation(variation, isLefty) {
            let varObj;
            if (Array.isArray(variation)) {
                // Convert old array to object
                varObj = {
                    positions: variation.slice(),
                    baseFret: computeBaseFret(variation)
                };
            } else {
                varObj = { ...variation };
            }

            // Mirror positions/fingers for lefty
            if (isLefty) {
                varObj.positions = mirrorVariation(varObj.positions);
                if (varObj.fingers) varObj.fingers = mirrorVariation(varObj.fingers);
                if (varObj.barre) {
                    const temp = varObj.barre.fromString;
                    varObj.barre.fromString = varObj.positions.length - varObj.barre.toString + 1;
                    varObj.barre.toString = varObj.positions.length - temp + 1;
                }
            }

            console.log("Prepared variation:", varObj);
            return varObj;
        }

    
        function computeBaseFret(positions) {
            if (positions.some(f => f === 0)) return 1;
            const fretted = positions.filter(f => typeof f === "number" && f > 0);
            if (!fretted.length) return 1;
            const minFret = Math.min(...fretted);
            return minFret > 3 ? minFret : 1;
        }
    
        function mirrorVariation(variation) {
            return variation.slice().reverse();
        }
    
        function capitalize(s) {
            return s.charAt(0).toUpperCase() + s.slice(1);
        }
    
        document.getElementById("instrument-form").addEventListener("submit", event => {
            event.preventDefault();
            const selectedInstrument = document.getElementById("instrument-select").value;
            const isLefty = document.getElementById("is-lefty").checked;
            fetchAndRenderChords(selectedInstrument, isLefty);
        });
    
        fetchAndRenderChords("ukulele", false);
    </script>
        
    
    
    
</body>
</html>