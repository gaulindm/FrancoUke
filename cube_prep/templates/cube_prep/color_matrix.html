<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cube Mosaic Editor - Collaborative</title>

    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            max-width: 100%;
            overflow-x: hidden;
        }

        h1, h2, h3 {
            color: #333;
        }

        /* ===============================
           MOSAIC GALLERY
           =============================== */

        #mosaic-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }

        .mosaic-thumb {
            border: 2px solid #999;
            padding: 10px;
            cursor: pointer;
            background: #fafafa;
            text-align: center;
            border-radius: 8px;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .mosaic-thumb:hover {
            background: #fff;
            border-color: #2196F3;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transform: translateY(-2px);
        }

        .mosaic-canvas-container {
            display: flex;
            justify-content: center;
            align-items: center;
            background: #fff;
            border-radius: 4px;
            padding: 8px;
        }

        .mosaic-thumb canvas {
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .mosaic-info {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }

        .mosaic-name {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 4px;
            color: #333;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .mosaic-meta {
            font-size: 11px;
            color: #666;
            margin-top: 4px;
        }

        .mosaic-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .mosaic-actions button {
            padding: 4px 12px;
            font-size: 12px;
            background: #4CAF50;
            flex: 1;
            min-width: 70px;
        }

        .mosaic-actions button.view-btn {
            background: #2196F3;
        }

        .mosaic-actions button.duplicate-btn {
            background: #FF9800;
        }

        .mosaic-actions button.duplicate-btn:hover {
            background: #F57C00;
        }

        /* ===============================
           MODAL
           =============================== */

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            overflow: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fefefe;
            padding: 30px;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 32px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            line-height: 1;
        }

        .modal-close:hover {
            color: #000;
        }

        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .modal-header h2 {
            margin: 0;
            color: #2196F3;
        }


        .cube-position {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }


   /* ===============================
   SIMPLE VIEW CUBES MODAL
   =============================== */

.simple-cubes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 20px;
    padding: 20px;
    max-height: 70vh;
    overflow-y: auto;
}

.simple-cube-card {
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    transition: all 0.2s;
}

.simple-cube-card:hover {
    border-color: #2196F3;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.simple-cube-card canvas {
    margin: 0 auto 10px;
    display: block;
    border: 1px solid #ccc;
    border-radius: 4px;
}

.cube-card-number {
    font-weight: bold;
    color: #2196F3;
    margin-bottom: 4px;
    font-size: 14px;
}

.cube-card-position {
    color: #666;
    font-size: 12px;
}


        /* ===============================
           CONTROLS
           =============================== */

        .controls { 
            margin-bottom: 15px; 
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        label {
            font-weight: bold;
        }

        select, input[type="text"] {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        button {
            padding: 8px 16px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        button:hover {
            background: #0b7dda;
        }

        .size-indicator {
            font-size: 12px;
            color: #666;
        }

        /* ===============================
           MOSAIC GRID
           =============================== */

        #mosaic-container { 
            display: inline-flex; 
            flex-direction: column;
            margin: 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        #mosaic-wrapper {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .cube-row { 
            display: flex; 
        }

        .cube-div { 
            display: grid; 
            grid-gap: 1px;
            margin: 2px;
            border: 1px solid #666;
            position: relative;
        }

        .cube-div .cube-label {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            background: #2196F3;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            white-space: nowrap;
        }

        .cube-cell { 
            border: 1px solid #000; 
            cursor: pointer;
        }

        /* ===============================
           JSON OUTPUT
           =============================== */

        #mosaic-json { 
            white-space: pre; 
            background: #f0f0f0; 
            padding: 10px; 
            margin-top: 15px; 
            max-height: 300px; 
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }

        /* ===============================
           LOADING STATE
           =============================== */

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .empty-gallery {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }

/* ===============================
   PRINT STYLES
   =============================== */

   @media print {

body {
    padding: 0;
    margin: 0;
}

/* Hide everything except the mosaic */
h1, h2, h3,
.controls,
#mosaic-gallery,
#mosaic-json,
hr {
    display: none !important;
}

#mosaic-wrapper {
    display: block !important;
    margin: 0;
}

#mosaic-container {
    display: block !important;
    padding: 0;
    background: none;
    page-break-inside: auto;
}

.cube-row {
    display: flex;
    page-break-inside: avoid;
}

.cube-div {
    page-break-inside: avoid;
    break-inside: avoid;
}

}



    </style>
</head>

<body>

    <!-- ===============================
         MOSAIC GALLERY
         =============================== -->

    <h2>Saved Mosaics</h2>
    <div id="mosaic-gallery">
        <div class="loading">Loading mosaics...</div>
    </div>

    <hr>

    <!-- ===============================
         EDITOR
         =============================== -->

    <h1>Cube Mosaic Editor</h1>

    <div class="controls">
        <div class="control-group">
            <label>Color:</label>
            <select id="color-select">
                <option value="R">Red</option>
                <option value="B">Blue</option>
                <option value="Y">Yellow</option>
                <option value="G">Green</option>
                <option value="O">Orange</option>
                <option value="W">White</option>
            </select>
        </div>

        <div class="control-group">
            <label>Grid Size:</label>
            <select id="cubes-per-side">
                <optgroup label="üèÅ Drapeaux (Ratio 2:3)">
                    <option value="2x3">2√ó3 (6 cubes) üè¥</option>
                    <option value="4x6">4√ó6 (24 cubes) üè¥</option>
                    <option value="6x9">6√ó9 (54 cubes) üè¥</option>
                    <option value="8x12">8√ó12 (96 cubes) üè¥</option>
                </optgroup>
                <optgroup label="‚¨õ Carr√©s Classiques">
                    <option value="1x1">1√ó1</option>
                    <option value="2x2">2√ó2</option>
                    <option value="3x3" selected>3√ó3</option>
                    <option value="4x4">4√ó4</option>
                    <option value="5x5">5√ó5</option>
                    <option value="6x6">6√ó6</option>
                    <option value="7x7">7√ó7</option>
                    <option value="8x8">8√ó8</option>
                    <option value="9x9">9√ó9</option>
                    <option value="10x10">10√ó10</option>
                </optgroup>
            </select>
            <span class="size-indicator" id="size-indicator"></span>
        </div>

        <div class="control-group">
            <label>Mosaic Name:</label>
            <input id="mosaic-name" type="text" value="My Mosaic">
        </div>

        

        <button id="save-btn">Save Mosaic</button>
    </div>

    <div id="mosaic-wrapper">
        <div id="mosaic-container"></div>
    </div>

    <h3>Mosaic JSON (one cube per line)</h3>
    <pre id="mosaic-json"></pre>

<!-- ===============================
     SIMPLE VIEW CUBES MODAL
     =============================== -->

     <div id="view-cubes-modal" class="modal">
        <div class="modal-content" style="max-width: 1200px;">
            <span class="modal-close" onclick="closeViewCubesModal()">&times;</span>
            <div class="modal-header">
                <h2 id="view-cubes-title">Mosaic Cubes</h2>
                <p id="view-cubes-subtitle">All cubes in this mosaic</p>
                <button onclick="downloadTeacherPDF()" style="background:#673AB7;">
                    üìÑ Download Teacher PDF
                </button>
            </div>
    
            <div id="simple-cubes-grid" class="simple-cubes-grid">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- ===============================
         SCRIPT
         =============================== -->

    <script>
        /* ===============================
           SHARED COLOR MAP
           =============================== */

        const colorMap = {
            R: "#d32f2f",
            B: "#1976d2",
            Y: "#fbc02d",
            G: "#388e3c",
            O: "#f57c00",
            W: "#ffffff"
        };

        let currentViewMosaic = null;

 
        /* ===============================
           CSRF TOKEN HELPER
           =============================== */

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');

        /* ===============================
           MODAL FUNCTIONS
           =============================== */


        let originalMosaicName = null;
        
   
        let currentMosaicData = null;


/* ===============================
   SIMPLE VIEW CUBES MODAL
   =============================== */

   function openViewCubesModal(mosaicId) {
    fetch(`/cube_prep/mosaics/${mosaicId}/`)
        .then(r => {
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            return r.json();
        })
        .then(data => {

            currentViewMosaic = data;   // üëà store it

            // Update modal title
            document.getElementById('view-cubes-title').textContent = 
                `${data.name}`;
            document.getElementById('view-cubes-subtitle').textContent = 
                `${data.cubes.length} cubes total`;
            
            // Populate the grid
            const grid = document.getElementById('simple-cubes-grid');
            grid.innerHTML = '';
            
            // Calculate columns based on mosaic size
            const mosaicCols = data.cubes_per_side;
            let displayCols;
            
            if (mosaicCols <= 5) {
                // Small mosaics: show same number of columns
                displayCols = mosaicCols;
            } else {
                // Large mosaics: show half the columns (rounded up)
                displayCols = Math.ceil(mosaicCols / 2);
            }
            
            // Set grid columns dynamically
            grid.style.gridTemplateColumns = `repeat(${displayCols}, minmax(140px, 1fr))`;
            
            data.cubes.forEach((cube, idx) => {
                const row = Math.floor(idx / data.cubes_per_side);
                const col = idx % data.cubes_per_side;
                
                // Create card
                const card = document.createElement('div');
                card.className = 'simple-cube-card';
                
                // Render cube preview
                const canvas = renderCubePreview(cube, 80);
                card.appendChild(canvas);
                
                // Cube number
                const number = document.createElement('div');
                number.className = 'cube-card-number';
                number.textContent = `Cube #${idx + 1}`;
                card.appendChild(number);
                
                // Position
                const position = document.createElement('div');
                position.className = 'cube-card-position';
                position.textContent = `Row ${row + 1}, Col ${col + 1}`;
                card.appendChild(position);
                
                grid.appendChild(card);
            });
            
            // Show modal
            document.getElementById('view-cubes-modal').classList.add('active');
        })
        .catch(err => {
            console.error('Failed to load mosaic:', err);
            alert('Failed to load mosaic cubes');
        });
}

function closeViewCubesModal() {
    document.getElementById('view-cubes-modal').classList.remove('active');
}
function closeViewCubesModal() {
    document.getElementById('view-cubes-modal').classList.remove('active');
}

// Fixed downloadTeacherPDF function
function downloadTeacherPDF() {
    if (!currentViewMosaic) {
        alert("No mosaic loaded.");
        return;
    }

    console.log("Downloading PDF for mosaic:", currentViewMosaic.id, currentViewMosaic.name);

    // Create FormData with mosaic_id
    const formData = new FormData();
    formData.append("mosaic_id", currentViewMosaic.id);

    fetch("/cube_prep/teacher-pdf/", {
        method: "POST",
        headers: {
            "X-CSRFToken": csrftoken
        },
        body: formData  // Send FormData, not JSON
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.blob();
    })
    .then(blob => {
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${currentViewMosaic.name}_teacher.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();

        window.URL.revokeObjectURL(url);
        console.log("‚úÖ PDF downloaded successfully");
    })
    .catch(err => {
        console.error("PDF error:", err);
        alert("Failed to generate PDF: " + err.message);
    });
}
        /* ===============================
           RENDER HELPERS
           =============================== */

        function renderCubePreview(cube, size) {
            const canvas = document.createElement('canvas');
            const stickerSize = Math.floor(size / 3);
            canvas.width = size;
            canvas.height = size;
            canvas.style.border = '1px solid #999';

            const ctx = canvas.getContext('2d');

            cube.forEach((row, i) => {
                row.forEach((color, j) => {
                    ctx.fillStyle = colorMap[color] || "#ccc";
                    ctx.fillRect(j * stickerSize, i * stickerSize, stickerSize, stickerSize);
                    
                    ctx.strokeStyle = "#000";
                    ctx.lineWidth = 0.5;
                    ctx.strokeRect(j * stickerSize, i * stickerSize, stickerSize, stickerSize);
                });
            });

            return canvas;
        }

        function renderMosaicPreview(data) {
            const cols = data.cubes_per_side;
            const cubes = data.cubes;
            const totalCubes = cubes.length;
            const rows = Math.ceil(totalCubes / cols);

            const stickerSize = 2;
            const cubeSize = 3 * stickerSize;
            const totalWidth = cols * cubeSize;
            const totalHeight = rows * cubeSize;

            const scale = Math.max(1, Math.min(3, Math.floor(150 / Math.max(totalWidth, totalHeight))));
            const displayWidth = totalWidth * scale;
            const displayHeight = totalHeight * scale;

            const canvas = document.createElement("canvas");
            canvas.width = totalWidth;
            canvas.height = totalHeight;

            const ctx = canvas.getContext("2d");

            cubes.forEach((cube, idx) => {
                const r = Math.floor(idx / cols);
                const c = idx % cols;

                cube.forEach((row, i) => {
                    row.forEach((color, j) => {
                        ctx.fillStyle = colorMap[color] || "#ccc";
                        ctx.fillRect(
                            c * cubeSize + j * stickerSize,
                            r * cubeSize + i * stickerSize,
                            stickerSize,
                            stickerSize
                        );
                    });
                });
            });

            canvas.style.width = displayWidth + "px";
            canvas.style.height = displayHeight + "px";
            canvas.style.imageRendering = "pixelated";

            return canvas;
        }

        /* ===============================
           MOSAIC GALLERY
           =============================== */

        const gallery = document.getElementById("mosaic-gallery");

        function loadMosaicPreviews() {
            fetch("/cube_prep/mosaics/")
                .then(r => {
                    if (!r.ok) {
                        throw new Error(`HTTP ${r.status}: ${r.statusText}`);
                    }
                    return r.json();
                })
                .then(list => {
                    if (list.length === 0) {
                        gallery.innerHTML = '<div class="empty-gallery">No mosaics yet. Create your first one below!</div>';
                        return;
                    }

                    gallery.innerHTML = "";
                    
                    list.forEach(m => {
                        fetch(`/cube_prep/mosaics/${m.id}/`)
                            .then(r => r.json())
                            .then(data => {
                                const thumb = document.createElement("div");
                                thumb.className = "mosaic-thumb";

                                const canvasContainer = document.createElement("div");
                                canvasContainer.className = "mosaic-canvas-container";
                                canvasContainer.appendChild(renderMosaicPreview(data));
                                thumb.appendChild(canvasContainer);

                                const info = document.createElement("div");
                                info.className = "mosaic-info";

                                const name = document.createElement("div");
                                name.className = "mosaic-name";
                                name.textContent = m.name;
                                name.title = m.name;
                                info.appendChild(name);

                                const meta = document.createElement("div");
                                meta.className = "mosaic-meta";
                                const totalCubes = data.cubes.length;  // Use actual count
                                const rows = Math.ceil(totalCubes / data.cubes_per_side);
                                const cols = data.cubes_per_side;
                                meta.textContent = `${rows}√ó${cols} (${totalCubes} cubes)`;
                                info.appendChild(meta);

                                const actions = document.createElement("div");
                                actions.className = "mosaic-actions";

                                const editBtn = document.createElement("button");
                                editBtn.className = "edit-btn";
                                editBtn.textContent = "Edit";
                                editBtn.style.background = "#0000FF";

                                editBtn.onclick = (e) => {
                                    e.stopPropagation();
                                    loadMosaic(m.id);
                                };

                                const duplicateBtn = document.createElement("button");
                                duplicateBtn.className = "duplicate-btn";
                                duplicateBtn.textContent = "Duplicate";
                                duplicateBtn.style.background = "#FF9800";
                                duplicateBtn.onclick = (e) => {
                                    e.stopPropagation();
                                    duplicateMosaic(m.id);
                                };

                                const viewBtn = document.createElement("button");
                                viewBtn.textContent = "View Cubes";
                                viewBtn.onclick = (e) => {
                                    e.stopPropagation();
                                    openViewCubesModal(m.id);
                                };

                                actions.appendChild(editBtn);
                                actions.appendChild(duplicateBtn);
                                actions.appendChild(viewBtn);
                                info.appendChild(actions);

                                thumb.appendChild(info);
                                gallery.appendChild(thumb);
                            })
                            .catch(err => {
                                console.error(`Failed to load mosaic ${m.id}:`, err);
                            });
                    });
                })
                .catch(err => {
                    console.error("Failed to load mosaic list:", err);
                    gallery.innerHTML = `<div class="empty-gallery">Error loading mosaics: ${err.message}</div>`;
                });
        }

        /* ===============================
           EDITOR
           =============================== */

        const container = document.getElementById("mosaic-container");
        const jsonOutput = document.getElementById("mosaic-json");
        const colorSelect = document.getElementById("color-select");
        const cubesSelect = document.getElementById("cubes-per-side");
        const mosaicNameInput = document.getElementById("mosaic-name");
        const sizeIndicator = document.getElementById("size-indicator");
        const saveBtn = document.getElementById("save-btn");

        let rows = 3;
        let cols = 3;
        let mosaic = [];
        let currentMosaicId = null; // Track if we're editing an existing mosaic

        function cellSizeFor(maxDim) {
            return maxDim <= 6 ? 30 : Math.max(22, 36 - maxDim);
        }

        function updateSizeIndicator() {
            const total = rows * cols;
            sizeIndicator.textContent = `(${total} cubes)`;
        }

        function initMosaic(initialData = null) {

container.innerHTML = "";

const size = cellSizeFor(Math.max(rows, cols));

mosaic = initialData
    ? JSON.parse(JSON.stringify(initialData)) // deep copy
    : [];

let cubeIndex = 0;

for (let r = 0; r < rows; r++) {
    const rowDiv = document.createElement("div");
    rowDiv.className = "cube-row";

    for (let c = 0; c < cols; c++) {

        const currentIndex = cubeIndex;

        const cube =
            mosaic[currentIndex] ||
            [
                ["W","W","W"],
                ["W","W","W"],
                ["W","W","W"]
            ];

        mosaic[currentIndex] = cube;

        const cubeDiv = document.createElement("div");
        cubeDiv.className = "cube-div";
        cubeDiv.style.gridTemplateColumns = `repeat(3, ${size}px)`;

        const label = document.createElement("div");
        label.className = "cube-label";
        label.textContent = `(${r+1},${c+1})`;
        cubeDiv.appendChild(label);

        for (let i = 0; i < 3; i++) {
            for (let j = 0; j < 3; j++) {

                const cell = document.createElement("div");
                cell.className = "cube-cell";
                cell.style.width = size + "px";
                cell.style.height = size + "px";
                cell.style.background = colorMap[cube[i][j]];

                cell.onclick = () => {
                    const col = colorSelect.value;
                    mosaic[currentIndex][i][j] = col;
                    cell.style.background = colorMap[col];
                    updateJSON();
                };

                cubeDiv.appendChild(cell);
            }
        }

        rowDiv.appendChild(cubeDiv);
        cubeIndex++;
    }

    container.appendChild(rowDiv);
}

updateSizeIndicator();
updateJSON();
}



        function updateJSON() {
            jsonOutput.textContent =
                mosaic.map(c => JSON.stringify(c)).join("\n");
        }

    function loadMosaic(id) {
        if (!confirm("Load this mosaic? Unsaved changes will be lost.")) return;

    fetch(`/cube_prep/mosaics/${id}/`)
        .then(r => r.json())
        .then(data => {

            const totalCubes = data.cubes.length;
            cols = data.cubes_per_side;
            rows = Math.ceil(totalCubes / cols);

            cubesSelect.value = `${rows}x${cols}`;
            mosaicNameInput.value = data.name;

            currentMosaicId = id;

            initMosaic(data.cubes);

            saveBtn.textContent = "üíæ Update Mosaic";
        });
}



function duplicateMosaic(id) {
    fetch(`/cube_prep/mosaics/${id}/`)
        .then(r => r.json())
        .then(data => {

            const totalCubes = data.cubes.length;
            cols = data.cubes_per_side;
            rows = Math.ceil(totalCubes / cols);

            cubesSelect.value = `${rows}x${cols}`;
            mosaicNameInput.value = data.name + " (Copy)";

            currentMosaicId = null;

            initMosaic(data.cubes);

            saveBtn.textContent = "üíæ Save Mosaic";

            document.getElementById('mosaic-wrapper').scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });

            alert(`‚úÖ "${data.name}" duplicated! Edit and save when ready.`);
        });
}


saveBtn.onclick = () => {

console.log("====== SAVE BUTTON CLICKED ======");
console.log("currentMosaicId:", currentMosaicId);
console.log("rows:", rows);
console.log("cols:", cols);
console.log("mosaic length:", mosaic.length);
console.log("mosaic data:", JSON.stringify(mosaic));
console.log("=================================");

const formData = new FormData();
formData.append("mosaic_id", currentMosaicId || "");
formData.append("mosaic_name", mosaicNameInput.value || "Untitled Mosaic");
formData.append("cubes_per_side", cols);
formData.append("mosaic_json", JSON.stringify(mosaic));

fetch("/cube_prep/save-mosaic/", {
    method: "POST",
    body: formData,
    headers: {
        "X-CSRFToken": csrftoken
    }
})
.then(response => response.json())
.then(d => {
    console.log("SERVER RESPONSE:", d);

    if (d.success) {
        currentMosaicId = d.mosaic_id;
        saveBtn.textContent = "üíæ Update Mosaic";

        alert("Saved!");

        //loadMosaic(currentMosaicId);
        loadMosaicPreviews();
    } else {
        alert("Error: " + (d.error || "Unknown error"));
    }
})
.catch(err => {
    console.error("Save error:", err);
    alert("Save failed.");
});
};




        cubesSelect.onchange = () => {
            const value = cubesSelect.value;
            if (value.includes('x')) {
                // Rectangular grid (e.g., "2x3", "4x6")
                const [h, w] = value.split('x').map(Number);
                rows = h;
                cols = w;
            } else {
                // Square grid (backward compatibility)
                rows = parseInt(value);
                cols = parseInt(value);
            }
            
            // Reset to create mode when changing size
            currentMosaicId = null;
            saveBtn.textContent = "üíæ Save Mosaic";
            
            initMosaic();
        };

        window.onclick = (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        };

        // Initialize with default 3x3
        cubesSelect.value = '3x3';
        rows = 3;
        cols = 3;
        initMosaic();
        loadMosaicPreviews();



    </script>

</body>
</html>