<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cube Mosaic Editor</title>

    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            max-width: 100%;
            overflow-x: hidden;
        }

        h1 { color: #333; }
        h3 { color: #555; margin-top: 20px; }

        .controls { 
            margin-bottom: 15px; 
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        #mosaic-container { 
            display: flex; 
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
        }

        .cube-row { display: flex; }

        .cube-div { 
            display: grid; 
            grid-gap: 1px;
            margin: 2px;
            border: 1px solid #666;
            cursor: pointer;
        }

        .cube-cell { 
            border: 1px solid #000; 
        }

        #mosaic-json { 
            white-space: pre; 
            background: #f0f0f0; 
            padding: 10px; 
            margin-top: 15px; 
            max-height: 300px; 
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }

        button {
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        #save-btn {
            background: #2196F3;
        }

        select, input[type="text"] {
            padding: 6px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        .size-indicator {
            font-size: 12px;
            color: #666;
        }

        /* ===============================
           Cube Preview Modal
           =============================== */

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.hidden {
            display: none;
        }

        .modal-card {
            background: white;
            border-radius: 14px;
            padding: 16px;
            width: min(90vw, 360px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 18px;
        }

        .modal-header button {
            background: none;
            border: none;
            font-size: 22px;
            cursor: pointer;
        }

        .cube-preview-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
            justify-items: center;
        }

        .cube-preview-cell {
            border: 1px solid #000;
        }
    </style>
</head>

<body>

<h1>Cube Mosaic Editor</h1>

<div class="controls">
    <div class="control-group">
        <label>Color:</label>
        <select id="color-select">
            <option value="R">Red</option>
            <option value="B">Blue</option>
            <option value="Y">Yellow</option>
            <option value="G">Green</option>
            <option value="O">Orange</option>
            <option value="W">White</option>
        </select>
    </div>

    <div class="control-group">
        <label>Grid Size:</label>
        <select id="cubes-per-side">
            <option value="1">1×1</option>
            <option value="2">2×2</option>
            <option value="3" selected>3×3</option>
            <option value="4">4×4</option>
            <option value="5">5×5</option>
            <option value="6">6×6</option>
            <option value="7">7×7</option>
            <option value="8">8×8</option>
            <option value="9">9×9</option>
            <option value="10">10×10</option>
        </select>
        <span class="size-indicator" id="size-indicator"></span>
    </div>

    <div class="control-group">
        <label>Mosaic Name:</label>
        <input id="mosaic-name" type="text" value="My Mosaic">
    </div>

    <button id="save-btn">Save Mosaic</button>
</div>

<div id="mosaic-container"></div>

<h3>Mosaic JSON (one cube per line)</h3>
<pre id="mosaic-json"></pre>

<!-- ===============================
     Cube Preview Modal
     =============================== -->

<div id="cube-preview-overlay" class="modal-overlay hidden">
    <div class="modal-card">
        <div class="modal-header">
            <h2 id="cube-preview-title">Cube Preview</h2>
            <button id="cube-preview-close">✕</button>
        </div>
        <div id="cube-preview-grid" class="cube-preview-grid"></div>
    </div>
</div>

<script>
/* ===============================
   Shared config
   =============================== */

const colorMap = {
    R: "red",
    B: "blue",
    Y: "yellow",
    G: "green",
    O: "orange",
    W: "white"
};

/* ===============================
   Mosaic editor
   =============================== */

const container = document.getElementById("mosaic-container");
const jsonOutput = document.getElementById("mosaic-json");
const colorSelect = document.getElementById("color-select");
const cubesSelect = document.getElementById("cubes-per-side");
const mosaicNameInput = document.getElementById("mosaic-name");
const saveBtn = document.getElementById("save-btn");
const sizeIndicator = document.getElementById("size-indicator");

let cubesPerSide = parseInt(cubesSelect.value);
let mosaic = [];

function getCellSize(n) {
    return n <= 6 ? 30 : n <= 8 ? 28 : 25;
}

function updateSizeIndicator() {
    sizeIndicator.textContent = `(${cubesPerSide ** 2} cubes)`;
}

function initMosaic() {
    mosaic = [];
    container.innerHTML = "";

    const cellSize = getCellSize(cubesPerSide);

    for (let y = 0; y < cubesPerSide; y++) {
        const row = document.createElement("div");
        row.className = "cube-row";

        for (let x = 0; x < cubesPerSide; x++) {
            const cube = Array.from({length:3}, () => Array(3).fill("W"));
            const cubeDiv = document.createElement("div");
            cubeDiv.className = "cube-div";
            cubeDiv.style.gridTemplateColumns = `repeat(3, ${cellSize}px)`;

            cubeDiv.addEventListener("dblclick", () => {
                openCubePreview(cube, {
                    title: `Cube (${y + 1}, ${x + 1})`,
                    cellSize: 45
                });
            });

            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    const cell = document.createElement("div");
                    cell.className = "cube-cell";
                    cell.style.width = `${cellSize}px`;
                    cell.style.height = `${cellSize}px`;
                    cell.style.background = colorMap.W;

                    cell.addEventListener("click", () => {
                        const c = colorSelect.value;
                        cube[i][j] = c;
                        cell.style.background = colorMap[c];
                        updateJSON();
                    });

                    cubeDiv.appendChild(cell);
                }
            }

            mosaic.push(cube);
            row.appendChild(cubeDiv);
        }

        container.appendChild(row);
    }

    updateSizeIndicator();
    updateJSON();
}

function updateJSON() {
    jsonOutput.textContent = mosaic.map(c => JSON.stringify(c)).join("\n");
}

cubesSelect.addEventListener("change", () => {
    cubesPerSide = parseInt(cubesSelect.value);
    initMosaic();
});

/* ===============================
   Save mosaic
   =============================== */

saveBtn.addEventListener("click", () => {
    fetch("/cube_prep/save-mosaic/", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": getCookie("csrftoken")
        },
        body: new URLSearchParams({
            mosaic_json: JSON.stringify(mosaic),
            cubes_per_side: cubesPerSide,
            mosaic_name: mosaicNameInput.value || "My Mosaic"
        })
    })
    .then(r => r.json())
    .then(d => alert(d.success ? "Saved!" : d.error));
});

function getCookie(name) {
    return document.cookie.split("; ")
        .find(row => row.startsWith(name + "="))
        ?.split("=")[1];
}

/* ===============================
   Cube preview modal
   =============================== */

const overlay = document.getElementById("cube-preview-overlay");
const grid = document.getElementById("cube-preview-grid");
const title = document.getElementById("cube-preview-title");
const closeBtn = document.getElementById("cube-preview-close");

function openCubePreview(cube, {title: t="Cube Preview", cellSize=40} = {}) {
    title.textContent = t;
    grid.innerHTML = "";
    grid.style.gridTemplateColumns = `repeat(3, ${cellSize}px)`;

    cube.flat().forEach(c => {
        const cell = document.createElement("div");
        cell.className = "cube-preview-cell";
        cell.style.width = `${cellSize}px`;
        cell.style.height = `${cellSize}px`;
        cell.style.background = colorMap[c];
        grid.appendChild(cell);
    });

    overlay.classList.remove("hidden");
}

closeBtn.onclick = () => overlay.classList.add("hidden");
overlay.onclick = e => e.target === overlay && overlay.classList.add("hidden");

/* Init */
initMosaic();
</script>

</body>
</html>
