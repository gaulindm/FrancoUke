{% extends "francontcube/partials/base.html" %}
{% load static %}

{% block title %}Permutation des arÃªtes â€” Francontcube{% endblock %}

{% block content %}
<div class="container py-5">

    <!-- Titre principal -->
    <div class="text-center mb-5">
        <h1 class="hero-title">
            Ã‰tape 7 : <span class="brand-green">Permutation des arÃªtes</span>
        </h1>
        <p class="lead text-muted">
            DerniÃ¨re Ã©tape! Permute les 4 arÃªtes du haut pour rÃ©soudre complÃ¨tement le cube.
        </p>
    </div>

    <!-- Charger le template SVG (cachÃ©) -->
    {% include "cube/partials/_cube_svg.html" %}

    <!-- Warning for missing cube states (only shown if any are missing) -->
    {% if missing_slugs %}
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <h4 class="alert-heading">âš ï¸ Missing Cube States</h4>
        <p>The following CubeState objects need to be created in the database:</p>
        <ul class="mb-0">
            {% for slug in missing_slugs %}
            <li><code>{{ slug }}</code></li>
            {% endfor %}
        </ul>
        <hr>
        <p class="mb-0 small">Use your cube state creation tool to add these. The page will display placeholders until they're created.</p>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <!-- Section Objectif -->
    <div class="card p-4 mb-4">
        <h3 class="brand-green">ğŸ¯ Objectif</h3>
        <p>
            <strong>C'est la derniÃ¨re Ã©tape!</strong> Tous les coins sont bien placÃ©s. 
            Il ne reste qu'Ã  permuter les arÃªtes de la derniÃ¨re couche pour <strong>rÃ©soudre complÃ¨tement le cube!</strong>
        </p>

        <div class="row mt-3">
            <div class="col-md-6 text-center mb-3">
                <h5>Avant : Coins placÃ©s</h5>
                <div id="cube-before" class="cube-small"></div>
                <p><small class="text-muted">Les arÃªtes ne sont pas encore alignÃ©es</small></p>
            </div>
            <div class="col-md-6 text-center mb-3">
                <h5>AprÃ¨s : CUBE RÃ‰SOLU! ğŸ‰</h5>
                <div id="cube-goal" class="cube-small"></div>
                <p><small class="text-muted">Toutes les faces sont complÃ¨tes!</small></p>
            </div>
        </div>

        <div class="alert alert-success mt-3">
            <strong>âœ… Si ton cube est dÃ©jÃ  rÃ©solu :</strong> FÃ©licitations! ğŸŠ Tu as terminÃ©! 
            Refais-le encore et encore pour amÃ©liorer ta vitesse!
        </div>
    </div>

    <!-- Section Comment identifier -->
    <div class="card p-4 mb-4">
        <h3 class="brand-green">ğŸ” Comment identifier les arÃªtes Ã  permuter ?</h3>
        <p>
            Regarde les 4 faces latÃ©rales du cube. Certaines arÃªtes de la derniÃ¨re couche 
            ne correspondent pas Ã  leur centre.
        </p>

        <div class="alert alert-info">
            <strong>ğŸ’¡ Astuce :</strong> Tourne lentement le cube dans tes mains et regarde 
            chaque face. Combien d'arÃªtes du haut sont mal placÃ©es?
        </div>
    </div>

    <!-- Section L'algorithme -->
    <div class="card p-4 mb-4">
        <h3 class="brand-green">ğŸ”„ L'algorithme de permutation</h3>
        <p>
            Cet algorithme Ã©change 3 arÃªtes en cercle. Il est un peu long, mais c'est le dernier!
        </p>

        <div class="text-center p-4 bg-light rounded border border-success border-3 mb-3">
            <h2 class="mb-2">
                <code class="fs-1 text-success">F2 U L R' F2 L' R U F2</code>
            </h2>
            <p class="mb-0"><small>L'algorithme de permutation des arÃªtes</small></p>
        </div>

        <div class="alert alert-info">
            <strong>ğŸ’¡ DÃ©composition :</strong>
            <ul class="mb-0 mt-2">
                <li><code>F2</code> = Face avant deux fois</li>
                <li><code>U</code> = Haut</li>
                <li><code>L R'</code> = Gauche et droite en mÃªme temps (opposÃ©s)</li>
                <li><code>F2</code> = Face avant deux fois encore</li>
                <li><code>L' R</code> = Inverse de L R'</li>
                <li><code>U</code> = Haut</li>
                <li><code>F2</code> = Face avant deux fois une derniÃ¨re fois</li>
            </ul>
        </div>

        <div class="alert alert-success mt-3">
            <strong>âœ‹ Technique de prise :</strong>
            <ul class="mb-0 mt-2">
                <li>Les deux mains travaillent ensemble</li>
                <li>Pour <code>L R'</code> : fais les deux en mÃªme temps!</li>
                <li>Pour <code>L' R</code> : pareil, en mÃªme temps mais dans l'autre sens</li>
                <li><strong>F2 est trÃ¨s frÃ©quent</strong> - pratique-le jusqu'Ã  ce qu'il soit rapide</li>
            </ul>
        </div>
    </div>

    <!-- Section Les cas -->
    <div class="card p-4 mb-4 border-warning">
        <h3 class="brand-green">ğŸ“Š Les diffÃ©rents cas</h3>

        <!-- Cas 1: 3 arÃªtes en cercle -->
        <div class="border rounded p-3 mb-3 bg-light">
            <h5 class="text-success">âœ… Cas 1 : 3 arÃªtes tournent en cercle (sens horaire)</h5>
            <div class="row align-items-center">
                <div class="col-md-4 text-center">
                    <div id="cube-pattern-clockwise" class="cube-case"></div>
                    <p class="mt-2"><small>Rotation horaire</small></p>
                </div>
                <div class="col-md-8">
                    <p><strong>Comment orienter :</strong></p>
                    <ol class="mb-2">
                        <li>Trouve l'arÃªte qui est <strong>dÃ©jÃ  correcte</strong></li>
                        <li>Tourne tout le cube pour mettre cette arÃªte <strong>derriÃ¨re toi</strong></li>
                        <li>Fais l'algorithme <code>F2 U L R' F2 L' R U F2</code></li>
                        <li>Les 3 autres arÃªtes vont tourner en cercle!</li>
                    </ol>
                    <div class="alert alert-warning mb-0">
                        <strong>âš ï¸ Important :</strong> L'arÃªte correcte DOIT Ãªtre derriÃ¨re!
                    </div>
                </div>
            </div>
        </div>

        <!-- Cas 2: ArÃªtes opposÃ©es -->
        <div class="border rounded p-3 mb-3 bg-light">
            <h5 class="text-primary">âœ… Cas 2 : 2 paires d'arÃªtes opposÃ©es</h5>
            <div class="row align-items-center">
                <div class="col-md-4 text-center">
                    <div id="cube-pattern-opposite" class="cube-case"></div>
                    <p class="mt-2"><small>Paires opposÃ©es Ã  Ã©changer</small></p>
                </div>
                <div class="col-md-8">
                    <p><strong>Comment procÃ©der :</strong></p>
                    <ol class="mb-2">
                        <li>Fais l'algorithme dans n'importe quelle orientation</li>
                        <li>Maintenant tu auras le Cas 1 (3 arÃªtes en cercle)</li>
                        <li>RÃ©oriente et fais l'algorithme une deuxiÃ¨me fois</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- Cas 3: ArÃªtes adjacentes -->
        <div class="border rounded p-3 bg-light">
            <h5 class="text-info">âœ… Cas 3 : 2 paires d'arÃªtes adjacentes</h5>
            <div class="row align-items-center">
                <div class="col-md-4 text-center">
                    <div id="cube-pattern-adjacent" class="cube-case"></div>
                    <p class="mt-2"><small>Paires adjacentes</small></p>
                </div>
                <div class="col-md-8">
                    <p><strong>Comment procÃ©der :</strong></p>
                    <ol class="mb-2">
                        <li>Oriente le cube pour que les deux arÃªtes correctes soient <strong>Ã  gauche et derriÃ¨re</strong></li>
                        <li>Fais l'algorithme</li>
                        <li>Les deux arÃªtes de droite vont s'Ã©changer!</li>
                    </ol>
                    <p class="mb-0"><small><strong>Astuce :</strong> Si tu n'es pas sÃ»r, fais l'algorithme et tu verras le rÃ©sultat!</small></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Section Processus complet -->
    <div class="card p-4 mb-4">
        <h3 class="brand-green">ğŸ“‹ Processus complet</h3>
        <ol>
            <li class="mb-2">
                <strong>VÃ©rifie ton cube</strong> : Tourne-le dans tes mains et regarde les 4 faces
            </li>
            <li class="mb-2">
                <strong>Compte les arÃªtes correctes</strong> : Combien d'arÃªtes du haut correspondent Ã  leur centre?
                <ul>
                    <li>4 arÃªtes â†’ Cube rÃ©solu! ğŸ‰</li>
                    <li>1 arÃªte â†’ Cas 1 (rotation)</li>
                    <li>0 arÃªtes â†’ Cas 2 (opposÃ©es) ou Cas 3 (adjacentes)</li>
                </ul>
            </li>
            <li class="mb-2">
                <strong>Oriente le cube correctement</strong> selon le cas identifiÃ©
            </li>
            <li class="mb-2">
                <strong>Fais l'algorithme</strong> : <code>F2 U L R' F2 L' R U F2</code>
            </li>
            <li class="mb-2">
                <strong>VÃ©rifie le rÃ©sultat</strong> : 
                <ul>
                    <li>Cube rÃ©solu â†’ BRAVO! ğŸŠ</li>
                    <li>Pas encore â†’ RÃ©oriente et refais l'algorithme</li>
                </ul>
            </li>
        </ol>

        <div class="alert alert-info mt-3 mb-0">
            <strong>ğŸ’¡ Nombre de rÃ©pÃ©titions :</strong>
            <p class="mb-0">Tu devras faire l'algorithme 1 ou 2 fois maximum. Si aprÃ¨s 2 fois le cube n'est pas rÃ©solu, vÃ©rifie ton orientation!</p>
        </div>
    </div>

    <!-- Section Conseils -->
    <div class="card p-4 mb-4">
        <h3 class="brand-green">ğŸ’¡ Conseils utiles</h3>
        <ul class="mt-3">
            <li>
                <strong>Cet algorithme est long mais rÃ©pÃ©titif.</strong> F2 apparaÃ®t 3 fois! 
                MÃ©morise le pattern plutÃ´t que chaque mouvement.
            </li>
            <li>
                <strong>L R' et L' R sont opposÃ©s et simultanÃ©s.</strong> EntraÃ®ne-toi Ã  faire 
                les deux mains en mÃªme temps - c'est trÃ¨s satisfaisant!
            </li>
            <li>
                <strong>L'orientation est cruciale.</strong> Si tu te trompes d'orientation, 
                l'algorithme ne rÃ©soudra pas le cube mais ne le cassera pas non plus.
            </li>
            <li>
                <strong>Prends ton temps pour identifier le cas.</strong> C'est la derniÃ¨re Ã©tape - 
                autant bien la faire!
            </li>
            <li>
                <strong>Une fois le cube rÃ©solu, cÃ©lÃ¨bre!</strong> ğŸ‰ Tu as accompli quelque chose 
                que beaucoup de gens pensent impossible!
            </li>
        </ul>
    </div>

    <!-- Section FÃ©licitations -->
    <div class="card p-4 mb-4 border-success bg-light">
        <h3 class="brand-green text-center">ğŸŠ FÃ‰LICITATIONS! ğŸŠ</h3>
        <p class="text-center lead">
            Tu sais maintenant rÃ©soudre un Rubik's Cube 3Ã—3!
        </p>
        
        <div class="row mt-4">
            <div class="col-md-6 mb-3">
                <h5>ğŸš€ Prochaines Ã©tapes :</h5>
                <ul>
                    <li>Pratique jusqu'Ã  pouvoir le faire sans regarder le guide</li>
                    <li>ChronomÃ¨tre-toi et essaie d'amÃ©liorer ton temps</li>
                    <li>Apprends des mÃ©thodes plus avancÃ©es (CFOP, Roux)</li>
                    <li>Rejoins la communautÃ© des speedcubers!</li>
                </ul>
            </div>
            <div class="col-md-6 mb-3">
                <h5>ğŸ“Š Tes statistiques :</h5>
                <ul>
                    <li><strong>7 Ã©tapes</strong> maÃ®trisÃ©es</li>
                    <li><strong>~10 algorithmes</strong> appris</li>
                    <li><strong>Infini</strong> de possibilitÃ©s de rÃ©solution</li>
                    <li><strong>1</strong> cube rÃ©solu = Mission accomplie! âœ“</li>
                </ul>
            </div>
        </div>

        <div class="text-center mt-3">
            <p class="mb-2"><strong>Continue de pratiquer et amuse-toi!</strong></p>
            <p class="mb-0 text-muted"><small>Le Rubik's Cube est un voyage, pas une destination ğŸ˜Š</small></p>
        </div>
    </div>

    <!-- Bouton de navigation -->
    <div class="text-center">
        <a href="{% url 'francontcube:corner_permutation' %}" class="btn btn-outline-primary">
            â† Retour : Permutation des coins
        </a>
        <a href="{% url 'francontcube:method_cubienewbie' %}" class="btn btn-success ms-2">
            Retour aux Ã©tapes
        </a>
        <a href="{% url 'francontcube:home' %}" class="btn btn-outline-secondary ms-2">
            Accueil
        </a>
    </div>
</div>

<!-- Styles CSS pour les cubes -->
<style>
.cube-small svg {
    max-width: 275px;
    height: auto;
}

.cube-case svg {
    max-width: 200px;
    height: auto;
}

@media (max-width: 768px) {
    .cube-small svg {
        max-width: 200px;
    }
    
    .cube-case svg {
        max-width: 150px;
    }
}
</style>

<!-- Script d'initialisation de la page -->
<script type="module">
  import { renderCube } from "{% static 'cube/js/cube_renderer.js' %}";

  function mountCube(containerId, state) {
    const container = document.getElementById(containerId);
    container.innerHTML = ''; // Clear any existing content
    
    // If state is missing, show a placeholder
    if (!state) {
      container.innerHTML = `
        <div class="alert alert-secondary text-center py-4">
          <i class="bi bi-cube text-muted" style="font-size: 3rem;"></i>
          <p class="mb-0 mt-2 text-muted">Cube state not available</p>
          <small class="text-muted">Create the CubeState in your admin tool</small>
        </div>
      `;
      return;
    }
    
    const template = document.getElementById("cube-template");
    const clone = template.content.cloneNode(true);
    container.appendChild(clone);

    const svg = container.querySelector("svg");
    renderCube(svg, state);
  }

  document.addEventListener("DOMContentLoaded", () => {
    // Mount all cubes
    mountCube("cube-before", {{ before_state|safe }});
    mountCube("cube-goal", {{ goal_state|safe }});
    
    // Different patterns
    mountCube("cube-pattern-clockwise", {{ pattern_clockwise_state|safe }});
    mountCube("cube-pattern-opposite", {{ pattern_opposite_state|safe }});
    mountCube("cube-pattern-adjacent", {{ pattern_adjacent_state|safe }});
  });
</script>

{% endblock %}