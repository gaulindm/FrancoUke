{% extends "francontcube/partials/base.html" %}
{% load static %}

{% block title %}Permutation des coins ‚Äî Francontcube{% endblock %}

{% block content %}
<div class="container py-5">

    <!-- Titre principal -->
    <div class="text-center mb-5">
        <h1 class="hero-title">
            √âtape 6 : <span class="brand-green">Permutation des coins</span>
        </h1>
        <p class="lead text-muted">
            Placer les 4 coins jaunes √† leur bon emplacement (sans se soucier de leur orientation).
        </p>
    </div>

    <!-- Charger le template SVG (cach√©) -->
    {% include "cube/partials/_cube_svg.html" %}

    <!-- Warning for missing cube states (only shown if any are missing) -->
    {% if missing_slugs %}
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <h4 class="alert-heading">‚ö†Ô∏è Missing Cube States</h4>
        <p>The following CubeState objects need to be created in the database:</p>
        <ul class="mb-0">
            {% for slug in missing_slugs %}
            <li><code>{{ slug }}</code></li>
            {% endfor %}
        </ul>
        <hr>
        <p class="mb-0 small">Use your cube state creation tool to add these. The page will display placeholders until they're created.</p>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <!-- Section Objectif -->
    <div class="card p-4 mb-4">
        <h3 class="brand-green">üéØ Objectif</h3>
        <p>
            Maintenant que toute la face jaune est compl√®te, il faut <strong>placer les coins au bon endroit</strong>. 
            Chaque coin doit avoir ses 3 couleurs qui correspondent aux 3 centres voisins.
        </p>

        <div class="alert alert-info">
            <strong>üí° Important :</strong> √Ä cette √©tape, on ne se pr√©occupe PAS de l'orientation 
            des coins - juste de leur <strong>position</strong>. L'orientation sera corrig√©e automatiquement 
            √† la derni√®re √©tape!
        </div>

        <div class="row mt-3">
            <div class="col-md-6 text-center mb-3">
                <h5>Avant : Face jaune compl√®te</h5>
                <div id="cube-before" class="cube-small"></div>
                <p><small class="text-muted">Les coins sont mal plac√©s</small></p>
            </div>
            <div class="col-md-6 text-center mb-3">
                <h5>Apr√®s : Coins bien plac√©s</h5>
                <div id="cube-goal" class="cube-small"></div>
                <p><small class="text-muted">Chaque coin est au bon endroit</small></p>
            </div>
        </div>
    </div>

    <!-- Section Comment identifier -->
    <div class="card p-4 mb-4">
        <h3 class="brand-green">üîç Comment savoir si un coin est bien plac√© ?</h3>
        <p>
            Un coin est <strong>bien plac√©</strong> quand ses 3 couleurs correspondent aux 3 centres voisins, 
            <strong>m√™me s'il est mal orient√©</strong>.
        </p>

        <div class="alert alert-warning">
            <strong>‚ö†Ô∏è Ne regarde PAS la face jaune!</strong> Regarde les <strong>c√¥t√©s</strong> du cube. 
            Les couleurs du coin doivent correspondre aux centres, peu importe o√π est le jaune.
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <div class="border rounded p-3 bg-light text-center">
                    <h5 class="text-success">‚úÖ Coin bien plac√©</h5>
                    <p class="mb-0">Les 3 couleurs du coin correspondent aux 3 centres voisins</p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="border rounded p-3 bg-light text-center">
                    <h5 class="text-danger">‚ùå Coin mal plac√©</h5>
                    <p class="mb-0">Au moins une couleur ne correspond pas √† son centre</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Section L'algorithme -->
    <div class="card p-4 mb-4">
        <h3 class="brand-green">üîÑ L'algorithme de permutation</h3>
        <p>
            Cet algorithme fait tourner 3 coins en cercle, tout en gardant un coin fixe.
        </p>

        <div class="text-center p-4 bg-light rounded border border-success border-3 mb-3">
            <h2 class="mb-2">
                <code class="fs-1 text-success">U R U' L' U R' U' L</code>
            </h2>
            <p class="mb-0"><small>L'algorithme de permutation des coins</small></p>
        </div>

        <div class="alert alert-info">
            <strong>üí° D√©composition :</strong>
            <ul class="mb-0 mt-2">
                <li><code>U R U'</code> = Commence comme d'habitude</li>
                <li><code>L'</code> = Main gauche intervient</li>
                <li><code>U R' U'</code> = Retour avec la main droite</li>
                <li><code>L</code> = Termine avec la main gauche</li>
            </ul>
        </div>

        <div class="alert alert-success mt-3">
            <strong>‚úã Technique de prise :</strong>
            <ul class="mb-0 mt-2">
                <li>Main droite : fait R, U, R', U'</li>
                <li>Main gauche : fait L' et L</li>
                <li>Les deux mains travaillent ensemble!</li>
            </ul>
        </div>
    </div>

    <!-- Section Les cas -->
    <div class="card p-4 mb-4 border-warning">
        <h3 class="brand-green">üìä Les diff√©rents cas</h3>

        <!-- Cas 1: Un coin correct -->
        <div class="border rounded p-3 mb-3 bg-light">
            <h5 class="text-success">‚úÖ Cas 1 : UN coin est bien plac√©</h5>
            <div class="row align-items-center">
                <div class="col-md-4 text-center">
                    <div id="cube-one-correct" class="cube-case"></div>
                    <p class="mt-2"><small>Un coin correct</small></p>
                </div>
                <div class="col-md-8">
                    <p><strong>Comment orienter :</strong></p>
                    <ol class="mb-2">
                        <li>Trouve le coin qui est d√©j√† bien plac√©</li>
                        <li>Tourne tout le cube pour mettre ce coin <strong>en haut √† gauche devant toi</strong></li>
                        <li>Fais l'algorithme <code>U R U' L' U R' U' L</code></li>
                        <li>Les 3 autres coins vont se placer!</li>
                    </ol>
                    <div class="alert alert-warning mb-0">
                        <strong>‚ö†Ô∏è Critique :</strong> Le coin correct DOIT √™tre en haut √† gauche!
                    </div>
                </div>
            </div>
        </div>

        <!-- Cas 2: Aucun coin correct -->
        <div class="border rounded p-3 mb-3 bg-light">
            <h5 class="text-primary">‚úÖ Cas 2 : AUCUN coin n'est bien plac√©</h5>
            <div class="row align-items-center">
                <div class="col-md-4 text-center">
                    <div id="cube-no-correct" class="cube-case"></div>
                    <p class="mt-2"><small>Aucun coin correct</small></p>
                </div>
                <div class="col-md-8">
                    <p><strong>Comment proc√©der :</strong></p>
                    <ol class="mb-2">
                        <li>Fais l'algorithme dans n'importe quelle orientation</li>
                        <li>Maintenant, au moins un coin sera bien plac√©</li>
                        <li>Utilise le Cas 1 pour finir!</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- Cas 3: Les phares -->
        <div class="border rounded p-3 bg-light">
            <h5 class="text-info">‚úÖ Cas 3 : Les "phares" (2 coins de la m√™me couleur c√¥te √† c√¥te)</h5>
            <p>Parfois, tu verras deux coins de la m√™me couleur c√¥te √† c√¥te - on appelle √ßa des "phares".</p>
            
            <div class="row mt-3">
                <div class="col-md-6 text-center mb-3">
                    <div id="cube-headlights-left" class="cube-case"></div>
                    <p class="mt-2"><small>Phares √† gauche</small></p>
                </div>
                <div class="col-md-6 text-center mb-3">
                    <div id="cube-headlights-right" class="cube-case"></div>
                    <p class="mt-2"><small>Phares √† droite</small></p>
                </div>
            </div>
            
            <p><strong>Orientation :</strong> Mets les phares <strong>derri√®re toi</strong> (√† l'arri√®re du cube), puis fais l'algorithme.</p>
        </div>
    </div>

    <!-- Section Processus complet -->
    <div class="card p-4 mb-4">
        <h3 class="brand-green">üìã Processus complet</h3>
        <ol>
            <li class="mb-2">
                <strong>Cherche un coin bien plac√©</strong> : Regarde les c√¥t√©s du cube, pas la face jaune
            </li>
            <li class="mb-2">
                <strong>D√©termine le cas :</strong>
                <ul>
                    <li>1 coin correct ‚Üí Place-le en haut √† gauche</li>
                    <li>0 coins corrects ‚Üí Fais l'algorithme n'importe comment</li>
                    <li>Phares visibles ‚Üí Mets-les derri√®re</li>
                </ul>
            </li>
            <li class="mb-2">
                <strong>Fais l'algorithme</strong> : <code>U R U' L' U R' U' L</code>
            </li>
            <li class="mb-2">
                <strong>V√©rifie tous les coins</strong> : Chaque coin doit avoir ses couleurs qui correspondent 
                aux centres voisins
            </li>
            <li class="mb-2">
                <strong>Si pas tous corrects</strong> : R√©p√®te le processus (il faudra peut-√™tre faire 
                l'algorithme 2 fois)
            </li>
        </ol>
    </div>

    <!-- Section Conseils -->
    <div class="card p-4 mb-4">
        <h3 class="brand-green">üí° Conseils utiles</h3>
        <ul class="mt-3">
            <li>
                <strong>Prends ton temps pour identifier les coins corrects.</strong> C'est la partie 
                la plus difficile de cette √©tape!
            </li>
            <li>
                <strong>Regarde TOUJOURS les c√¥t√©s du cube, jamais la face jaune.</strong> 
                Le jaune peut √™tre n'importe o√π sur le coin.
            </li>
            <li>
                <strong>L'orientation du coin correct est cruciale.</strong> Il DOIT √™tre en haut √† gauche 
                pour que l'algorithme fonctionne.
            </li>
            <li>
                <strong>Ne panique pas si √ßa ne marche pas du premier coup!</strong> 
                V√©rifie ton orientation et r√©essaie.
            </li>
            <li>
                <strong>Les phares sont un bon indice.</strong> Si tu vois deux coins identiques 
                c√¥te √† c√¥te, utilise-les comme rep√®re!
            </li>
            <li>
                Une fois tous les coins bien plac√©s, <strong>il ne reste qu'une seule √©tape!</strong> 
                Tu es presque au bout! üéâ
            </li>
        </ul>
    </div>

    <!-- Bouton de navigation -->
    <div class="text-center">
        <a href="{% url 'francontcube:yellow_face' %}" class="btn btn-outline-primary">
            ‚Üê Retour : La face jaune
        </a>
        <a href="{% url 'francontcube:method_cubienewbie' %}" class="btn btn-outline-secondary ms-2">
            Vue d'ensemble
        </a>
        <a href="{% url 'francontcube:edge_permutation' %}" class="btn btn-success ms-2">
            Derni√®re √©tape : Permutation des ar√™tes ‚Üí
        </a>
    </div>
</div>

<!-- Styles CSS pour les cubes -->
<style>
.cube-small svg {
    max-width: 275px;
    height: auto;
}

.cube-case svg {
    max-width: 200px;
    height: auto;
}

@media (max-width: 768px) {
    .cube-small svg {
        max-width: 200px;
    }
    
    .cube-case svg {
        max-width: 150px;
    }
}
</style>

<!-- Script d'initialisation de la page -->
<script type="module">
  import { renderCube } from "{% static 'cube/js/cube_renderer.js' %}";

  function mountCube(containerId, state) {
    const container = document.getElementById(containerId);
    container.innerHTML = ''; // Clear any existing content
    
    // If state is missing, show a placeholder
    if (!state) {
      container.innerHTML = `
        <div class="alert alert-secondary text-center py-4">
          <i class="bi bi-cube text-muted" style="font-size: 3rem;"></i>
          <p class="mb-0 mt-2 text-muted">Cube state not available</p>
          <small class="text-muted">Create the CubeState in your admin tool</small>
        </div>
      `;
      return;
    }
    
    const template = document.getElementById("cube-template");
    const clone = template.content.cloneNode(true);
    container.appendChild(clone);

    const svg = container.querySelector("svg");
    renderCube(svg, state);
  }

  document.addEventListener("DOMContentLoaded", () => {
    // Mount all cubes
    mountCube("cube-before", {{ before_state|safe }});
    mountCube("cube-goal", {{ goal_state|safe }});
    
    // Different cases
    mountCube("cube-one-correct", {{ one_correct_state|safe }});
    mountCube("cube-no-correct", {{ no_correct_state|safe }});
    mountCube("cube-headlights-left", {{ headlights_left_state|safe }});
    mountCube("cube-headlights-right", {{ headlights_right_state|safe }});
  });
</script>

{% endblock %}