{% extends "francontcube/partials/base.html" %}
{% load static %}

{% block title %}La croix blanche â€” Francontcube{% endblock %}

{% block content %}
<div class="container py-5">

    <!-- Titre principal -->
    <div class="text-center mb-5">
        <h1 class="hero-title">
            Ã‰tape 1b : <span class="brand-green">La croix blanche</span>
        </h1>
        <p class="lead text-muted">
            Transformer ta marguerite en croix blanche en plaÃ§ant les arÃªtes au bon endroit.
        </p>
    </div>

    <!-- Charger le template SVG (cachÃ©) -->
    {% include "cube/partials/_cube_svg.html" %}

    <!-- Warning for missing cube states (only shown if any are missing) -->
    {% if missing_slugs %}
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <h4 class="alert-heading">âš ï¸ Missing Cube States</h4>
        <p>The following CubeState objects need to be created in the database:</p>
        <ul class="mb-0">
            {% for slug in missing_slugs %}
            <li><code>{{ slug }}</code></li>
            {% endfor %}
        </ul>
        <hr>
        <p class="mb-0 small">Use your cube state creation tool to add these. The page will display placeholders until they're created.</p>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <!-- Section Objectif -->
    <div class="card p-4 mb-4">
        <h3 class="brand-green">ğŸ¯ Objectif</h3>
        <p>
            Amener les 4 arÃªtes blanches <strong>en bas du cube</strong>, formant une croix.
            <strong>Important :</strong> Les couleurs des cÃ´tÃ©s doivent correspondre aux centres !
        </p>

        <div class="text-center mt-3">
            <div id="cube-goal"></div>
            <p class="mt-2"><small class="text-muted">La croix blanche complÃ¨te avec les bonnes couleurs</small></p>
        </div>
    </div>

    <!-- Section Comment faire -->
    <div class="card p-4 mb-4">
        <h3 class="brand-green">ğŸ§© Comment faire ?</h3>

        <p>
            Tu as dÃ©jÃ  la marguerite de l'Ã©tape prÃ©cÃ©dente. Maintenant, il faut
            <strong>Â« retourner les pÃ©tales Â»</strong> un par un vers le bas.
        </p>

        <ol class="mt-3">
            <li>
                <strong>Choisis une arÃªte blanche</strong> sur la face du haut (un Â« pÃ©tale Â»).
            </li>
            <li>
                <strong>Tourne la face du haut (U)</strong> avec ton index droit pour que la couleur du cÃ´tÃ© de l'arÃªte
                soit <strong>au-dessus du centre de droite de la mÃªme couleur</strong>.
            </li>
            <li>
                <strong>Fais R2 avec ta main droite</strong> pour faire descendre l'arÃªte au bon endroit.
            </li>
            <li>
                <strong>RÃ©pÃ¨te pour les 3 autres arÃªtes.</strong>
            </li>
        </ol>

        <div class="alert alert-warning mt-3">
            <strong>ğŸ¯ Astuce importante :</strong> Garde toujours le cube dans la mÃªme orientation !
            Ne tourne pas tout le cube dans tes mains. Utilise seulement U (le haut) pour positionner,
            puis R2 (la droite) pour faire descendre.
        </div>

        <!-- Comparaison Avant/AprÃ¨s -->
        <div class="row mt-4">
            <div class="col-md-6 text-center mb-3">
                <h5 class="brand-green">Avant : La marguerite</h5>
                <div id="cube-before" class="cube-small"></div>
                <p><small class="text-muted">Les arÃªtes blanches sont en haut</small></p>
            </div>
            <div class="col-md-6 text-center mb-3">
                <h5 class="brand-green">AprÃ¨s : La croix blanche</h5>
                <div id="cube-after" class="cube-small"></div>
                <p><small class="text-muted">Les arÃªtes blanches forment une croix en bas</small></p>
            </div>
        </div>
    </div>

    <!-- Section Progression interactive -->
    <div class="card p-4 mb-4">
        <h3 class="brand-green">ğŸ“Š Progression Ã©tape par Ã©tape</h3>
        <p>Clique sur les boutons pour voir comment retourner chaque arÃªte.</p>

        <div class="text-center mt-3">
            <div id="cube-progress"></div>
            <div class="btn-group mt-3" role="group" aria-label="Progression de la croix blanche">
                <button class="btn btn-sm btn-outline-primary active" onclick="updateCrossProgress(0)">Marguerite</button>
                <button class="btn btn-sm btn-outline-primary" onclick="updateCrossProgress(1)">Aligne le petal</button>
                <button class="btn btn-sm btn-outline-primary" onclick="updateCrossProgress(2)">Descendre le petal</button>
                <button class="btn btn-sm btn-outline-primary" onclick="updateCrossProgress(3)">On tourne le cube</button>
                <button class="btn btn-sm btn-outline-success" onclick="updateCrossProgress(4)">Repete pour les 3 autres pÃ©tals</button>
            </div>
            <div id="cross-progress-message" class="mt-3 p-3 bg-light rounded" style="display: none;">
                <p class="mb-0 text-center fw-bold"></p>
            </div>
        </div>
    </div>

    <!-- Section Important -->
    <div class="card p-4 mb-4 border-warning">
        <h3 class="brand-green">âš ï¸ Attention : Les couleurs doivent correspondre !</h3>

        <div class="row mt-3">
            <div class="col-md-6 text-center mb-3">
                <h5 class="text-danger">âŒ Croix incorrecte</h5>
                <div id="cube-wrong" class="cube-small"></div>
                <p><small class="text-muted">Les couleurs ne correspondent pas aux centres</small></p>
            </div>
            <div class="col-md-6 text-center mb-3">
                <h5 class="text-success">âœ… Croix correcte</h5>
                <div id="cube-correct" class="cube-small"></div>
                <p><small class="text-muted">Chaque couleur correspond Ã  son centre</small></p>
            </div>
        </div>

        <p class="mt-3 mb-0">
            <strong>Astuce :</strong> Avant de faire descendre une arÃªte,
            <span class="bg-warning px-2">tourne la face du haut (U)</span>
            pour que la couleur du cÃ´tÃ© de l'arÃªte soit devant le bon centre de couleur !
        </p>
    </div>

    <!-- Section Algorithme -->
    <div class="card p-4 mb-4">
        <h3 class="brand-green">ğŸ”„ L'algorithme simple</h3>
        <p>Pour faire descendre une arÃªte blanche du haut vers le bas :</p>

        <div class="text-center p-4 bg-light rounded border border-success border-3">
            <h2 class="mb-0">
                <code class="fs-1 text-success">R2</code>
            </h2>
            <p class="mt-2 mb-0"><small>(Tourne la face droite deux fois / demi-tour avec la main droite)</small></p>
        </div>

        <div class="alert alert-success mt-3">
            <strong>âœ‹ Technique recommandÃ©e :</strong>
            <ul class="mb-0">
                <li>Tiens le cube <strong>fermement avec ta main gauche</strong></li>
                <li>Utilise ta <strong>main droite pour faire R2</strong></li>
                <li>Tourne la face du haut (U) avec ton index droit pour positionner l'arÃªte</li>
                <li>Cette technique dÃ©veloppe de bonnes habitudes pour la suite !</li>
            </ul>
        </div>

        <div class="alert alert-info mt-3 mb-0">
            <strong>ğŸ’¡ Comment positionner l'arÃªte avant de faire R2 :</strong>
            <ol class="mb-0 mt-2">
                <li>Regarde la couleur du <strong>cÃ´tÃ©</strong> de l'arÃªte blanche (pas le blanc !)</li>
                <li>Tourne U (la face du haut) jusqu'Ã  ce que cette couleur soit <strong>au-dessus du centre de la mÃªme couleur Ã  droite</strong></li>
                <li>Fais <strong>R2</strong> avec ta main droite - l'arÃªte descend au bon endroit !</li>
            </ol>
        </div>
    </div>

    <!-- Section Conseils -->
    <div class="card p-4 mb-4">
        <h3 class="brand-green">ğŸ’¡ Conseils utiles</h3>
        <ul class="mt-3">
            <li>
                <strong>Tiens le cube avec ta main gauche</strong> pendant toute l'Ã©tape.
                Ta main droite est libre pour faire R2 rapidement !
            </li>
            <li>
                <strong>Travaille une arÃªte Ã  la fois.</strong> Ne te prÃ©cipite pas !
            </li>
            <li>
                <strong>VÃ©rifie toujours les couleurs</strong> avant de faire R2.
                Est-ce que la couleur du cÃ´tÃ© de l'arÃªte est au-dessus du centre de droite de la mÃªme couleur ?
            </li>
            <li>
                Si tu fais une erreur, pas de problÃ¨me ! Refais simplement R2 pour remonter l'arÃªte
                et recommence.
            </li>
            <li>
                <strong>Pratique R2 !</strong> C'est un mouvement que tu vas utiliser beaucoup.
                Essaie de le faire vite et avec fluiditÃ©.
            </li>
            <li>
                <strong>Une fois la croix terminÃ©e,</strong> retourne ton cube pour voir la croix blanche
                en bas. C'est la base de ton cube rÃ©solu !
            </li>
        </ul>
    </div>

    <!-- Bouton de navigation -->
    <div class="text-center">
        <a href="{% url 'francontcube:daisy' %}" class="btn btn-outline-primary">
            â† Retour : La marguerite
        </a>
        <a href="{% url 'francontcube:method_cubienewbie' %}" class="btn btn-outline-secondary ms-2">
            Vue d'ensemble
        </a>
        <a href="{% url 'francontcube:bottom_corners' %}" class="btn btn-success ms-2">
            Ã‰tape suivante : Les coins blancs â†’
        </a>
    </div>
</div>

<!-- Styles CSS pour les cubes -->
<style>
/* Cubes rÃ©duits */
.cube-small svg {
    max-width: 275px;
    height: auto;
}

/* Sur mobile, garder les cubes plus petits */
@media (max-width: 768px) {
    .cube-small svg {
        max-width: 200px;
    }

    #cube-goal svg,
    #cube-progress svg {
        max-width: 350px;
    }
}
</style>

<!-- Script d'initialisation de la page -->
<script type="module">
  import { renderCube } from "{% static 'cube/js/cube_renderer.js' %}";

  function mountCube(containerId, state) {
    const container = document.getElementById(containerId);
    container.innerHTML = ''; // Clear any existing content

    // If state is missing, show a placeholder
    if (!state) {
      container.innerHTML = `
        <div class="alert alert-secondary text-center py-4">
          <i class="bi bi-cube text-muted" style="font-size: 3rem;"></i>
          <p class="mb-0 mt-2 text-muted">Cube state not available</p>
          <small class="text-muted">Create the CubeState in your admin tool</small>
        </div>
      `;
      return;
    }

    const template = document.getElementById("cube-template");
    const clone = template.content.cloneNode(true);
    container.appendChild(clone);

    const svg = container.querySelector("svg");
    renderCube(svg, state);
  }

  // Store progress states for easy access (filter out nulls)
  const progressStates = {{ progress_states|safe }};

  // Messages d'encouragement pour chaque Ã©tape
  const messages = [
    "Commence avec la marguerite ! ğŸŒ¼",
    "On fait tourner la couche du haut (U) pour aligner le sous-petal avec le centre de la face de droite",
    "On fait R2.  Le petale sera maintenant Ã  sa place dans la couche du bas",
    "On tourne le cube vers la droite ou vers la gauche.  Assures-toi d'avoir le centre jaune en haut",
    "On rÃ©pÃ¨te pour toutes les pÃ©tales blancs du haut"
  ];

  // Make updateCrossProgress globally accessible
  window.updateCrossProgress = function(numEdges) {
    // Update cube visualization
    mountCube('cube-progress', progressStates[numEdges]);

    // Feedback visuel sur les boutons
    const buttons = document.querySelectorAll('.btn-group button');
    buttons.forEach((btn, index) => {
      btn.classList.remove('active');
      if (index === numEdges) {
        btn.classList.add('active');
      }
    });

    // Afficher le message d'encouragement
    const messageBox = document.getElementById('cross-progress-message');
    const messageText = messageBox.querySelector('p');
    messageText.textContent = messages[numEdges];
    messageBox.style.display = 'block';

    // Animation simple
    messageBox.classList.add('animate__animated', 'animate__fadeIn');
    setTimeout(() => {
      messageBox.classList.remove('animate__animated', 'animate__fadeIn');
    }, 1000);
  };

  document.addEventListener("DOMContentLoaded", () => {
    // Mount all static cubes
    mountCube("cube-goal", {{ goal_state|safe }});
    mountCube("cube-before", {{ before_state|safe }});
    mountCube("cube-after", {{ after_state|safe }});
    mountCube("cube-wrong", {{ wrong_state|safe }});
    mountCube("cube-correct", {{ correct_state|safe }});

    // Initialize progress cube with first state
    updateCrossProgress(0);
  });
</script>

{% endblock %}