{% extends "francontcube/partials/base.html" %}
{% load static %}

{% block title %}La deuxiÃ¨me couche â€” Francontcube{% endblock %}

{% block content %}
<div class="container py-5">

    <!-- Titre principal -->
    <div class="text-center mb-5">
        <h1 class="hero-title">
            Ã‰tape 3 : <span class="brand-green">La deuxiÃ¨me couche</span>
        </h1>
        <p class="lead text-muted">
            Placer les 4 arÃªtes du milieu pour complÃ©ter les deux premiÃ¨res couches du cube.
        </p>
    </div>

    <!-- Charger le template SVG (cachÃ©) -->
    {% include "cube/partials/_cube_svg.html" %}

    <!-- Warning for missing cube states (only shown if any are missing) -->
    {% if missing_slugs %}
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <h4 class="alert-heading">âš ï¸ Missing Cube States</h4>
        <p>The following CubeState objects need to be created in the database:</p>
        <ul class="mb-0">
            {% for slug in missing_slugs %}
            <li><code>{{ slug }}</code></li>
            {% endfor %}
        </ul>
        <hr>
        <p class="mb-0 small">Use your cube state creation tool to add these. The page will display placeholders until they're created.</p>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <!-- Section Objectif -->
    <div class="card p-4 mb-4">
        <h3 class="brand-green">ğŸ¯ Objectif</h3>
        <p>
            Placer les 4 arÃªtes de la deuxiÃ¨me couche (le milieu du cube). 
            Ces arÃªtes n'ont <strong>PAS de jaune</strong> - elles vont entre la face blanche du bas et la face jaune du haut.
        </p>

        <div class="row mt-3">

            <div class="col-md-6 text-center mb-3">
                <h5>AprÃ¨s : Deux couches complÃ¨tes</h5>
                <div id="cube-goal" class="cube-small"></div>
                <p><small class="text-muted">Les 4 arÃªtes du milieu sont en place!</small></p>
            </div>
        </div>
    </div>

    <!-- Section Identifier l'arÃªte -->
    <div class="card p-4 mb-4">
        <h3 class="brand-green">ğŸ” Ã‰tape 1 : Trouve la bonne arÃªte</h3>
        <p>
            Cherche une arÃªte dans la couche du <strong>haut</strong> qui n'a <strong>pas de jaune</strong>.
        </p>
        
        <div class="alert alert-info">
            <strong>ğŸ’¡ Comment identifier l'arÃªte :</strong>
            <ol class="mb-0 mt-2">
                <li>Regarde les arÃªtes sur la face du haut (U)</li>
                <li>Trouve une arÃªte <strong>sans jaune</strong> (elle a 2 autres couleurs)</li>
                <li>Cette arÃªte va dans la deuxiÃ¨me couche!</li>
                <li>Si toutes les arÃªtes du haut ont du jaune, tu devras d'abord sortir une arÃªte coincÃ©e dans le milieu</li>
            </ol>
        </div>

        <div class="alert alert-warning mt-3">
            <strong>âš ï¸ ArÃªte avec du jaune :</strong>
            <div class="row mt-2 align-items-center">
                <div class="col-md-4 text-center">
                    <div id="cube-edge-yellow" class="cube-case"></div>
                </div>
                <div class="col-md-8">
                    <p class="mb-0">
                        Si l'arÃªte a du <strong>jaune</strong>, elle appartient Ã  la derniÃ¨re couche. 
                        Ne la touche pas pour l'instant - trouve une autre arÃªte sans jaune!
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Section Algorithmes -->
    <div class="card p-4 mb-4">
        <h3 class="brand-green">ğŸ”„ Ã‰tape 2 : InsÃ¨re l'arÃªte avec l'algorithme</h3>
        <p>Il y a deux cas selon l'orientation de l'arÃªte. Les deux algorithmes sont similaires!</p>

        <!-- Cas 1: ArÃªte va en ARRIERE -->
        <div class="border rounded p-3 mb-3 bg-light">
            <h5 class="text-success">âœ… Cas 1 : L'arÃªte va vers la gauche</h5>
            <p>La couleur qui correspond au centre de devant est <strong>sur la face avant</strong>.</p>
            
            <div class="row align-items-center">
                <div class="col-md-4 text-center">
                    <div id="cube-case-front" class="cube-case"></div>
                    <p class="mt-2"><small>Position de dÃ©part</small></p>
                    </div>
                    <div class="col-md-8">
                        <div class="text-center p-3 bg-white rounded border border-success border-2">
                            <div class="d-flex justify-content-center align-items-center gap-2 my-2 flex-wrap">
                                <svg class="move-icon"><use href="#U-prime"/></svg>
                                <svg class="move-icon"><use href="#F-prime"/></svg>
                                <svg class="move-icon"><use href="#U"/></svg>
                                <svg class="move-icon"><use href="#F"/></svg>
                                <svg class="move-icon"><use href="#U"/></svg>
                                <svg class="move-icon"><use href="#R"/></svg>
                                <svg class="move-icon"><use href="#U-prime"/></svg>
                                <svg class="move-icon"><use href="#R-prime"/></svg>
                        </div>
                            <p class="mt-2 mb-0"><small>Tenir le cube avec le pouce droit sur la face de droite pour les 4 premiers mouvements ensuite reprendre la position orignale pour les 4 derniers</small></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cas 2: ArÃªte va en arriere -->
        <div class="border rounded p-3 bg-light">
            <h5 class="text-primary">âœ… Cas 2 : L'arÃªte va vers la droite</h5>
            <p>La couleur qui correspond au centre de devant est <strong>sur la face de droite</strong>.</p>
            
            <div class="row align-items-center">
                <div class="col-md-4 text-center">
                    <div id="cube-case-back" class="cube-case"></div>
                    <p class="mt-2"><small>Position de dÃ©part</small></p>
                </div>
                <div class="col-md-8">
                    
                    <div class="text-center p-3 bg-white rounded border border-success border-2">
                            <div class="d-flex justify-content-center align-items-center gap-2 my-2 flex-wrap">
                            <svg class="move-icon"><use href="#U"/></svg>
                            <svg class="move-icon"><use href="#R"/></svg>
                            <svg class="move-icon"><use href="#U-prime"/></svg>
                            <svg class="move-icon"><use href="#R-prime"/></svg>
                            <svg class="move-icon"><use href="#U-prime"/></svg>
                            <svg class="move-icon"><use href="#F-prime"/></svg>
                            <svg class="move-icon"><use href="#U"/></svg>
                            <svg class="move-icon"><use href="#F"/></svg>
                            
                        </div>
                        
                        <p class="mt-2 mb-0"><small>L'arÃªte descend dans le slot de gauche</small></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section Cas spÃ©cial -->
    <div class="card p-4 mb-4 border-warning">
        <h3 class="brand-green">âš ï¸ Cas spÃ©cial : ArÃªte coincÃ©e dans le milieu</h3>
        <p>
            Si une arÃªte est <strong>dÃ©jÃ  dans la deuxiÃ¨me couche mais mal placÃ©e ou mal orientÃ©e</strong>, 
            tu dois d'abord la sortir.
        </p>

        <div class="row mt-3 align-items-center">
            <div class="col-md-4 text-center">
                <div id="cube-edge-stuck" class="cube-case"></div>
                <p class="mt-2"><small>ArÃªte mal placÃ©e dans le milieu</small></p>
            </div>
            <div class="col-md-8">
                <div class="bg-white p-3 rounded border border-warning border-2">
                    <h5>Solution :</h5>
                    <ol class="mb-0">
                        <li>Place n'importe quelle autre arÃªte au-dessus de la position coincÃ©e</li>
                        <li>Fais un des deux algorithmes (droite ou gauche)</li>
                        <li>L'arÃªte coincÃ©e va sortir et monter dans la couche du haut</li>
                        <li>Maintenant tu peux la rÃ©insÃ©rer au bon endroit!</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Section Technique -->
    <div class="card p-4 mb-4 border-success">
        <h3 class="brand-green">âœ‹ Technique de prise</h3>
        <div class="alert alert-success">
            <strong>Pour l'algorithme de DROITE (U R U' R' U' F' U F) :</strong>
            <ul class="mb-0 mt-2">
                <li>Main gauche : tiens le cube fermement</li>
                <li>Main droite : fait tous les mouvements R et U</li>
                <li>Index gauche : fait les mouvements F et F'</li>
                <li><strong>Pratique lentement, puis accÃ©lÃ¨re progressivement</strong></li>
            </ul>
        </div>
        
        <div class="alert alert-info mb-0">
            <strong>Pour l'algorithme de GAUCHE (U' L' U L U F U' F') :</strong>
            <ul class="mb-0 mt-2">
                <li>Main droite : tiens le cube</li>
                <li>Main gauche : fait les mouvements L et U</li>
                <li>Index gauche : fait aussi les mouvements F</li>
            </ul>
        </div>
    </div>

    <!-- Section Processus complet -->
    <div class="card p-4 mb-4">
        <h3 class="brand-green">ğŸ“‹ Processus complet pour chaque arÃªte</h3>
        <ol>
            <li class="mb-2">
                <strong>Trouve une arÃªte sans jaune</strong> dans la couche du haut
            </li>
            <li class="mb-2">
                <strong>Identifie oÃ¹ elle va</strong> : Regarde les deux couleurs de l'arÃªte. 
                Elle va entre les deux centres de ces couleurs
            </li>
            <li class="mb-2">
                <strong>Positionne le cube</strong> : Tourne tout le cube pour mettre un des centres 
                devant toi (celui qui correspond Ã  la couleur sur la face avant de l'arÃªte)
            </li>
            <li class="mb-2">
                <strong>AmÃ¨ne l'arÃªte au bon endroit</strong> : Tourne U jusqu'Ã  ce que l'arÃªte 
                soit juste au-dessus de sa place
            </li>
            <li class="mb-2">
                <strong>DÃ©termine le cas</strong> : 
                <ul>
                    <li>Couleur devant â†’ Cas 1 (droite) : <code>U R U' R' U' F' U F</code></li>
                    <li>Couleur Ã  droite â†’ Cas 2 (gauche) : <code>U' L' U L U F U' F'</code></li>
                </ul>
            </li>
            <li class="mb-2">
                <strong>RÃ©pÃ¨te pour les 3 autres arÃªtes!</strong>
            </li>
        </ol>
    </div>

    <!-- Section Conseils -->
    <div class="card p-4 mb-4">
        <h3 class="brand-green">ğŸ’¡ Conseils utiles</h3>
        <ul class="mt-3">
            <li>
                <strong>Ces algorithmes sont plus longs</strong> - ne te dÃ©courage pas! 
                Avec de la pratique, ils deviendront automatiques.
            </li>
            <li>
                <strong>DÃ©coupe les algorithmes en morceaux.</strong> Apprends <code>U R U' R'</code> 
                d'abord, puis ajoute <code>U' F' U F</code>.
            </li>
            <li>
                <strong>Ne panique pas si tu dÃ©fais la premiÃ¨re couche!</strong> Les algorithmes 
                la remettent automatiquement en place.
            </li>
            <li>
                <strong>Il n'y a que 4 arÃªtes Ã  placer.</strong> Une fois qu'elles sont toutes en place, 
                tu as complÃ©tÃ© les deux tiers du cube! ğŸ‰
            </li>
            <li>
                <strong>Astuce :</strong> Si tu n'es pas sÃ»r de l'orientation, essaie un algorithme. 
                Si l'arÃªte ne va pas au bon endroit, fais simplement l'autre algorithme.
            </li>
        </ul>
    </div>

    <!-- Bouton de navigation -->
    <div class="text-center">
        <a href="{% url 'francontcube:beginner_bottom_corners' %}" class="btn btn-outline-primary">
            â† Retour : Les coins blancs
        </a>
        <a href="{% url 'francontcube:method_cubienewbie' %}" class="btn btn-outline-secondary ms-2">
            Vue d'ensemble
        </a>
        <a href="{% url 'francontcube:beginner_yellow_cross' %}" class="btn btn-success ms-2">
            Ã‰tape suivante : La croix jaune â†’
        </a>
    </div>
</div>

<!-- Styles CSS pour les cubes -->
<style>
.cube-small svg {
    max-width: 275px;
    height: auto;
}

.move-icon { 
    width: 56px; 
    height: 75px; 
}


.cube-case svg {
    max-width: 220px;
    height: auto;
}

@media (max-width: 768px) {
    .cube-small svg {
        max-width: 200px;
    }
    
    .cube-case svg {
        max-width: 180px;
    }
}
</style>

<!-- Script d'initialisation de la page -->
<script type="module">
  import { renderCube } from "{% static 'cube/js/cube_renderer.js' %}";

  function mountCube(containerId, state) {
    const container = document.getElementById(containerId);
    container.innerHTML = ''; // Clear any existing content
    
    // If state is missing, show a placeholder
    if (!state) {
      container.innerHTML = `
        <div class="alert alert-secondary text-center py-4">
          <i class="bi bi-cube text-muted" style="font-size: 3rem;"></i>
          <p class="mb-0 mt-2 text-muted">Cube state not available</p>
          <small class="text-muted">Create the CubeState in your admin tool</small>
        </div>
      `;
      return;
    }
    
    const template = document.getElementById("cube-template");
    const clone = template.content.cloneNode(true);
    container.appendChild(clone);

    const svg = container.querySelector("svg");
    renderCube(svg, state);
  }

  document.addEventListener("DOMContentLoaded", () => {
    // Mount all cubes
    mountCube("cube-goal", {{ goal_state|safe }});
    
    // Algorithm cases
    mountCube("cube-case-back", {{ case_back_state|safe }});
    mountCube("cube-case-front", {{ case_front_state|safe }});
    
    // Special cases
    mountCube("cube-edge-yellow", {{ edge_yellow_state|safe }});
    mountCube("cube-edge-stuck", {{ edge_stuck_state|safe }});
  });
</script>

{% endblock %}