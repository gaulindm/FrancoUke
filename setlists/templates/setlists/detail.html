{% extends 'uke4ia/base.html' %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">{{ setlist.name }}</h1>

    <div class="btn-group">
      <a href="{% url 'board:full_board' %}?event={{ setlist.event.id }}" 
         class="btn btn-outline-primary btn-sm">
        ğŸ¤ View {{ setlist.event.title }}
      </a>

      {% if can_edit %}
        <a href="{% url 'setlists:setlist_builder' setlist.id %}" 
           class="btn btn-sm btn-outline-secondary">
          âœï¸ Edit Setlist
        </a>
      {% endif %}
    </div>
  </div>

  {% if event %}
    <div class="mb-3 p-2 border rounded bg-light">
      <p class="mb-1 text-muted small">
        ğŸ“… {{ event.event_date|date:"D, M d, Y" }}
        {% if event.start_time %}
          at {{ event.start_time|time:"H:i" }}
          {% if event.end_time %}
            â€“ {{ event.end_time|time:"H:i" }}
          {% endif %}
        {% endif %}
      </p>
      {% if event.location %}
        <p class="mb-0 text-muted small">ğŸ“ {{ event.location }}</p>
      {% endif %}
    </div>
  {% endif %}

  <!-- ğŸµ SONG LIST -->
  <ol class="list-group list-group-numbered">
    {% for item in songs %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div class="flex-grow-1 ms-3">
          <strong>{{ item.song.songTitle }}</strong>

          {% with item.song.rehearsal_notes.count as note_count %}
            {% if note_count > 0 %}
              <button type="button" 
                      class="btn btn-sm btn-outline-secondary ms-2"
                      data-bs-toggle="modal" 
                      data-bs-target="#notesModal{{ item.song.id }}"
                      title="View rehearsal notes for {{ item.song.songTitle }}">
                ğŸ“ {{ note_count }} note{{ note_count|pluralize }}
              </button>
            {% endif %}
          {% endwith %}
        </div>

        <a href="{% url 'songbook:score_view' item.song.pk %}" 
           class="btn btn-sm btn-outline-primary"
           target="_blank"
           rel="noopener noreferrer">
          ğŸ¼ View
        </a>
      </li>
    {% empty %}
      <li class="list-group-item text-muted">No songs in this setlist yet.</li>
    {% endfor %}
  </ol>

  {% if songs %}
    <div class="mt-4 text-center">
      <a href="{% url 'setlists:setlist_teleprompter' setlist.id songs.0.order %}" 
         class="btn btn-primary btn-lg">
        ğŸ¤ Start Teleprompter
      </a>
    </div>
  {% endif %}
</div>

<!-- ğŸ“ REHEARSAL NOTES MODALS -->
{% for item in songs %}
  {% with item.song.rehearsal_notes.all as notes %}
    {% if notes %}
      <div class="modal fade" id="notesModal{{ item.song.id }}" tabindex="-1" 
           aria-labelledby="notesModalLabel{{ item.song.id }}" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="notesModalLabel{{ item.song.id }}">
                ğŸ“ Rehearsal Notes: {{ item.song.songTitle }}
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              {% for note in notes %}
                <div class="card mb-3">
                  <div class="card-header bg-light">
                    <small class="text-muted">
                      {{ note.date|date:"D, M d, Y" }}
                      {% if note.event %}
                        â€¢ {{ note.event.title }}
                      {% endif %}
                    </small>
                  </div>
                  <div class="card-body">
                    {{ note.notes|safe }}
                  </div>
                </div>
              {% endfor %}
            </div>
            <div class="modal-footer">
              <a href="{% url 'board:song_rehearsal_history' item.song.id %}" 
                 class="btn btn-sm btn-outline-primary"
                 target="_blank">
                View Full History
              </a>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  {% endwith %}
{% endfor %}

<style>
  .list-group-item {
    padding: 0.45rem 0.7rem;
  }

  .list-group-numbered > li::marker {
    content: counter(list-item) ".    ";
    font-weight: bold;
  }

  .list-group-numbered {
    padding-left: 1.2rem;
  }
</style>
{% endblock %}