{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ current.song.songTitle }}</title>
  <link rel="stylesheet" href="{% static 'songbook/css/teleprompter.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">


<!-- ‚úÖ Embedded teleprompter configuration -->
<script id="teleprompter-config" type="application/json">
  {
    "initialScrollSpeed": {{ initial_scroll_speed|default:40 }},
    "userPreferences": {{ user_preferences_json|safe }}
  }
  </script>

<!-- Diagram renderer -->
  <script src="{% static 'songbook/js/chord_diagrams.js' %}"></script>

  <!-- Teleprompter engine -->
  <script src="{% static 'songbook/js/teleprompter.js' %}"></script>

  <style>
    .song-title {
      font-size: 1rem;
      font-weight: bold;
    }
    .nav-btn {
      background: transparent;
      border: none;
      font-size: 1.8rem;
      cursor: pointer;
      color: var(--fg);
    }
    .nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    select#song-selector {
      font-size: 0.9rem;
      padding: 2px 6px;
    }


    .touch-zone {
      position: fixed;
      top: 0;
      width: 50%;
      height: 100%;
      z-index: 10; /* üîΩ lower than UI controls */
      pointer-events: auto;
      background: transparent;
    }


    .touch-left {
      left: 0;
    }

    .touch-right {
      right: 0;
    }

  


/* üß© Make sure header controls always get clicks */
.controls,
.speed-controls,
.nav-btn {
  position: relative;
  z-index: 1001; /* above tap zones */
  pointer-events: auto; /* always interactive */
}

/* ===== METADATA TABLE STYLES ===== */
.metadata-table {
  width: 100%;
  max-width: 100%;
  margin: 0 auto 30px auto;
  border-collapse: collapse;
  border: 2px solid #ff6b6b;
}

.metadata-table td {
  padding: 8px 10px;
  vertical-align: middle;
  text-align: center;
  border: 1px solid #74C0fc;
}

/* Left column (time signature, 1st note, count in) */
.metadata-table td:first-child {
  width: 250px;
  font-size: 0.9em;
  color: var(--muted);
}

/* Center column (title, songwriter, artist) */
.metadata-table td:nth-child(2) {
  width: auto;
  font-weight: bold;
}

/* Right column (instructions) */
.metadata-table td:last-child {
  width: 250px;
  font-size: 0.85em;
  color: var(--muted);
  font-style: italic;
}

/* First row special styling */
.metadata-table tr:first-child td:first-child,
.metadata-table tr:first-child td:last-child {
  vertical-align: bottom;
}

.metadata-table tr:first-child td:nth-child(2) {
  font-size: 1.3em;
  color: var(--fg);
}

/* Songwriter row */
.metadata-table tr:nth-child(2) td:nth-child(2) {
  font-size: 1em;
  color: #ccc;
  font-weight: normal;
}

/* Artist/Recording row */
.metadata-table tr:nth-child(3) td:nth-child(2) {
  font-size: 0.95em;
  color: var(--muted);
  font-weight: normal;
}

/* Mobile responsive */
@media (max-width: 800px) {
  .metadata-table {
    font-size: 0.8em;
  }
  
  .metadata-table td:first-child,
  .metadata-table td:last-child {
    width: 100px;
    font-size: 0.75em;
  }
  
  .metadata-table tr:first-child td:nth-child(2) {
    font-size: 1.1em;
  }
}

  </style>
</head>
<body>

  <!-- Controls -->
  <div class="controls">

    <!-- Left -->
    <div class="left">
      <span class="song-title">
        Setlist {{ setlist.id }} ‚Äì {{ setlist.name }}
      </span>
      <button id="toggle-chords">Hide Chords</button>
    </div>

    <!-- Center -->
    <div class="center">
      <button id="scroll-toggle">‚ñ∂Ô∏è Start</button>
      <div class="control-inline">
        <button id="speed-down">-</button>
        <span id="scroll-speed-display">{{ song.scroll_speed|default:40 }} px/s</span>
        <button id="speed-up">+</button>
        
      </div>
      



      <button id="scroll-reset">‚èπ Reset</button>
    </div>

    <!-- Right -->
    <div class="right">
      {% if prev_song %}
        <button id="prev-song-btn" class="nav-btn"
                onclick="window.location.href='{% url 'setlists:setlist_teleprompter' setlist.id prev_song.order %}'">
          ‚¨ÖÔ∏è
        </button>
      {% else %}
        <button id="prev-song-btn" class="nav-btn" disabled>‚¨ÖÔ∏è</button>
      {% endif %}
    
      {% if next_song %}
        <button id="next-song-btn" class="nav-btn"
                onclick="window.location.href='{% url 'setlists:setlist_teleprompter' setlist.id next_song.order %}'">
          ‚û°Ô∏è
        </button>
      {% else %}
        <button id="next-song-btn" class="nav-btn" disabled>‚û°Ô∏è</button>
      {% endif %}
    </div>
    
    
    
  </div>

  <!-- Lyrics -->
  <div class="tp-main">
    <div class="lyrics-container">
      <div class="lyrics">
        
        <!-- ‚úÖ NEW: Metadata Table -->
        <table class="metadata-table">
          <tr>
            <td>{{ metadata.timeSignature|default:"" }}</td>
            <td>{{ song.songTitle|default:"Untitled Song" }}</td>
            <td>{% if has_slash_chord %}(/ = one strum){% endif %}</td>
          </tr>
          <tr>
            <td>
              {% with first_note=metadata.1stnote %}
                {% if first_note %}1st vocal note: {{ first_note }}{% endif %}
              {% endwith %}
            </td>
            <td>{{ metadata.songwriter|default:"" }}</td>
            <td>{{ metadata.short_instruction_1|default:"" }}</td>
          </tr>
          <tr>
            <td>
              {% with count=metadata.count_in %}
                {% if count %}Count in: {{ count }}{% endif %}
              {% endwith %}
            </td>
            <td>
              {% if metadata.artist %}
                {{ metadata.artist }}{% if metadata.year %} ({{ metadata.year }}){% endif %}
              {% endif %}
            </td>
            <td>{{ metadata.short_instruction_2|default:"" }}</td>
          </tr>
        </table>

        <!-- ‚úÖ Color markup is now processed in the view and safe to render -->
        {{ lyrics_with_chords|safe }}
      </div>
    </div>
  </div>



  <!-- Touch zones for mobile nav (keep or remove if using swipe gestures only) -->
  {% if prev_song %}
  <div class="touch-zone touch-left"
       onclick="window.location.href='{% url 'setlists:setlist_teleprompter' setlist.id prev_song.order %}'"></div>
  {% endif %}
  {% if next_song %}
  <div class="touch-zone touch-right"
       onclick="window.location.href='{% url 'setlists:setlist_teleprompter' setlist.id next_song.order %}'"></div>
  {% endif %}

  <!-- Chords JSON -->
  <script id="chords-data" type="application/json">
    {{ relevant_chords_json|safe }}
  </script>



  <!-- Chord Section -->
  <div id="chord-section">
    <div id="chord-diagrams"></div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const prevBtn = document.getElementById("prev-song-btn");
      const nextBtn = document.getElementById("next-song-btn");
    
      const leftZone = document.querySelector(".touch-left");
      const rightZone = document.querySelector(".touch-right");
    
      // Simple tap
      leftZone?.addEventListener("click", () => {
        if (prevBtn && !prevBtn.disabled) prevBtn.click();
      });
    
      rightZone?.addEventListener("click", () => {
        if (nextBtn && !nextBtn.disabled) nextBtn.click();
      });
    
      // Optional: swipe gesture support (for mobile smoothness)
      let startX = 0;
      document.addEventListener("touchstart", (e) => startX = e.touches[0].clientX);
      document.addEventListener("touchend", (e) => {
        const diff = e.changedTouches[0].clientX - startX;
        if (diff > 50 && prevBtn && !prevBtn.disabled) prevBtn.click();  // Swipe right ‚Üí previous
        else if (diff < -50 && nextBtn && !nextBtn.disabled) nextBtn.click(); // Swipe left ‚Üí next
      });
    });
    </script>
    <script>
      // üé∏ iRig BlueTurn Support - Synced with auto-scroll
      document.addEventListener("DOMContentLoaded", () => {
        const lyricsContainer = document.querySelector(".lyrics-container");
        const scrollAmount = 150;
        
        const indicator = document.createElement("div");
        indicator.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0,0,0,0.8);
          color: white;
          padding: 20px 40px;
          border-radius: 10px;
          font-size: 24px;
          z-index: 9999;
          display: none;
          pointer-events: none;
        `;
        document.body.appendChild(indicator);
        
        function showIndicator(text) {
          indicator.textContent = text;
          indicator.style.display = "block";
          setTimeout(() => indicator.style.display = "none", 500);
        }
        
        document.addEventListener("keydown", (e) => {
          if (["ArrowLeft", "ArrowRight", "PageUp", "PageDown"].includes(e.key)) {
            e.preventDefault();
          }
    
          if (!lyricsContainer) return;
    
          switch(e.key) {
            case "ArrowLeft":
            case "PageUp":
              // Update both the DOM and internal scroll position
              if (typeof window.scrollPos !== 'undefined') {
                window.scrollPos = Math.max(0, window.scrollPos - scrollAmount);
                lyricsContainer.scrollTop = window.scrollPos;
              } else {
                lyricsContainer.scrollTop -= scrollAmount;
              }
              showIndicator("‚¨ÜÔ∏è");
              console.log("‚¨ÜÔ∏è BlueTurn: Scrolled up");
              break;
              
            case "ArrowRight":
            case "PageDown":
              // Update both the DOM and internal scroll position
              if (typeof window.scrollPos !== 'undefined') {
                const maxScroll = lyricsContainer.scrollHeight - lyricsContainer.clientHeight;
                window.scrollPos = Math.min(maxScroll, window.scrollPos + scrollAmount);
                lyricsContainer.scrollTop = window.scrollPos;
              } else {
                lyricsContainer.scrollTop += scrollAmount;
              }
              showIndicator("‚¨áÔ∏è");
              console.log("‚¨áÔ∏è BlueTurn: Scrolled down");
              break;
          }
        });
    
        console.log("üé∏ iRig BlueTurn enabled (synced with auto-scroll)");
      });
    </script>

      
</body>
</html>