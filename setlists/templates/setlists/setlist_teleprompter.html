{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ current.song.songTitle }}</title>
  <link rel="stylesheet" href="{% static 'songbook/css/teleprompter.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- User Preferences -->
  {% if user.is_authenticated and user.userpreference %}
  <script>
    window.userPreferences = {
      instrument: "{{ user.userpreference.primary_instrument }}",
      isLefty: {{ user.userpreference.is_lefty|yesno:"true,false" }},
      showAlternate: {{ user.userpreference.is_printing_alternate_chord|yesno:"true,false" }}
    };
  </script>
  {% else %}
  <script>
    window.userPreferences = { instrument: "ukulele", isLefty: false, showAlternate: false };
  </script>
  {% endif %}

  <script src="{% static 'songbook/js/chord_diagrams.js' %}"></script>

  <script>
    window.initialScrollSpeed = {{ song.scroll_speed|default:40 }};
    window.SONG = { id: "{{ song.id }}", title: "{{ song.songTitle|escapejs }}" };
  </script>



  <script src="{% static 'songbook/js/teleprompter.js' %}"></script>

  <style>
    .song-title {
      font-size: 1rem;
      font-weight: bold;
    }
    .nav-btn {
      background: transparent;
      border: none;
      font-size: 1.8rem;
      cursor: pointer;
      color: var(--fg);
    }
    .nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    select#song-selector {
      font-size: 0.9rem;
      padding: 2px 6px;
    }
    /* Chords hidden state */
    #chord-section.hidden {
      display: none;
    }
  </style>
</head>
<body>

  <!-- Controls -->
  <div class="controls">

    <!-- Left -->
    <div class="left">
      <span class="song-title">
        Setlist {{ setlist.id }} ‚Äì {{ setlist.name }}
      </span>
      <button id="toggle-chords">Hide Chords</button>
    </div>

    <!-- Center -->
    <div class="center">
      <button id="scroll-toggle">‚ñ∂Ô∏è Start</button>
      <div class="control-inline">
        <button id="speed-decrease">-</button>
        <span id="scroll-speed-display">{{ song.scroll_speed|default:40 }} px/s</span>
        <button id="speed-increase">+</button>
        <button id="speed-save">üíæ Save</button>
      </div>
      



      <button id="scroll-reset">‚èπ Reset</button>
    </div>

    <!-- Right -->
    <div class="right">
      {% if prev_song %}
        <button class="nav-btn"
                onclick="window.location.href='{% url 'setlists:setlist_teleprompter' setlist.id prev_song.order %}'">
          ‚¨ÖÔ∏è
        </button>
      {% else %}
        <button class="nav-btn" disabled>‚¨ÖÔ∏è</button>
      {% endif %}
    
      {% if next_song %}
        <button class="nav-btn"
                onclick="window.location.href='{% url 'setlists:setlist_teleprompter' setlist.id next_song.order %}'">
          ‚û°Ô∏è
        </button>
      {% else %}
        <button class="nav-btn" disabled>‚û°Ô∏è</button>
      {% endif %}
    </div>
    
  </div>

  <!-- Lyrics -->
  <div class="tp-main">
    <div class="lyrics-container">
      <div class="lyrics">
        <div class="metadata">
          <h1>{{ song.songTitle }}</h1>
          {% if metadata.songwriter %}
            <div class="songwriter">{{ metadata.songwriter }}</div>
          {% endif %}
          {% if metadata.artist %}
            <div class="recording">
              {{ metadata.artist }}{% if metadata.year %} ({{ metadata.year }}){% endif %}
            </div>
          {% endif %}
        </div>

        {{ lyrics_with_chords|safe }}
      </div>
    </div>
  </div>

  <!-- Touch zones for mobile nav (keep or remove if using swipe gestures only) -->
  {% if prev_song %}
  <div class="touch-zone touch-left"
       onclick="window.location.href='{% url 'setlists:setlist_teleprompter' setlist.id prev_song.order %}'"></div>
  {% endif %}
  {% if next_song %}
  <div class="touch-zone touch-right"
       onclick="window.location.href='{% url 'setlists:setlist_teleprompter' setlist.id next_song.order %}'"></div>
  {% endif %}

  <!-- Chords JSON -->
  <script id="chords-data" type="application/json">
    {{ relevant_chords_json|safe }}
  </script>

  <!-- Keyboard nav + dropdown -->
  <script>
    document.addEventListener("keydown", function(event) {
      if (event.key === "ArrowLeft") {
        {% if prev_song %}
          window.location.href = "{% url 'setlists:setlist_teleprompter' setlist.id prev_song.order %}";
        {% endif %}
      } else if (event.key === "ArrowRight") {
        {% if next_song %}
          window.location.href = "{% url 'setlists:setlist_teleprompter' setlist.id next_song.order %}";
        {% endif %}
      }
    });

 
  </script>

  <!-- Chord Section -->
  <div id="chord-section">
    <div id="chord-diagrams"></div>
  </div>

  <!-- Gesture controls -->
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const chordSection = document.getElementById("chord-section");
    const lyricsContainer = document.querySelector(".lyrics-container");

    let scrollActive = false;
    let autoScrollInterval = null;
    let lastTapTime = 0;

    function startScrolling() {
      if (scrollActive) return;
      scrollActive = true;
      document.body.classList.add("scrolling");
      hideChords(); // auto-hide chords once scrolling starts

      const speedInput = document.getElementById("scroll-speed");
      autoScrollInterval = setInterval(() => {
        lyricsContainer.scrollTop += parseInt(speedInput.value, 10);
      }, 200);
    }

    function stopScrolling() {
      scrollActive = false;
      document.body.classList.remove("scolling");
      clearInterval(autoScrollInterval);
    }

    function toggleScrolling() {
      if (scrollActive) {
        stopScrolling();
      } else {
        startScrolling();
      }
    }

    function hideChords() {
      chordSection.classList.add("hidden");
    }

    function toggleChords() {
      chordSection.classList.toggle("hidden");
    }

    // Swipe + Tap detection
    let touchStartX = 0;
    let touchStartY = 0;

    document.addEventListener("touchstart", (e) => {
      const touch = e.changedTouches[0];
      touchStartX = touch.pageX;
      touchStartY = touch.pageY;
    });

    document.addEventListener("touchend", (e) => {
      const touch = e.changedTouches[0];
      const dx = touch.pageX - touchStartX;
      const dy = touch.pageY - touchStartY;

      if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy)) {
        if (dx > 0) {
          // Swipe right = prev song
          {% if prev_song %}
          window.location.href = "{% url 'setlists:setlist_teleprompter' setlist.id prev_song.order %}";
          {% endif %}
        } else {
          // Swipe left = next song
          {% if next_song %}
          window.location.href = "{% url 'setlists:setlist_teleprompter' setlist.id next_song.order %}";
          {% endif %}
        }
        return;
      }

      // Tap / Double tap
      const now = Date.now();
      if (now - lastTapTime < 300) {
        toggleChords(); // double tap -> toggle chords
      } else {
        toggleScrolling(); // single tap -> start/stop scrolling
      }
      lastTapTime = now;
    });
  });
  </script>

</body>
</html>