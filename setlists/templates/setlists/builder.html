{% extends base_template %}
{% load static %}

{% block extra_head %}
  <style>
    /* Tighten spacing for readability */
    .list-group-item {
      padding: 0.4rem 0.6rem;
    }
    .drag-handle {
      cursor: grab;
      font-size: 1.2rem;
    }
    #song-search:focus {
      outline: none;
      border-color: #198754;
      box-shadow: 0 0 0 0.2rem rgba(25,135,84,.25);
    }
    #song-list mark {
      background: #ffeb3b;
      color: inherit;
      padding: 0;
    }
    /* Toast styling */
    #toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #198754;
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s, transform 0.3s;
      z-index: 2000;
    }
    #toast.show {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>🎵 Setlist Builder</h2>

  {% if setlist.event %}
  <div class="mb-3 p-2 border rounded bg-light">
    <p class="mb-1">
      🎤 <strong>{{ setlist.event.title }}</strong>
      {% if setlist.event.event_type %}
        <span class="text-muted small">
          ({{ setlist.event.get_event_type_display }})
        </span>
      {% endif %}
    </p>
    <p class="mb-1 text-muted small">
      📅 {{ setlist.event.event_date|date:"D, M d, Y" }}
      {% if setlist.event.start_time %}
        at {{ setlist.event.start_time|time:"H:i" }}
        {% if setlist.event.end_time %}
          – {{ setlist.event.end_time|time:"H:i" }}
        {% endif %}
      {% endif %}
    </p>
    {% if setlist.event.location %}
      <p class="mb-0 text-muted small">📍 {{ setlist.event.location }}</p>
    {% endif %}
  </div>
{% endif %}


  <form method="post" id="setlist-form">
    {% csrf_token %}
    <div class="mb-3">
      <label for="setlist-name" class="form-label">Setlist Name</label>
      <input type="text" id="setlist-name" name="name" 
             value="{{ setlist.name|default:'Untitled Setlist' }}" 
             class="form-control">
    </div>

    <div class="row">
      <!-- SONG LIBRARY -->
      <div class="col-md-6">
        <h5>Song Library</h5>

        <!-- Search input + clear button -->
        <div class="input-group mb-2">
          <input type="text" id="song-search" placeholder="Search songs…" class="form-control">
          <button type="button" id="clear-search" class="btn btn-outline-secondary">✖</button>
        </div>

        <ul id="song-list" class="list-group" style="max-height: 70vh; overflow-y: auto;">
          {% for song in songs %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>{{ song.songTitle }}</span>
            <button type="button"
                    class="btn btn-sm btn-success add-song"
                    data-id="{{ song.id }}"
                    data-title="{{ song.songTitle }}">
              + Add
            </button>
          </li>
          {% endfor %}
        </ul>
      </div>

      <!-- CURRENT SETLIST -->
      <div class="col-md-6">
        <h5>Current Setlist</h5>
        <ul id="setlist-songs" class="list-group mb-3" style="max-height: 70vh; overflow-y: auto;">
          {% for item in setlist.songs.all %}
          <li class="list-group-item d-flex align-items-center" data-id="{{ item.song.id }}">
            <span class="drag-handle me-2">☰</span>
            <strong class="flex-grow-1">{{ item.song.songTitle }}</strong>
            <input type="hidden" name="order[]" value="{{ item.song.id }}">
            <input type="text" name="notes_{{ item.song.id }}" value="{{ item.rehearsal_notes }}" 
                   placeholder="Notes" class="form-control form-control-sm mx-2" style="width: 180px;">
            <button type="button" class="btn btn-sm btn-danger remove-song">❌</button>
          </li>
          {% endfor %}
        </ul>

        <button type="submit" class="btn btn-primary w-100">💾 Save Setlist</button>
      </div>
    </div>
  </form>
</div>

<!-- Toast notification -->
<div id="toast">✅ Song added!</div>
{% endblock %}

{% block extra_js %}
<!-- SortableJS CDN -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
console.log("🎶 Setlist Builder (AJAX + Sortable) JS loaded!");

document.addEventListener("DOMContentLoaded", function () {
  const searchInput = document.getElementById("song-search");
  const clearBtn = document.getElementById("clear-search");
  const songList = document.getElementById("song-list");
  const toast = document.getElementById("toast");
  const setlistEl = document.getElementById("setlist-songs");
  let currentAjax = null;

  // ✅ Enable drag-and-drop sorting
  Sortable.create(setlistEl, {
    handle: ".drag-handle",
    animation: 150,
  });

  // ✅ Prevent Enter key from submitting
  searchInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") e.preventDefault();
  });

  // ✅ Debounced search
  let debounceTimer = null;
  searchInput.addEventListener("input", () => {
    const query = searchInput.value.trim();
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => fetchSongs(query), 250);
  });

  // ✅ Clear button resets search
  clearBtn.addEventListener("click", () => {
    searchInput.value = "";
    fetchSongs("");
    searchInput.focus();
  });

  // ✅ Fetch filtered songs via AJAX
  function fetchSongs(query) {
    if (currentAjax) currentAjax.abort?.();
    fetch(`/setlists/ajax/song-search/?q=${encodeURIComponent(query)}`)
      .then((res) => res.json())
      .then((data) => {
        songList.innerHTML = "";
        if (data.songs.length === 0) {
          songList.innerHTML = `<li class="list-group-item text-muted">No songs found.</li>`;
          return;
        }
        data.songs.forEach(song => {
          const li = document.createElement("li");
          li.className = "list-group-item d-flex justify-content-between align-items-center";
          li.innerHTML = `
            <span>${song.title}</span>
            <button type="button"
                    class="btn btn-sm btn-success add-song"
                    data-id="${song.id}"
                    data-title="${song.title}">
              + Add
            </button>`;
          songList.appendChild(li);
        });
        bindAddButtons();
      })
      .catch((err) => console.error("Search failed:", err));
  }

  // ✅ Add song
  function bindAddButtons() {
    document.querySelectorAll(".add-song").forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        const songId = btn.dataset.id;
        const songTitle = btn.dataset.title;

        if (document.querySelector(`#setlist-songs li[data-id="${songId}"]`)) {
          showToast("⚠️ Already in setlist", "warning");
          return;
        }

        const li = document.createElement("li");
        li.className = "list-group-item d-flex align-items-center";
        li.dataset.id = songId;
        li.innerHTML = `
          <span class="drag-handle me-2">☰</span>
          <strong class="flex-grow-1">${songTitle}</strong>
          <input type="hidden" name="order[]" value="${songId}">
          <input type="text" name="notes_${songId}" placeholder="Notes"
                 class="form-control form-control-sm mx-2" style="width: 180px;">
          <button type="button" class="btn btn-sm btn-danger remove-song">❌</button>
        `;
        setlistEl.appendChild(li);

        li.querySelector(".remove-song").addEventListener("click", () => li.remove());
        showToast(`✅ Added "${songTitle}"`);
      });
    });
  }

  // ✅ Toast helper
  function showToast(message, type="success") {
    toast.textContent = message;
    toast.style.background = type === "warning" ? "#dc3545" : "#198754";
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 2000);
  }

  // Load initial songs
  fetchSongs("");

  // ✅ Track unsaved changes
  let isDirty = false;

  // Mark dirty when the setlist changes
  function markDirty() {
    if (!isDirty) {
      isDirty = true;
      window.addEventListener("beforeunload", warnUnsaved);
    }
  }

  function markClean() {
    isDirty = false;
    window.removeEventListener("beforeunload", warnUnsaved);
  }

  function warnUnsaved(e) {
    e.preventDefault();
    e.returnValue = ""; // Required for Chrome
    return "";
  }

  // Listen to changes that should mark the form as dirty
  document.getElementById("setlist-form").addEventListener("input", markDirty);
  document.getElementById("setlist-form").addEventListener("change", markDirty);

  // Also mark dirty when reordering songs
  setlistEl.addEventListener("sortupdate", markDirty);

  // Mark clean when saved
  document.getElementById("setlist-form").addEventListener("submit", function () {
    markClean();
  });


});
</script>
{% endblock %}
