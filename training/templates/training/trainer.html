{% extends 'training/base.html' %}

{% block title %}{{ algorithm.name }} - Training{% endblock %}

{% block content %}
<div class="container mt-5">
    <!-- Header -->
    <div class="text-center mb-4">
        <h1>{{ algorithm.name }}</h1>
        <div class="algorithm-display">
            {{ algorithm.notation }}
        </div>
        <p class="text-muted">RÃ©pÃ¨te {{ algorithm.repetitions }} fois</p>
    </div>
    
    <!-- Timer -->
    <div class="row justify-content-center mb-4">
        <div class="col-md-8">
            <div class="stats-card text-center">
                <div class="timer-display" id="timer">00:00.00</div>
                <button class="btn start-button" id="startBtn">
                    <i class="bi bi-play-fill"></i> DÃ©marrer
                </button>
                <div class="mt-3">
                    <small class="text-muted">Appuie sur Espace pour dÃ©marrer/arrÃªter</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Stats -->
    {% if stats %}
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="stats-card text-center">
                <h6 class="text-muted">Record Personnel</h6>
                <div class="fs-3 fw-bold text-success">{{ stats.best_time_formatted }}</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card text-center">
                <h6 class="text-muted">Tentatives</h6>
                <div class="fs-3 fw-bold">{{ stats.total_attempts }}</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card text-center">
                <h6 class="text-muted">DerniÃ¨re pratique</h6>
                <div class="fs-6">{{ stats.last_practiced|date:"d/m/Y H:i" }}</div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Derniers temps -->
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="stats-card">
                <h5 class="mb-3">ðŸ“Š Tes derniers temps</h5>
                <div id="recent-times-list">
                    {% if recent_times %}
                        {% for time in recent_times %}
                        <div class="d-flex justify-content-between py-2 border-bottom">
                            <span>{{ forloop.counter }}.</span>
                            <span class="fw-bold">{{ time.time_formatted }}</span>
                            <span class="text-muted">{{ time.created_at|date:"d/m H:i" }}</span>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center">Aucun temps enregistrÃ©. Lance-toi!</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Liens -->
    <div class="text-center mt-4">
        <a href="{% url 'training:hub' %}" class="btn btn-outline-secondary me-2">
            <i class="bi bi-arrow-left"></i> Retour au hub
        </a>
        <a href="{% url 'training:leaderboard' algorithm.slug %}" class="btn btn-outline-primary">
            <i class="bi bi-trophy"></i> Voir le classement
        </a>
    </div>
</div>

<script>
let timerInterval;
let startTime;
let isRunning = false;

const timerDisplay = document.getElementById('timer');
const startBtn = document.getElementById('startBtn');

function formatTime(ms) {
    const totalSeconds = Math.floor(ms / 1000);
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    const milliseconds = Math.floor((ms % 1000) / 10);
    return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(2, '0')}`;
}

function startTimer() {
    if (isRunning) return;
    
    startTime = Date.now();
    isRunning = true;
    startBtn.innerHTML = '<i class="bi bi-stop-fill"></i> ArrÃªter';
    startBtn.classList.add('btn-danger');
    startBtn.classList.remove('btn-primary');
    
    timerInterval = setInterval(() => {
        const elapsed = Date.now() - startTime;
        timerDisplay.textContent = formatTime(elapsed);
    }, 10);
}

function stopTimer() {
    if (!isRunning) return;
    
    clearInterval(timerInterval);
    isRunning = false;
    const finalTime = Date.now() - startTime;
    
    startBtn.innerHTML = '<i class="bi bi-play-fill"></i> DÃ©marrer';
    startBtn.classList.remove('btn-danger');
    startBtn.classList.add('btn-primary');
    
    // Sauvegarder le temps
    saveTime(finalTime);
}

async function saveTime(timeMs) {
    try {
        const response = await fetch("{% url 'training:save_time' algorithm.slug %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ time_ms: timeMs })
        });
        
        const data = await response.json();
        
        if (data.success) {
            if (data.is_new_pb) {
                showPBNotification();
            }
            // Recharger la page pour voir les nouveaux temps
            setTimeout(() => location.reload(), 1000);
        }
    } catch (error) {
        console.error('Erreur:', error);
    }
}

function showPBNotification() {
    const notification = document.createElement('div');
    notification.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
    notification.style.zIndex = '9999';
    notification.innerHTML = `
        <strong>ðŸŽ‰ Nouveau Record Personnel!</strong>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}

// Event listeners
startBtn.addEventListener('click', () => {
    if (isRunning) {
        stopTimer();
    } else {
        startTimer();
    }
});

// Touche Espace
document.addEventListener('keydown', (e) => {
    if (e.code === 'Space') {
        e.preventDefault();
        if (isRunning) {
            stopTimer();
        } else {
            startTimer();
        }
    }
});
</script>
{% endblock %}