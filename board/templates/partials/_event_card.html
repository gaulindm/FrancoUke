{% load static %}
<div class="card position-relative mb-3 p-2 rounded cursor-pointer"
     data-bs-toggle="modal" data-bs-target="#eventModal{{ event.id }}">

  <!-- ğŸ“¸ Photo count badge (exclude cover) -->
  {% if event.non_cover_images_count %}
    <span class="badge rounded-pill bg-dark position-absolute top-0 end-0 m-2">
      ğŸ“¸ {{ event.non_cover_images_count }}
    </span>
  {% endif %}

  <!-- Card Cover -->
  {% if event.cover_asset and event.cover_asset.file %}
    <img src="{{ event.cover_asset.file.url }}"
         class="img-fluid rounded d-block mx-auto"
         alt="{{ event.cover_asset.title|default:event.title }}">
  {% elif event.venue and event.venue.image %}
    <img src="{{ event.venue.image.url }}"
         class="img-fluid rounded d-block mx-auto"
         alt="{{ event.venue.name }}">
  {% elif event.cover_photo and event.cover_photo.image %}
    <img src="{{ event.cover_photo.image.url }}"
         class="img-fluid rounded d-block mx-auto"
         alt="{{ event.title }}">
  {% else %}
    <div class="bg-light text-center rounded text-muted py-4">
      âŒ No image available
    </div>
  {% endif %}

  <!-- Title -->
  <div class="d-flex justify-content-between align-items-center mt-2">
    <h6 class="mb-0">{{ event.title }}</h6>
  </div>

  <!-- Date and Time + Availability -->
  <table class="table table-sm table-borderless align-middle mb-2">
    <tr>
      <td class="text-muted small">
        {% if event.event_date %}
          <strong>Date:</strong> {{ event.event_date|date:"M d, Y" }}
        {% endif %}
      </td>
      <td rowspan="2" class="text-end">
        {% if event.my_availability == "yes" %}
          <span class="badge bg-success" title="Available">Y</span>
        {% elif event.my_availability == "no" %}
          <span class="badge bg-danger" title="Not Available">N</span>
        {% elif event.my_availability == "maybe" %}
          <span class="badge bg-warning text-dark" title="Maybe">M</span>
        {% else %}
          <span class="badge bg-secondary" title="Unknown">â€“</span>
        {% endif %}
      </td>
    </tr>
    <tr>
      <td class="text-muted small">
        {% if event.start_time %}
          <strong>Time:</strong>
          {{ event.start_time|time:"g:i A" }}
          {% if event.end_time %}
            â€“ {{ event.end_time|time:"g:i A" }}
          {% endif %}
        {% endif %}
      </td>
    </tr>
  </table>
</div>

<!-- Modal -->
<div class="modal fade" id="eventModal{{ event.id }}" tabindex="-1"
     aria-labelledby="eventModalLabel{{ event.id }}" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="eventModalLabel{{ event.id }}" class="modal-title">{{ event.title }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">

        <!-- Cover -->
        {% if event.cover_asset %}
          <img src="{{ event.cover_asset.file.url }}" 
              alt="{{ event.cover_asset.title|default:event.title }}" 
              class="img-fluid mb-3 rounded" 
              style="max-height: 250px; object-fit: cover; width: 100%;">
        {% elif event.cover_photo %}
          <img src="{{ event.cover_photo.image.url }}" 
              alt="{{ event.title }}" 
              class="img-fluid mb-3 rounded" 
              style="max-height: 250px; object-fit: cover; width: 100%;">
        {% else %}
          <img src="{% static 'images/fallback.jpg' %}" 
              alt="No cover available" 
              class="img-fluid mb-3 rounded"
              style="max-height: 250px; object-fit: cover; width: 100%;">
        {% endif %}

        <!-- ğŸ“¸ Thumbnail strip (assets) -->
        {% for asset in event.gallery_assets.all %}
          {% if asset.thumbnail %}
            <a href="{{ asset.file.url }}" data-lightbox="event-{{ event.id }}" data-title="{{ asset.title }}">
              <img src="{{ asset.thumbnail.url }}" class="img-thumbnail" style="max-height:100px; max-width:100px;">
            </a>
          {% else %}
            <a href="{{ asset.file.url }}" data-lightbox="event-{{ event.id }}" data-title="{{ asset.title }}">
              <img src="{{ asset.file.url }}" class="img-thumbnail" style="max-height:100px; max-width:100px;">
            </a>
          {% endif %}
        {% endfor %}

        <!-- ğŸ“¸ Thumbnail strip (legacy photos, exclude cover) -->
        {% if event.photos.count > 1 %}
          <hr>
          <h6>ğŸ“¸ Event Photos</h6>
          <div class="d-flex flex-wrap gap-2">
            {% for photo in event.photos.all %}
              {% if not photo.is_cover %}
                <a href="{{ photo.image.url }}" data-lightbox="event-{{ event.id }}" data-title="{{ event.title }}">
                  <img src="{{ photo.image.url }}" class="img-thumbnail" style="max-height:100px; max-width:100px;">
                </a>
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}

        <!-- Event details -->
        <p><strong>Date:</strong> {{ event.event_date|date:"M d, Y" }}</p>
        {% if event.start_time %}
          <p><strong>Time:</strong> {{ event.start_time|time:"g:i A" }}
            {% if event.end_time %} â€“ {{ event.end_time|time:"g:i A" }}{% endif %}
          </p>
        {% endif %}
        {% if event.arrive_by %}
          <p><strong>Arrive by:</strong> {{ event.arrive_by|time:"g:i A" }}</p>
        {% endif %}
        {% if event.attire %}
          <p><strong>Attire:</strong> {{ event.attire }}</p>
        {% endif %}
        {% if event.chairs %}
          <p><strong>Chairs:</strong> {{ event.chairs }}</p>
        {% endif %}

      <!-- Description -->
      <div class="description-preview mb-3">
        <div class="short-text" style="max-height: 4.5em; overflow: hidden;">
          {{ event.rich_description|safe }}
        </div>
        <div class="full-text d-none">
          {{ event.rich_description|safe }}
        </div>
        <a href="#" class="toggle-description small text-primary d-none">See more</a>
      </div>




        <!-- ğŸµ Setlist Section -->
        {% if event.setlist %}
        <div class="mt-3">
          <a href="{% url 'setlists:detail' event.setlist.id %}" 
             class="btn btn-outline-primary w-100">
             ğŸµ View Setlist
          </a>
        </div>
      {% elif user.is_staff %}
        <div class="mt-3">
          <button class="btn btn-outline-secondary w-100" disabled>
            â• Create Setlist (use Admin)
          </button>
        </div>
      {% endif %}
      

        <!-- Availability Form -->
        <form method="post" action="{% url 'board:set_event_availability' event.id %}">
          {% csrf_token %}
          <div class="mb-3">
            <label for="availability{{ event.id }}" class="form-label"><strong>Your Availability:</strong></label>
            <select id="availability{{ event.id }}" name="status" class="form-select">
              <option value="">-- Select --</option>
              <option value="yes" {% if event.my_availability == "yes" %}selected{% endif %}>âœ… Yes</option>
              <option value="maybe" {% if event.my_availability == "maybe" %}selected{% endif %}>ğŸ¤” Maybe</option>
              <option value="no" {% if event.my_availability == "no" %}selected{% endif %}>âŒ No</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary">Save</button>
        </form>

        <!-- Group Availability -->
        {% if event.avail_summary %}
          <div class="mt-3">
            <strong>Group Availability:</strong><br>
            âœ… Yes: {{ event.avail_summary.yes }} |
            âŒ No: {{ event.avail_summary.no }} |
            ğŸ¤” Maybe: {{ event.avail_summary.maybe }}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".description-preview").forEach(container => {
      const shortText = container.querySelector(".short-text");
      const fullText = container.querySelector(".full-text");
      const toggleLink = container.querySelector(".toggle-description");
  
      // Only show "See more" if the text actually overflows
      if (shortText.scrollHeight > shortText.clientHeight + 5) {
        toggleLink.classList.remove("d-none");
      }
  
      // Toggle show/hide
      toggleLink.addEventListener("click", e => {
        e.preventDefault();
        const isExpanding = toggleLink.textContent.includes("more");
  
        shortText.classList.toggle("d-none");
        fullText.classList.toggle("d-none");
  
        toggleLink.textContent = isExpanding ? "See less" : "See more";
  
        // When collapsing ("See less"), smoothly scroll back to top of description
        if (!isExpanding) {
          container.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      });
    });
  });
  </script>