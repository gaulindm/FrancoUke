{% load static %}

<div class="card position-relative mb-3 p-2 rounded cursor-pointer"
     data-bs-toggle="modal" data-bs-target="#eventModal{{ event.id }}">

  <!-- ğŸ“¸ Photo count badge -->
  {% if event.non_cover_images_count %}
    <span class="badge rounded-pill bg-dark position-absolute top-0 end-0 m-2">
      ğŸ“¸ {{ event.non_cover_images_count }}
    </span>
  {% endif %}

  <!-- ğŸ¨ Cover photo -->
  {% if event.cover_asset and event.cover_asset.file %}
    <img src="{{ event.cover_asset.file.url }}" class="img-fluid rounded d-block mx-auto"
         alt="{{ event.cover_asset.title|default:event.title }}">
  {% elif event.venue and event.venue.image %}
    <img src="{{ event.venue.image.url }}" class="img-fluid rounded d-block mx-auto"
         alt="{{ event.venue.name }}">
  {% elif event.cover_photo and event.cover_photo.image %}
    <img src="{{ event.cover_photo.image.url }}" class="img-fluid rounded d-block mx-auto"
         alt="{{ event.title }}">
  {% else %}
    <div class="bg-light text-center rounded text-muted py-4">
      âŒ No image available
    </div>
  {% endif %}

  <!-- ğŸµ Title -->
  <div class="d-flex justify-content-between align-items-center mt-2">
    <h6 class="mb-0">{{ event.title }}</h6>
  </div>

  <!-- ğŸ“… Date, time, availability -->
  <table class="table table-sm table-borderless align-middle mb-2">
    <tr>
      <td class="text-muted small">
        {% if event.event_date %}
          <strong>Date:</strong> {{ event.event_date|date:"M d, Y" }}
        {% endif %}
      </td>
      <td rowspan="2" class="text-end">
        {% if event.my_availability == "yes" %}
          <span class="badge bg-success" title="Available">Y</span>
        {% elif event.my_availability == "no" %}
          <span class="badge bg-danger" title="Not Available">N</span>
        {% elif event.my_availability == "maybe" %}
          <span class="badge bg-warning text-dark" title="Maybe">M</span>
        {% else %}
          <span class="badge bg-secondary" title="Unknown">â€“</span>
        {% endif %}
      </td>
    </tr>
    <tr>
      <td class="text-muted small">
        {% if event.start_time %}
          <strong>Time:</strong>
          {{ event.start_time|time:"g:i A" }}
          {% if event.end_time %}
            â€“ {{ event.end_time|time:"g:i A" }}
          {% endif %}
        {% endif %}
      </td>
    </tr>
  </table>

  <!-- ğŸ”— Full page fallback link -->

</div>

<!-- ğŸªŸ Modal -->
<div class="modal fade" id="eventModal{{ event.id }}" tabindex="-1"
     aria-labelledby="eventModalLabel{{ event.id }}" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">

      <!-- Header -->
      <div class="modal-header">
        <h5 id="eventModalLabel{{ event.id }}" class="modal-title">{{ event.title }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <!-- Body -->
      <div class="modal-body">


        <!-- ğŸï¸ Thumbnail strip (gallery assets) -->
        {% if event.gallery_assets.exists %}
          <div class="d-flex flex-wrap gap-2 mb-3">
            {% for asset in event.gallery_assets.all %}
            {% if event.cover_asset and event.cover_asset.file %}
            <img src="{{ event.cover_asset.file.url }}" class="img-fluid rounded mb-3" alt="{{ event.title }}">
          {% elif event.venue and event.venue.image %}
            <img src="{{ event.venue.image.url }}" class="img-fluid rounded mb-3" alt="{{ event.venue.name }}">
          {% else %}
            <img src="{% static 'images/fallback.jpg' %}" class="img-fluid rounded mb-3" alt="No cover available">
          {% endif %}
          
              </a>
            {% endfor %}
          </div>
        {% endif %}

        <!-- ğŸ“¸ Legacy photos (non-cover) -->
        {% if event.photos.count > 1 %}
          <hr>
          <h6>ğŸ“¸ Event Photos</h6>
          <div class="d-flex flex-wrap gap-2">
            {% for photo in event.photos.all %}
              {% if not photo.is_cover %}
                <a href="{{ photo.image.url }}" data-lightbox="event-{{ event.id }}" data-title="{{ event.title }}">
                  <img src="{{ photo.image.url }}" class="img-thumbnail" style="max-height:100px; max-width:100px;">
                </a>
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}

        <hr>



        <!-- ğŸ§© Shared Event Details partial -->
        {% include "board/_event_detail.html" with event=event %}




        <!-- ğŸ“… Availability Form -->
        <form method="post" action="{% url 'board:set_event_availability' event.id %}" class="mt-3">
          {% csrf_token %}
          <div class="mb-3">
            <label for="availability{{ event.id }}" class="form-label"><strong>Your Availability:</strong></label>
            <select id="availability{{ event.id }}" name="status" class="form-select">
              <option value="">-- Select --</option>
              <option value="yes" {% if event.my_availability == "yes" %}selected{% endif %}>âœ… Yes</option>
              <option value="maybe" {% if event.my_availability == "maybe" %}selected{% endif %}>ğŸ¤” Maybe</option>
              <option value="no" {% if event.my_availability == "no" %}selected{% endif %}>âŒ No</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary">Save</button>
        </form>

        <!-- ğŸ‘¥ Group Availability Summary -->
        {% if event.avail_summary %}
          <div class="mt-3">
            <strong>Group Availability:</strong><br>
            âœ… Yes: {{ event.avail_summary.yes }} |
            âŒ No: {{ event.avail_summary.no }} |
            ğŸ¤” Maybe: {{ event.avail_summary.maybe }}
          </div>
        {% endif %}
      </div>
                      <!-- ğŸµ Setlist Section -->
                      {% if event.setlist %}
                      <div class="mt-3">
                        <a href="{% url 'setlists:detail' event.setlist.id %}" 
                           class="btn btn-outline-primary w-100">
                           ğŸµ View Setlist
                        </a>
                      </div>
                    {% elif user.is_staff %}
                      <div class="mt-3">
                        <button class="btn btn-outline-secondary w-100" disabled>
                          â• Create Setlist (use Admin)
                        </button>
                      </div>
                    {% endif %}
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".description-preview").forEach(container => {
    const shortText = container.querySelector(".short-text");
    const fullText = container.querySelector(".full-text");
    const toggleLink = container.querySelector(".toggle-description");

    if (shortText && fullText && toggleLink) {
      if (shortText.scrollHeight > shortText.clientHeight + 5) {
        toggleLink.classList.remove("d-none");
      }

      toggleLink.addEventListener("click", e => {
        e.preventDefault();
        const expanding = toggleLink.textContent.includes("more");

        shortText.classList.toggle("d-none");
        fullText.classList.toggle("d-none");

        toggleLink.textContent = expanding ? "See less" : "See more";
        if (!expanding) {
          container.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      });
    }
  });
});
</script>
