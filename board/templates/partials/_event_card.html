{% load static %}
{% load group_tags %}
{% load user_tags %}

<div class="card position-relative mb-3 p-2 rounded cursor-pointer"
     data-bs-toggle="modal" data-bs-target="#eventModal{{ event.id }}">

  <!-- ğŸ“¸ Photo count badge -->
  {% if event.non_cover_images_count > 0 %}
    <span class="badge rounded-pill bg-dark position-absolute top-0 end-0 m-2">
      ğŸ“¸ {{ event.non_cover_images_count }}
    </span>
  {% endif %}

  <!-- ğŸ·ï¸ Optional rehearsal badge -->
  {% if event.is_rehearsal %}
    <span class="badge bg-info text-dark position-absolute top-0 start-0 m-2">
      ğŸ¤ Rehearsal
    </span>
  {% endif %}

  <!-- ğŸ¨ Cover photo -->
  {% if event.cover_asset and event.cover_asset.file %}
    <img src="{{ event.cover_asset.file.url }}" class="img-fluid rounded d-block mx-auto"
         alt="{{ event.cover_asset.title|default:event.title }}">
  {% elif event.venue and event.venue.image %}
    <img src="{{ event.venue.image.url }}" class="img-fluid rounded d-block mx-auto"
         alt="{{ event.venue.name }}">
  {% elif event.cover_photo and event.cover_photo.image %}
    <img src="{{ event.cover_photo.image.url }}" class="img-fluid rounded d-block mx-auto"
         alt="{{ event.title }}">
  {% else %}
    <div class="bg-light text-center rounded text-muted py-4">
      âŒ No image available
    </div>
  {% endif %}

  <!-- ğŸµ Title -->
  <div class="d-flex justify-content-between align-items-center mt-2">
    <h6 class="mb-0">{{ event.title }}</h6>
  </div>

  <!-- ğŸ“… Date, time, availability -->
  <table class="table table-sm table-borderless align-middle mb-2">
    <tr>
      <td class="text-muted small">
        {% if event.event_date %}
          <strong>Date:</strong> {{ event.event_date|date:"M d, Y" }}
        {% endif %}
      </td>
      <td rowspan="2" class="text-end">
        {% if event.my_availability == "yes" %}
          <span class="badge bg-success" title="Available">Y</span>
        {% elif event.my_availability == "no" %}
          <span class="badge bg-danger" title="Not Available">N</span>
        {% elif event.my_availability == "maybe" %}
          <span class="badge bg-warning text-dark" title="Maybe">M</span>
        {% else %}
          <span class="badge bg-secondary" title="Unknown">â€“</span>
        {% endif %}
      </td>
    </tr>
    <tr>
      <td class="text-muted small">
        {% if event.start_time %}
          <strong>Time:</strong>
          {{ event.start_time|time:"g:i A" }}
          {% if event.end_time %}
            â€“ {{ event.end_time|time:"g:i A" }}
          {% endif %}
        {% endif %}
      </td>
    </tr>
  </table>
</div>

<!-- ğŸªŸ Modal -->
<div class="modal fade" id="eventModal{{ event.id }}" tabindex="-1"
     aria-labelledby="eventModalLabel{{ event.id }}" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">

      <!-- Header -->
      <div class="modal-header">
        <h5 id="eventModalLabel{{ event.id }}" class="modal-title">{{ event.title }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <!-- Body -->
      <div class="modal-body">
        {% include "board/_event_detail.html" with event=event %}

        <!-- ğŸ“¸ PHOTO GALLERY SECTION -->
        {% if event.non_cover_images_count > 0 %}
          <hr class="my-4">
          <div class="photo-gallery-section">
            <h6 class="mb-3">ğŸ“¸ Event Photos ({{ event.non_cover_images_count }})</h6>
            
            <div class="row g-2">
              <!-- Gallery Assets (from Asset model) -->
              {% for asset in event.non_cover_gallery_assets %}
                <div class="col-6 col-md-4 col-lg-3">
                  <a href="{{ asset.file.url }}" 
                     class="glightbox" 
                     data-gallery="event-gallery-{{ event.id }}"
                     data-glightbox="title: {{ asset.title|default:event.title }}; description: {{ asset.caption|default:'' }}">
                    {% if asset.thumbnail %}
                      <img src="{{ asset.thumbnail.url }}" 
                           class="img-fluid rounded shadow-sm" 
                           alt="{{ asset.alt_text|default:asset.title }}"
                           style="aspect-ratio: 1; object-fit: cover; cursor: pointer;">
                    {% else %}
                      <img src="{{ asset.file.url }}" 
                           class="img-fluid rounded shadow-sm" 
                           alt="{{ asset.alt_text|default:asset.title }}"
                           style="aspect-ratio: 1; object-fit: cover; cursor: pointer;">
                    {% endif %}
                  </a>
                </div>
              {% endfor %}

              <!-- Legacy Photos (EventPhoto model) -->
              {% for photo in event.non_cover_photos %}
                <div class="col-6 col-md-4 col-lg-3">
                  <a href="{{ photo.image.url }}" 
                     class="glightbox" 
                     data-gallery="event-gallery-{{ event.id }}"
                     data-glightbox="title: {{ event.title }}">
                    <img src="{{ photo.image.url }}" 
                         class="img-fluid rounded shadow-sm" 
                         alt="Photo for {{ event.title }}"
                         style="aspect-ratio: 1; object-fit: cover; cursor: pointer;">
                  </a>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% if event.event_type != "rehearsal" %}
          <hr class="my-3">
          
          <!-- ğŸ“… Availability Form -->
          <form method="post" action="{% url 'board:set_event_availability' event.id %}" class="mt-3">
            {% csrf_token %}
            <div class="mb-3">
              <label for="availability{{ event.id }}" class="form-label">
                <strong>Your Availability:</strong>
              </label>
              <select id="availability{{ event.id }}" name="status" class="form-select">
                <option value="">-- Select --</option>
                <option value="yes" {% if event.my_availability == "yes" %}selected{% endif %}>âœ… Yes</option>
                <option value="maybe" {% if event.my_availability == "maybe" %}selected{% endif %}>ğŸ¤” Maybe</option>
                <option value="no" {% if event.my_availability == "no" %}selected{% endif %}>âŒ No</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary">Save</button>
          </form>
      
          <!-- ğŸ‘¥ Group Availability Summary -->
          {% if event.avail_summary %}
            <div class="mt-3">
              <strong>Group Availability:</strong><br>
              âœ… Yes: {{ event.avail_summary.yes }} |
              âŒ No: {{ event.avail_summary.no }} |
              ğŸ¤” Maybe: {{ event.avail_summary.maybe }}
            </div>
          {% endif %}
        {% else %}
          {% comment %}
            ğŸ‘‡ Availability intentionally hidden for rehearsals
          {% endcomment %}
        {% endif %}
      
        <hr>

        {# ğŸµ PERFORMANCE-ONLY SECTION ----------------------------- #}
        {% if not event.is_rehearsal %}
          {% if request.user|has_group:"Performers" %}
            {% if event.setlist %}
              <div class="mt-3">
                <a href="{% url 'setlists:detail' event.setlist.id %}"
                   class="btn btn-outline-primary w-100">
                   ğŸµ View Setlist
                </a>
                {% if request.user|has_group:"Leaders" %}
                  <a href="{% url 'setlists:setlist_builder' event.setlist.id %}"
                     class="btn btn-outline-secondary w-100 mt-2">
                     âœï¸ Edit Setlist
                  </a>
                {% endif %}
              </div>
            {% else %}
              {% if request.user|has_group:"Leaders" %}
                <div class="mt-3">
                  <a href="{% url 'setlists:setlist_create_for_event' event.id %}"
                     class="btn btn-success w-100">
                     â• Create Setlist
                  </a>
                </div>
              {% endif %}
            {% endif %}
          {% endif %}
        {% endif %}

        {# ğŸ§¾ REHEARSAL-ONLY SECTION ------------------------------- #}
        {% if event.event_type == "rehearsal" %}
          <div class="accordion mt-4" id="accordionRehearsal{{ event.id }}">
        
            <!-- ğŸ“ Rehearsal Details -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingDetails{{ event.id }}">
                <button class="accordion-button collapsed" type="button"
                        data-bs-toggle="collapse" data-bs-target="#collapseDetails{{ event.id }}"
                        aria-expanded="false" aria-controls="collapseDetails{{ event.id }}">
                  ğŸ“ Rehearsal Details
                </button>
              </h2>
        
              <div id="collapseDetails{{ event.id }}" class="accordion-collapse collapse"
                  aria-labelledby="headingDetails{{ event.id }}"
                  data-bs-parent="#accordionRehearsal{{ event.id }}">
                <div class="accordion-body">
        
                  {% if event.rehearsal_details %}
                    <div class="mb-2 rehearsal-notes">
                      {{ event.rehearsal_details.notes|safe }}
                    </div>
                  {% else %}
                    <p class="text-muted fst-italic">No rehearsal notes yet.</p>
                  {% endif %}
        
                  {% if request.user|has_group:"Leaders" %}
                    <div class="text-end mt-2">
                      <a href="{% url 'board:edit_rehearsal_details' event.id %}"
                        class="btn btn-sm btn-outline-secondary">
                        âœï¸ Edit Rehearsal Notes
                      </a>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
        
            <!-- ğŸµ Song Rehearsal Notes -->
            <div class="accordion-item mt-2">
              <h2 class="accordion-header" id="headingSongs{{ event.id }}">
                <button class="accordion-button collapsed" type="button"
                        data-bs-toggle="collapse" data-bs-target="#collapseSongs{{ event.id }}"
                        aria-expanded="false" aria-controls="collapseSongs{{ event.id }}">
                  ğŸµ Song Rehearsal Notes
                </button>
              </h2>
        
              <div id="collapseSongs{{ event.id }}" class="accordion-collapse collapse"
                  aria-labelledby="headingSongs{{ event.id }}"
                  data-bs-parent="#accordionRehearsal{{ event.id }}">
                <div class="accordion-body">
                  {% if event.rehearsal_details and event.rehearsal_details.song_notes.all %}
                    <ul class="list-group list-group-flush">
                      {% for note in event.rehearsal_details.song_notes.all %}
                        <li class="list-group-item">
                          <strong>{{ note.song.songTitle }}</strong><br>
                          {{ note.notes|safe }}
                          <div class="small text-muted">
                            by {{ note.created_by|get_user_display_name|default:"Unknown" }},
                            {{ note.created_at|date:"M d, Y" }}
                          </div>
                        </li>
                      {% empty %}
                        <li class="list-group-item text-muted fst-italic">
                          No song notes available.
                        </li>
                      {% endfor %}
                    </ul>
                  {% else %}
                    <p class="text-muted fst-italic">No song notes available.</p>
                  {% endif %}
        
                  {% if request.user|has_group:"Leaders" %}
                    <div class="text-end mt-2">
                      <a href="{% url 'board:edit_song_rehearsal_notes' event.id %}"
                        class="btn btn-sm btn-outline-secondary">
                        ğŸµ Edit Song Notes
                      </a>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        {% endif %}

      </div> <!-- /.modal-body -->
    </div> <!-- /.modal-content -->
  </div> <!-- /.modal-dialog -->
</div> <!-- /.modal -->

<style>
/* GLightbox custom styles */
.photo-gallery-section img {
  transition: transform 0.2s, box-shadow 0.2s;
}

.photo-gallery-section img:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2) !important;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Description toggle functionality
  document.querySelectorAll(".description-preview").forEach(container => {
    const shortText = container.querySelector(".short-text");
    const fullText = container.querySelector(".full-text");
    const toggleLink = container.querySelector(".toggle-description");

    if (shortText && fullText && toggleLink) {
      if (shortText.scrollHeight > shortText.clientHeight + 5) {
        toggleLink.classList.remove("d-none");
      }

      toggleLink.addEventListener("click", e => {
        e.preventDefault();
        const expanding = toggleLink.textContent.includes("more");

        shortText.classList.toggle("d-none");
        fullText.classList.toggle("d-none");

        toggleLink.textContent = expanding ? "See less" : "See more";
        if (!expanding) {
          container.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      });
    }
  });

  // Initialize GLightbox for this event's gallery
  const eventId = "{{ event.id }}";
  const galleryLinks = document.querySelectorAll(`a.glightbox[data-gallery="event-gallery-${eventId}"]`);
  
  if (galleryLinks.length > 0 && typeof GLightbox !== 'undefined') {
    GLightbox({
      selector: `a.glightbox[data-gallery="event-gallery-${eventId}"]`,
      touchNavigation: true,
      loop: true,
      autoplayVideos: true
    });
  }
});
</script>