<div class="card"
     style="background:white; padding:10px; margin-bottom:10px; border-radius:4px; cursor:pointer;"
     data-bs-toggle="modal" data-bs-target="#performanceModal{{ item.id }}">

  <!-- Cover / Media -->
  {% if item.cover_photo %}
    <img src="{{ item.cover_photo.image.url }}" alt="{{ item.title }}"
         style="max-width:100%; height:auto; border-radius:4px; display:block; margin:0 auto;">
  {% elif item.media_file %}
    <img src="{{ item.media_file.url }}" alt="{{ item.title }}"
         style="max-width:100%; height:auto; border-radius:4px; display:block; margin:0 auto;">
  {% else %}
    <div style="background:#eee; padding:20px; text-align:center; border-radius:4px; color:#888;">
      ‚ùå No image available
    </div>
  {% endif %}

  <!-- Title + Availability -->
  <div class="d-flex justify-content-between align-items-center mt-2">
    <strong>{{ item.title }}</strong>
    {% if item.performance.my_availability == "yes" %}
      <span class="badge bg-success">Y</span>
    {% elif item.performance.my_availability == "no" %}
      <span class="badge bg-danger">N</span>
    {% elif item.performance.my_availability == "maybe" %}
      <span class="badge bg-warning text-dark">M</span>
    {% else %}
      <span class="badge bg-secondary">‚Äì</span>
    {% endif %}
  </div>

  <!-- Date + Time + Location -->
  <small class="text-muted">
    {% if item.performance.event_date %}
      <p><strong>Date:</strong> {{ item.performance.event_date|date:"M d, Y" }}</p>
    {% endif %}
    {% if item.performance.start_time %}
      <p><strong>Time:</strong> {{ item.performance.start_time|time:"g:i A" }}
        {% if item.performance.end_time %} - {{ item.performance.end_time|time:"g:i A" }}{% endif %}
      </p>
    {% endif %}
    {% if item.performance.location %}
      <p><strong>Location:</strong> {{ item.performance.location }}</p>
    {% endif %}
  </small>
</div>  {# ‚úÖ closes only the card! #}

<!-- Modal -->
<div class="modal fade" id="performanceModal{{ item.id }}" tabindex="-1"
     aria-labelledby="performanceModalLabel{{ item.id }}" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ item.title }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        {% if item.cover_photo %}
          <img src="{{ item.cover_photo.image.url }}" alt="{{ item.title }}" class="img-fluid mb-3 rounded">
        {% elif item.media_file %}
          <img src="{{ item.media_file.url }}" alt="{{ item.title }}" class="img-fluid mb-3 rounded">
        {% endif %}

        {% if item.performance.event_date %}
          <p><strong>Date:</strong> {{ item.performance.event_date|date:"M d, Y" }}</p>
        {% endif %}
        {% if item.performance.start_time %}
          <p><strong>Time:</strong> {{ item.performance.start_time|time:"g:i A" }}
            {% if item.performance.end_time %} - {{ item.performance.end_time|time:"g:i A" }}{% endif %}
          </p>
        {% endif %}
        {% if item.performance.arrive_by %}
          <p><strong>Arrive By:</strong> {{ item.performance.arrive_by|time:"g:i A" }}</p>
        {% endif %}
        {% if item.performance.attire %}
          <p><strong>Attire:</strong> {{ item.performance.attire }}</p>
        {% endif %}
        {% if item.performance.chairs %}
          <p><strong>Chairs:</strong> {{ item.performance.chairs }}</p>
        {% endif %}

        <div>{{ item.rich_description|safe }}</div>

        {% if item.youtube_embed_url %}
          <div class="ratio ratio-16x9 my-3">
            <iframe src="{{ item.youtube_embed_url }}" title="YouTube video" allowfullscreen></iframe>
          </div>
        {% endif %}

        <hr>

        {# ‚úÖ Event Photos Gallery (Lightbox) #}
        {% for event in item.events.all %}
          {% if event.cover_photo %}
            <div class="event-gallery mb-3">
              <a href="{{ event.cover_photo.image.url }}"
                 data-lightbox="event-{{ event.id }}"
                 data-title="{{ event.title }}">
                <img src="{{ event.cover_photo.image.url }}" alt="{{ event.title }}" class="thumbnail">
              </a>

              {% for photo in event.photos.all %}
                {% if photo.id != event.cover_photo.id %}
                  <a href="{{ photo.image.url }}"
                     data-lightbox="event-{{ event.id }}"
                     data-title="{{ event.title }}"></a>
                {% endif %}
              {% endfor %}
            </div>
          {% endif %}
        {% endfor %}

        <!-- User Availability Form -->
        <form method="post" action="{% url 'set_availability' item.performance.id %}">
          {% csrf_token %}
          <div class="mb-3">
            <label for="availability{{ item.id }}" class="form-label"><strong>Your Availability:</strong></label>
            <select id="availability{{ item.id }}" name="status" class="form-select">
              <option value="">-- Select --</option>
              <option value="yes" {% if item.performance.my_availability == "yes" %}selected{% endif %}>‚úÖ Yes</option>
              <option value="maybe" {% if item.performance.my_availability == "maybe" %}selected{% endif %}>ü§î Maybe</option>
              <option value="no" {% if item.performance.my_availability == "no" %}selected{% endif %}>‚ùå No</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary">Save</button>
        </form>

        <!-- Group Availability Summary -->
        {% if item.performance.avail_summary %}
          <div class="mt-3">
            <strong>Group Availability:</strong><br>
            ‚úÖ Yes: {{ item.performance.avail_summary.yes }} |
            ‚ùå No: {{ item.performance.avail_summary.no }} |
            ü§î Maybe: {{ item.performance.avail_summary.maybe }}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
