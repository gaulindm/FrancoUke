{% extends 'base_uke4ia.html' %}

{% block content %}
<!-- Lightbox2 -->
<link href="https://cdn.jsdelivr.net/npm/lightbox2@2/dist/css/lightbox.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/lightbox2@2/dist/js/lightbox-plus-jquery.min.js"></script>

<!-- Bootstrap 5 Modal (if not already included) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- üé§ Performances by Venue -->
<div style="display: flex; gap: 20px; overflow-x: auto; padding-bottom: 20px;">

    {% for venue, gigs in gigs_by_venue.items %}
        <div class="board-column" style="flex: 0 0 300px; background: #f8f8f8; border-radius: 6px; padding: 10px;">

            <!-- üèõÔ∏è Venue Name -->
            <h5 class="text-center">{{ venue.name }}</h5>

            <!-- üñºÔ∏è Venue Image -->
            {% if venue.image %}
                <img src="{{ venue.image.url }}" alt="{{ venue.name }}" style="width: 100%; border-radius: 6px; margin-bottom: 10px;">
            {% endif %}

            <!-- üéµ Gigs as Cards -->
            {% for gig in gigs %}
                <div class="card mb-3 p-2" style="background: white; border-radius: 4px;">
                    <strong>
                        <a href="{% url 'gigs:performer_gig_detail' gig.id %}">
                            {{ gig.title }}
                        </a>
                    </strong><br>
                    <small class="text-muted">üìÖ {{ gig.date|date:"M d, Y" }}</small><br>
                    {% if gig.call_time %}
                        <small class="text-muted">üé§ Call Time: {{ gig.call_time|time:"H:i" }}</small>
                    {% endif %}
                </div>
            {% endfor %}

        </div>
    {% endfor %}

    <!-- üß± Other Columns -->
    {% for column in columns %}
        {% if column.column_type != 'venue' %}
            <div class="board-column" style="flex: 0 0 300px; background: #f8f8f8; border-radius: 6px; padding: 10px;">
                <h4>{{ column.name }}</h4>
                <div class="sortable-list" data-column-id="{{ column.id }}">

                    {% for item in column.items.all|dictsort:"position" %}
                        <div class="card" data-item-id="{{ item.id }}"
                             style="background:white; padding:10px; margin-bottom:10px; border-radius:4px; cursor:grab;">

                            {% if item.is_rehearsal %}
                                <a href="{% url 'rehearsal_detail' item.id %}">
                                    <strong>{{ item.title }}</strong>
                                </a><br>

                                <p><strong>Your response:</strong>
                                    {% if item.my_availability == 'yes' %}
                                        ‚úÖ Coming
                                    {% elif item.my_availability == 'maybe' %}
                                        ‚ùì Maybe
                                    {% elif item.my_availability == 'no' %}
                                        ‚ùå Can't
                                    {% else %}
                                        üö´ No response yet
                                    {% endif %}
                                </p>

                                <small class="text-muted">üìÖ {{ item.event_date|date:"M d, Y H:i" }}</small>

                                {% else %}
                                <strong>{{ item.title }}</strong><br>
                                {{ item.description|linebreaks }}
                            
                                {% if item.column.column_type == "photos" and item.photos.exists %}
                                <p>
                                  <a href="#" class="btn btn-sm btn-outline-primary"
                                     data-bs-toggle="modal"
                                     data-bs-target="#photoGalleryModal"
                                     data-item-id="{{ item.id }}"
                                     data-item-title="{{ item.title }}">
                                    üì∑ View Photo Gallery
                                  </a>
                                </p>
                              {% endif %}
                            
                                {% if item.youtube_embed_url %}
                                    <div class="ratio ratio-16x9 mt-2 mb-2">
                                        <iframe src="{{ item.youtube_embed_url }}" frameborder="0" allowfullscreen></iframe>
                                    </div>
                                {% endif %}
                            
                                {% if item.link %}
                                    <p><a href="{{ item.link }}" target="_blank">üîó Open Link</a></p>
                                {% endif %}
                            
                                {% if item.event_date %}
                                    <small class="text-muted">üìÖ {{ item.event_date|date:"M d, Y H:i" }}</small>
                                {% endif %}
                            {% endif %}
                            
                        </div>
                    {% endfor %}

                </div>
            </div>
        {% endif %}
    {% endfor %}

</div>
<div class="modal fade" id="photoGalleryModal" tabindex="-1" aria-labelledby="galleryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="galleryModalLabel">Photo Gallery</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="photoGalleryContent">
          <p>Loading photos...</p>
        </div>
      </div>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const modal = document.getElementById('photoGalleryModal');
      modal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const itemId = button.getAttribute('data-item-id');
        const itemTitle = button.getAttribute('data-item-title');
        const modalTitle = modal.querySelector('.modal-title');
        const modalBody = document.getElementById('photoGalleryContent');
  
        modalTitle.textContent = `üì∑ ${itemTitle}`;
  
        // Clear previous content
        modalBody.innerHTML = '<p>Loading photos...</p>';
  
        // Fetch photos via AJAX
        fetch(`/board/api/items/${itemId}/photos/`)
        .then(response => response.json())
          .then(data => {
            if (data.length === 0) {
              modalBody.innerHTML = '<p>No photos found.</p>';
              return;
            }
  
            const galleryHTML = data.map(photo => `
              <a href="${photo.url}" data-lightbox="item-${itemId}" data-title="${photo.caption || ''}">
                <img src="${photo.url}" class="img-fluid mb-3" style="max-height: 200px; margin-right: 10px;" />
              </a>
            `).join('');
  
            modalBody.innerHTML = `<div class="d-flex flex-wrap">${galleryHTML}</div>`;
          })
          .catch(err => {
            modalBody.innerHTML = '<p class="text-danger">Failed to load photos.</p>';
          });
      });
    });
  </script>
   

{% endblock %}
