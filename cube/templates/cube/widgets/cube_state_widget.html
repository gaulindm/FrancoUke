{% load static %}

<div class="cube-editor" data-widget>

<style>
.cube-editor {
  background: #f8f9fa;
  padding: 16px;
  border-radius: 8px;
  max-width: 620px;
}

.cube-faces {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 18px;
  margin-bottom: 16px;
}

.cube-face {
  text-align: center;
}

.cube-face h4 {
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 6px;
}

.cube-grid {
  display: grid;
  grid-template-columns: repeat(3, 36px);
  grid-template-rows: repeat(3, 36px);
  gap: 4px;
  justify-content: center;
}

.cube-cell {
  width: 36px;
  height: 36px;
  border: 2px solid #333;
  cursor: pointer;
  box-sizing: border-box;
}

.cube-cell:hover {
  transform: scale(1.05);
}

.cube-cell.highlight {
  border: 3px solid #ffcc00;
  box-shadow: 0 0 8px rgba(255,204,0,0.9);
}

.cube-colors {
  display: flex;
  gap: 10px;
  margin-top: 12px;
  flex-wrap: wrap;
}

.color-option {
  width: 30px;
  height: 30px;
  border: 3px solid #ccc;
  cursor: pointer;
  border-radius: 4px;
}

.color-option.selected {
  border-color: #000;
  box-shadow: 0 0 0 2px #4caf50;
}

.cube-help {
  font-size: 12px;
  margin-top: 8px;
  color: #555;
}
</style>

<!-- Hidden JSON field (CRITICAL) -->
<textarea
  name="{{ widget.name }}"
  id="{{ widget.attrs.id }}"
  style="display:none;"
>{% if widget.value %}{{ widget.value }}{% endif %}</textarea>

<div class="cube-faces" id="cube-faces"></div>

<div>
  <strong>Select color:</strong>
  <div class="cube-colors" id="color-picker"></div>
</div>

<div class="cube-help">
  Click to paint Â· <strong>Shift + click</strong> to toggle highlight
</div>

<script>
(function () {

  const COLOR_MAP = {
    W: "#ffffff",
    Y: "#ffff00",
    G: "#00aa00",
    B: "#0000ff",
    R: "#ff0000",
    O: "#ff8c00",
    X: "#cccccc"
  };

  const FACES = ["U", "F", "R", "B", "L", "D"];

  const hiddenInput = document.getElementById("{{ widget.attrs.id }}");
  const container = hiddenInput.closest(".cube-editor");

  let data;
  try {
    data = JSON.parse('{{ cube_data_json|escapejs }}');
  } catch {
    data = { cube: {}, highlight: { stickers: [] } };
  }

  if (!data.cube) {
    data = {
      cube: data,
      highlight: { stickers: [] }
    };
  }

  const cube = data.cube;
  const highlights = data.highlight.stickers || [];

  function save() {
    hiddenInput.value = JSON.stringify(data);
  }

  function isHighlighted(face, r, c) {
    return highlights.some(h => h[0] === face && h[1] === r && h[2] === c);
  }

  function toggleHighlight(face, r, c, cell) {
    const i = highlights.findIndex(h => h[0] === face && h[1] === r && h[2] === c);
    if (i >= 0) {
      highlights.splice(i, 1);
      cell.classList.remove("highlight");
    } else {
      highlights.push([face, r, c]);
      cell.classList.add("highlight");
    }
    save();
  }

  /* Build cube faces */
  const facesContainer = container.querySelector("#cube-faces");

  FACES.forEach(face => {
    const faceDiv = document.createElement("div");
    faceDiv.className = "cube-face";

    const title = document.createElement("h4");
    title.textContent = face;
    faceDiv.appendChild(title);

    const grid = document.createElement("div");
    grid.className = "cube-grid";

    for (let r = 0; r < 3; r++) {
      for (let c = 0; c < 3; c++) {
        const cell = document.createElement("div");
        cell.className = "cube-cell";

        const color = cube[face][r][c];
        cell.style.backgroundColor = COLOR_MAP[color];

        if (isHighlighted(face, r, c)) {
          cell.classList.add("highlight");
        }

        cell.addEventListener("click", e => {
          if (e.shiftKey) {
            toggleHighlight(face, r, c, cell);
          } else {
            cube[face][r][c] = selectedColor;
            cell.style.backgroundColor = COLOR_MAP[selectedColor];
            save();
          }
        });

        grid.appendChild(cell);
      }
    }

    faceDiv.appendChild(grid);
    facesContainer.appendChild(faceDiv);
  });

  /* Color picker */
  let selectedColor = "W";
  const picker = container.querySelector("#color-picker");

  Object.entries(COLOR_MAP).forEach(([key, hex]) => {
    const swatch = document.createElement("div");
    swatch.className = "color-option";
    swatch.style.backgroundColor = hex;

    if (key === selectedColor) swatch.classList.add("selected");

    swatch.addEventListener("click", () => {
      selectedColor = key;
      picker.querySelectorAll(".color-option").forEach(o => o.classList.remove("selected"));
      swatch.classList.add("selected");
    });

    picker.appendChild(swatch);
  });

  save();

})();
</script>

</div>
