{% load static %}

<div class="card position-relative"
     style="background:white; padding:10px; margin-bottom:10px; border-radius:4px; cursor:pointer;"
     data-bs-toggle="modal" data-bs-target="#eventModal{{ event.id }}">

  <!-- 🔹 Card Cover -->
  {% if event.cover_asset %}
    <img src="{{ event.cover_asset.file.url }}"
         alt="{{ event.cover_asset.title|default:event.title }}"
         style="max-width:100%; height:auto; border-radius:4px; display:block; margin:0 auto;">
  {% elif event.venue and event.venue.image %}
    <img src="{{ event.venue.image.url }}" 
         alt="{{ event.venue.name }}"
         style="max-width:100%; height:auto; border-radius:4px; display:block; margin:0 auto;">
  {% elif event.cover_photo %}
    <img src="{{ event.cover_photo.image.url }}" 
         alt="{{ event.title }}"
         style="max-width:100%; height:auto; border-radius:4px; display:block; margin:0 auto;">
  {% else %}
    <div style="background:#eee; padding:20px; text-align:center; border-radius:4px; color:#888;">
      ❌ No image available
    </div>
  {% endif %}

  <!-- 🔹 Photo Count Badge (exclude cover) -->
  {% if event.photos.count > 1 %}
    <span class="position-absolute top-0 end-0 m-2 text-white bg-dark bg-opacity-75 px-2 py-1 rounded">
      📸 {{ event.photos.count|add:"-1" }}
    </span>
  {% endif %}

  <!-- 🔹 Title -->
  <div class="d-flex justify-content-between align-items-center mt-2">
    <strong>{{ event.title }}</strong>
  </div>

  <!-- 🔹 Date + Time -->
  <small class="text-muted">
    {% if event.event_date %}
      <strong>Date:</strong> {{ event.event_date|date:"M d, Y" }}<br>
    {% endif %}
    {% if event.start_time %}
      <strong>Time:</strong> {{ event.start_time|time:"g:i A" }}
      {% if event.end_time %} - {{ event.end_time|time:"g:i A" }}{% endif %}
    {% endif %}
  </small>
</div>


<!-- 🔹 Modal -->
<div class="modal fade" id="eventModal{{ event.id }}" tabindex="-1"
     aria-labelledby="eventModalLabel{{ event.id }}" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ event.title }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <!-- Cover -->
        {% if event.cover_asset %}
          <img src="{{ event.cover_asset.file.url }}" 
               alt="{{ event.cover_asset.title|default:event.title }}" 
               class="img-fluid mb-3 rounded">
        {% elif event.cover_photo %}
          <img src="{{ event.cover_photo.image.url }}" 
               alt="{{ event.title }}" 
               class="img-fluid mb-3 rounded">
        {% else %}
          <img src="{% static 'images/fallback.jpg' %}" 
               alt="No cover available" 
               class="img-fluid mb-3 rounded">
        {% endif %}

        <!-- Date / Time -->
        {% if event.event_date %}
          <p><strong>Date:</strong> {{ event.event_date|date:"M d, Y" }}</p>
        {% endif %}
        {% if event.start_time %}
          <p><strong>Time:</strong> {{ event.start_time|time:"g:i A" }}
            {% if event.end_time %} - {{ event.end_time|time:"g:i A" }}{% endif %}
          </p>
        {% endif %}

        <!-- Arrive by -->
        {% if event.arrive_by %}
          <p><strong>Arrive by:</strong> {{ event.arrive_by|time:"g:i A" }}</p>
        {% endif %}

        <!-- Attire -->
        {% if event.attire %}
          <p><strong>Attire:</strong> {{ event.attire }}</p>
        {% endif %}

        <!-- Chairs -->
        {% if event.chairs %}
          <p><strong>Chairs:</strong> {{ event.chairs }}</p>
        {% endif %}

        <!-- Description -->
        <div class="description-preview mt-3">
          <div class="short-text" style="max-height: 4.5em; overflow: hidden;">
            {{ event.rich_description|safe }}
          </div>
          <div class="full-text d-none">
            {{ event.rich_description|safe }}
          </div>
          <a href="#" class="toggle-description">See more</a>
        </div>

        <!-- 📸 Gallery (exclude cover photo) -->
        {% if event.photos.count > 1 %}
          <hr>
          <h6>📸 Event Photos</h6>
          <div class="d-flex flex-wrap gap-2">
            {% for photo in event.photos.all %}
              {% if not photo.is_cover %}
                <a href="{{ photo.image.url }}" data-lightbox="event-{{ event.id }}" data-title="{{ event.title }}">
                  <img src="{{ photo.image.url }}" class="img-thumbnail" style="max-height:100px; max-width:100px;">
                </a>
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}

      </div>
    </div>
  </div>
</div>
