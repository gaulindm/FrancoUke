{% extends 'base_public_uke4ia.html' %}
{% load board_extras %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/lightbox2@2/dist/css/lightbox.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/lightbox2@2/dist/js/lightbox-plus-jquery.min.js"></script>

<div class="board-container" style="display: flex; gap: 20px; overflow-x: auto; padding-bottom: 20px;">

  {% for column in columns %}
    {% if column.column_type == "venue" %}
      <div class="board-column">
        <h5 class="text-center">{{ column.venue.name }}</h5>
        {% for event in column.sorted_events %}
          {% include "partials/_public_event_card.html" with event=event %}
        {% empty %}
          <p class="text-muted">No events scheduled.</p>
        {% endfor %}
      </div>

    {% elif column.column_type == "songs_to_listen" %}
      <div class="board-column">
        <h5 class="text-center">ðŸŽµ Songs to Listen</h5>
        {% for item in column.public_items %}
          {% include "partials/_board_item_card.html" with item=item %}
        {% empty %}
          <p class="text-muted">No songs added yet.</p>
        {% endfor %}
      </div>

    {% elif column.column_type == "photos" %}
      <div class="board-column">
        <h5 class="text-center">ðŸ“¸ Photo Gallery</h5>
        {% for item in column.public_items %}
          {% include "partials/_board_item_card.html" with item=item %}
        {% empty %}
          <p class="text-muted">No photos yet.</p>
        {% endfor %}
      </div>

    {% else %}
      <div class="board-column">
        <h5 class="text-center">{{ column.name }}</h5>

        {# Events #}
        {% for event in column.sorted_events %}
          {% include "partials/_public_event_card.html" with event=event %}
        {% empty %}
        {% endfor %}

        {# Items #}
        {% for item in column.public_items %}
          {% include "partials/_board_item_card.html" with item=item %}
        {% empty %}
          <p class="text-muted">No items yet.</p>
        {% endfor %}
      </div>
    {% endif %}
  {% endfor %}

</div>

{% include 'partials/_photo_gallery_modal.html' %}

<script>
document.addEventListener('DOMContentLoaded', function () {
  const modal = document.getElementById('photoGalleryModal');
  modal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const itemId = button.getAttribute('data-item-id');
    const itemTitle = button.getAttribute('data-item-title');
    const modalTitle = modal.querySelector('.modal-title');
    const modalBody = document.getElementById('photoGalleryContent');

    modalTitle.textContent = `ðŸ“· ${itemTitle}`;
    modalBody.innerHTML = '<p>Loading photos...</p>';

    fetch(`/board/api/items/${itemId}/photos/`)
      .then(response => response.json())
      .then(data => {
        const photos = Array.isArray(data) ? data : (data.photos || []);
        if (photos.length === 0) {
          modalBody.innerHTML = '<p>No photos found.</p>';
          return;
        }

        const galleryHTML = photos.map(photo => `
          <a href="${photo.url}" data-lightbox="item-${itemId}" data-title="${photo.caption || ''}">
            <img src="${photo.url}" class="img-fluid mb-3" style="max-height: 200px; margin-right: 10px;" />
          </a>
        `).join('');

        modalBody.innerHTML = `<div class="d-flex flex-wrap">${galleryHTML}</div>`;
      })
      .catch(err => {
        modalBody.innerHTML = '<p class="text-danger">Failed to load photos.</p>';
        console.error("Photo gallery error:", err);
      });

  });
});
</script>
{% endblock %}
